<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализатор блогеров (v7.4: исправлен парсинг Excel/Sheets)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SheetJS для Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #4CAF50;
            --secondary: #2196F3;
            --danger: #f44336;
            --warning: #ff9800;
            --light: #f5f5f5;
            --dark: #333;
            --border: #ddd;
            --text-large: 16px;
            --success: #28a745;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: var(--text-large);
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { text-align: center; color: var(--primary); margin-bottom: 10px; font-size: 2.2em; }
        .subtitle { text-align: center; color: var(--secondary); font-size: 14px; margin-bottom: 30px; }
        .section {
            background: white;
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            border-left: 4px solid var(--primary);
        }
        .section:hover { transform: translateY(-2px); }
        .section-header { display: flex; align-items: center; margin-bottom: 15px; }
        .section-header h2 { margin: 0; color: var(--dark); font-size: 1.5em; }
        .section-header i { color: var(--primary); margin-right: 10px; font-size: 1.6em; }
        .hidden { display: none; }
        .toggle-btn { cursor: pointer; color: var(--secondary); font-weight: bold; margin-right: 10px; padding: 5px 10px; background: var(--light); border-radius: 20px; border: 1px solid var(--border); transition: all 0.3s; }
        .toggle-btn:hover { background: var(--secondary); color: white; }
        .add-btn { 
            background: linear-gradient(45deg, var(--primary), #45a049);
            color: white; 
            padding: 10px 15px; 
            border: none; 
            border-radius: 20px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 0 5px;
        }
        .add-btn:hover:not(:disabled) { box-shadow: 0 4px 8px rgba(76,175,80,0.3); transform: scale(1.05); }
        .add-btn:disabled { background: var(--border); cursor: not-allowed; transform: none; opacity: 0.6; }
        .btn-close { background: var(--danger); color: white; padding: 8px 15px; border: none; border-radius: 20px; cursor: pointer; font-size: 14px; margin: 0 5px; transition: all 0.3s; }
        .btn-close:hover { background: #c82333; transform: scale(1.05); }
        input, select, button {
            margin: 5px; 
            padding: 12px; 
            border: 1px solid var(--border); 
            border-radius: 6px; 
            font-size: var(--text-large);
            transition: all 0.3s;
        }
        input:focus, select:focus { outline: none; border-color: var(--secondary); box-shadow: 0 0 5px rgba(33,150,243,0.3); }
        input:invalid, select:invalid { border-color: var(--danger); }
        input:disabled, select:disabled { background: #f8f9fa; cursor: not-allowed; }
        .form-group { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 15px; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        .form-group.full-width { flex-direction: column; align-items: stretch; }
        .form-group label { min-width: 120px; font-weight: 600; color: var(--dark); }
        .form-row { display: flex; flex-wrap: wrap; gap: 15px; align-items: end; }
        .input-group { flex: 1; min-width: 150px; }
        .file-input-wrapper { position: relative; display: inline-block; }
        .file-input { opacity: 0; position: absolute; z-index: -1; }
        .table-container {
            overflow-x: auto; 
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background: white;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 900px; 
            font-size: 14px; 
        }
        th, td { 
            padding: 12px 10px; 
            text-align: left; 
            border-bottom: 1px solid var(--border); 
            vertical-align: top;
        }
        th { 
            background: linear-gradient(45deg, var(--primary), #45a049); 
            color: white; 
            font-weight: 600; 
            position: sticky; top: 0;
            z-index: 10;
            white-space: nowrap; 
            font-size: 13px;
        }
        td { word-wrap: break-word; max-width: 200px; }
        tr:hover { background: var(--light); }
        tr.new-row { animation: highlight 2s ease-out; }
        @keyframes highlight { 0% { background: var(--success); color: white; } 100% { background: var(--light); color: inherit; } }
        .metrics { font-weight: 600; font-size: 15px; }
        .positive { color: var(--primary); }
        .negative { color: var(--danger); }
        .neutral { color: var(--warning); }
        .metrics-group { display: flex; flex-direction: column; gap: 4px; }
        .metric-item { display: flex; justify-content: space-between; padding: 2px 0; font-size: 13px; }
        .metric-label { font-weight: 600; color: var(--dark); min-width: 60px; }
        .form-popup { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 50%; 
            top: 50%; 
            transform: translate(-50%, -50%); 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            min-width: 400px; 
            max-width: 90vw;
            max-height: 85vh;
            overflow-y: auto;
            animation: modalSlide 0.3s ease;
        }
        @keyframes modalSlide { from { opacity: 0; transform: translate(-50%, -60%); } to { opacity: 1; transform: translate(-50%, -50%); } }
        .form-container { display: flex; flex-direction: column; gap: 15px; }
        .form-container input, .form-container select { width: 100%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .modal-title { margin: 0; font-size: 1.4em; color: var(--dark); }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--dark); padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.3s; }
        .close-btn:hover { background: var(--light); }
        .tabs { 
            display: flex; 
            background: var(--light); 
            border-radius: 8px 8px 0 0; 
            overflow: hidden; 
            margin-bottom: 0; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tab-btn { 
            flex: 1; 
            padding: 15px 10px; 
            background: none; 
            border: none; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 14px;
            transition: all 0.3s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .tab-btn.active { 
            background: var(--primary); 
            color: white; 
            box-shadow: inset 0 -2px 0 rgba(0,0,0,0.1);
        }
        .tab-btn:not(.active):hover { background: rgba(33,150,243,0.1); }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .blogger-card, .book-card { 
            background: white;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .blogger-card:hover, .book-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }
        .card-title { font-size: 1.3em; font-weight: 600; color: var(--dark); margin: 0; }
        .card-icon { margin-right: 10px; color: var(--secondary); }
        .card-stats { font-size: 14px; color: var(--dark); text-align: right; }
        .card-stats .metric { display: block; margin: 2px 0; font-weight: 500; }
        .card-details { display: grid; grid-template-columns: 1fr 2fr; gap: 15px; margin-bottom: 15px; font-size: 14px; }
        .detail-label { font-weight: 600; color: var(--dark); }
        .detail-value { word-break: break-word; }
        .card-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        .progress { 
            width: 100%; 
            height: 8px; 
            background: var(--light); 
            border-radius: 4px; 
            overflow: hidden; 
            margin: 15px 0;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        .progress-bar { 
            height: 100%; 
            background: linear-gradient(90deg, var(--primary), var(--secondary)); 
            transition: width 0.3s ease-in-out; 
            width: 0%; 
            border-radius: 4px;
            position: relative;
        }
        .progress-bar::after {
            content: attr(data-label);
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            color: white;
            font-weight: 600;
            text-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        .progress-text { font-size: 14px; color: var(--dark); margin: 5px 0; text-align: center; font-weight: 500; }
        .tooltip { 
            position: relative; 
            display: inline-block; 
            border-bottom: 1px dotted var(--secondary); 
            cursor: help; 
        }
        .tooltip .tooltiptext { 
            visibility: hidden; 
            background: var(--dark); 
            color: white; 
            text-align: left; 
            padding: 10px; 
            border-radius: 6px; 
            position: absolute; 
            z-index: 100; 
            bottom: 125%; 
            left: 50%; 
            margin-left: -100px; 
            opacity: 0; 
            transition: opacity 0.3s;
            white-space: normal;
            width: 200px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            font-size: 13px;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--warning);
        }
        .empty-state i { font-size: 4em; margin-bottom: 20px; opacity: 0.7; }
        .empty-state p { font-size: 1.1em; margin: 10px 0; }
        .empty-state .btn { margin: 10px; padding: 12px 24px; font-size: 15px; }
        .message { 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0; 
            display: flex; 
            align-items: center; 
            gap: 10px;
            animation: slideIn 0.3s ease;
        }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--dark);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 300px;
            z-index: 999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
        }
        .debug-panel.show { display: block; }
        .debug-panel h4 { margin: 0 0 10px 0; color: var(--primary); }
        .debug-item { margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 4px; }
        .debug-item strong { color: var(--secondary); }
        .status-indicator {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .status-ready { background: var(--light); color: var(--success); border: 1px solid var(--success); }
        .status-loading { background: var(--warning); color: white; animation: pulse 1.5s infinite; }
        .status-success { background: var(--success); color: white; }
        .status-error { background: var(--danger); color: white; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .loading { 
            display: inline-block; 
            width: 16px; 
            height: 16px; 
            border: 2px solid var(--light); 
            border-radius: 50%; 
            border-top-color: var(--primary); 
            animation: spin 1s linear infinite; 
            margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 768px) {
            body { font-size: 14px; padding: 10px; }
            .form-group, .form-row { flex-direction: column; align-items: stretch; }
            .form-group label, .input-group { min-width: auto; }
            table { min-width: 700px; font-size: 12px; }
            th, td { padding: 8px 6px; }
            .tabs { flex-direction: column; }
            .tab-btn { border-bottom: 1px solid var(--border); padding: 12px; }
            .card-details { grid-template-columns: 1fr; }
            .card-actions { justify-content: center; flex-wrap: wrap; }
            .form-popup { min-width: 95vw; margin: 10px; transform: none; left: 0; right: 0; top: 0; bottom: 0; border-radius: 0; max-height: none; }
        }
        .demo-data { 
            background: var(--warning); 
            color: white; 
            padding: 10px 15px; 
            border-radius: 6px; 
            margin: 15px 0; 
            text-align: center; 
            font-weight: 500;
        }
        .demo-data button { 
            background: rgba(255,255,255,0.2); 
            color: white; 
            border: 1px solid white; 
            padding: 8px 16px; 
            border-radius: 20px; 
            cursor: pointer; 
            margin: 0 5px;
        }
        .demo-data button:hover { background: white; color: var(--warning); }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-chart-line"></i> Анализатор блогеров (v7.4)</h1>
        <p class="subtitle">
            <i class="fas fa-cogs"></i> Исправлен парсинг Excel и Google Sheets | Пароль сброса: <code>admin</code>
        </p>

        <!-- Debug панель -->
        <div class="debug-panel" id="debugPanel">
            <h4><i class="fas fa-bug"></i> Debug Info</h4>
            <div id="debugContent"></div>
            <button onclick="toggleDebug()" style="width: 100%; margin-top: 10px; padding: 8px; background: var(--secondary); color: white; border: none; border-radius: 4px; cursor: pointer;">
                <i class="fas fa-times"></i> Скрыть
            </button>
        </div>

        <!-- Счетчики -->
        <div style="display: flex; justify-content: space-around; background: var(--light); padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;">
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: var(--primary);" id="bloggerCount">0</div>
                <div>Блогеров</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: var(--secondary);" id="bookCount">0</div>
                <div>Книг</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: var(--success);" id="campaignCount">0</div>
                <div>Кампаний</div>
            </div>
            <div style="text-align: center;">
                <i class="fas fa-download" onclick="exportData()" style="font-size: 24px; color: var(--warning); cursor: pointer;" title="Экспорт в Excel"></i>
                <div style="font-size: 12px;">Экспорт</div>
            </div>
        </div>

        <!-- Вкладки -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="load" onclick="switchTab('load')">
                <i class="fas fa-upload"></i> Загрузка
            </button>
            <button class="tab-btn" data-tab="bloggers" onclick="switchTab('bloggers')">
                <i class="fas fa-users"></i> Блогеры
            </button>
            <button class="tab-btn" data-tab="books" onclick="switchTab('books')">
                <i class="fas fa-book"></i> Книги
            </button>
            <button class="tab-btn" data-tab="campaigns" onclick="switchTab('campaigns')">
                <i class="fas fa-plus"></i> Добавить
            </button>
            <button class="tab-btn" data-tab="data" onclick="switchTab('data')">
                <i class="fas fa-table"></i> Данные
            </button>
            <button class="tab-btn" data-tab="analysis" onclick="switchTab('analysis')">
                <i class="fas fa-chart-bar"></i> Анализ
            </button>
        </div>

        <!-- Вкладка загрузки -->
        <div id="load" class="section tab-content active">
            <div class="section-header">
                <h2><i class="fas fa-upload"></i> Загрузка данных</h2>
                <button class="toggle-btn" onclick="toggleDebug()">Debug</button>
            </div>

            <!-- Google Sheets -->
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: var(--secondary);"><i class="fas fa-file-csv"></i> Google Sheets (CSV)</h3>
                <div class="form-group">
                    <label>Ссылка на опубликованную таблицу:</label>
                    <input type="url" id="csvUrl" placeholder="https://docs.google.com/spreadsheets/d/ABC123.../pub?output=csv" style="flex: 1; min-width: 400px;" 
                           value="https://docs.google.com/spreadsheets/d/e/2PACX-1v.../pub?output=csv">
                    <span class="status-indicator status-ready" id="sheetsStatus"><i class="fas fa-check"></i> Готов</span>
                </div>
                <p style="font-size: 13px; color: var(--dark); margin: 5px 0 0 0;">
                    <i class="fas fa-info-circle"></i> Таблица должна быть <strong>опубликована публично</strong> через "Файл → Опубликовать в Интернете → Вся таблица → CSV"
                </p>
                <button class="add-btn" onclick="loadFromSheets()" id="loadSheetsBtn">
                    <i class="fas fa-file-csv"></i> Загрузить CSV
                </button>
                <div class="progress" id="sheetsProgress" style="display: none; margin-top: 10px;">
                    <div class="progress-bar" id="sheetsProgressBar"></div>
                    <div class="progress-text" id="sheetsProgressText">Подготовка...</div>
                </div>
                <div id="sheetsMessage"></div>
            </div>

            <!-- Excel -->
            <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: var(--secondary);"><i class="fas fa-file-excel"></i> Excel файл (.xlsx, .xls)</h3>
                <div class="form-row">
                    <div class="input-group">
                        <label>Выберите файл Excel:</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleExcelFile(event)" class="file-input">
                            <button type="button" class="add-btn" onclick="document.getElementById('excelFile').click()">
                                <i class="fas fa-file-excel"></i> Выбрать файл
                            </button>
                        </div>
                        <div id="fileInfo" style="margin-top: 5px; font-size: 13px; color: var(--secondary);"></div>
                    </div>
                    <span class="status-indicator status-ready" id="excelStatus"><i class="fas fa-check"></i> Готов</span>
                </div>
                <p style="font-size: 13px; color: var(--dark); margin: 5px 0 0 0;">
                    <i class="fas fa-info-circle"></i> Поддерживаются файлы до 10MB. Автоматическое определение колонок.
                </p>
                <div class="progress" id="excelProgress" style="display: none; margin-top: 10px;">
                    <div class="progress-bar" id="excelProgressBar"></div>
                    <div class="progress-text" id="excelProgressText">Подготовка...</div>
                </div>
                <div id="excelMessage"></div>
            </div>

            <!-- CSV загрузка (локальный файл) -->
            <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: var(--success);"><i class="fas fa-file-csv"></i> CSV файл (локальный)</h3>
                <div class="form-row">
                    <div class="input-group">
                        <label>Загрузить CSV файл:</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="csvFile" accept=".csv,.txt" onchange="handleCsvFile(event)" class="file-input">
                            <button type="button" class="add-btn" onclick="document.getElementById('csvFile').click()" style="background: var(--success);">
                                <i class="fas fa-file-csv"></i> Загрузить CSV
                            </button>
                        </div>
                        <div id="csvFileInfo" style="margin-top: 5px; font-size: 13px; color: var(--success);"></div>
                    </div>
                    <span class="status-indicator status-ready" id="csvStatus"><i class="fas fa-check"></i> Готов</span>
                </div>
                <p style="font-size: 13px; color: var(--dark); margin: 5px 0 0 0;">
                    <i class="fas fa-info-circle"></i> Простой способ обойти CORS. Скачайте CSV из Google Sheets и загрузите здесь.
                </p>
                <div class="progress" id="csvProgress" style="display: none; margin-top: 10px;">
                    <div class="progress-bar" id="csvProgressBar"></div>
                    <div class="progress-text" id="csvProgressText">Подготовка...</div>
                </div>
                <div id="csvMessage"></div>
            </div>

            <!-- Demo данные -->
            <div class="demo-data">
                <h3 style="margin: 0 0 10px 0; color: white;"><i class="fas fa-play"></i> Быстрый тест</h3>
                <p style="margin: 0 0 15px 0; font-size: 14px; color: rgba(255,255,255,0.9);">Загрузить демо-данные для тестирования всех функций</p>
                <button onclick="loadDemoData()">🚀 Загрузить демо (10 кампаний)</button>
                <button onclick="loadFullDemo()">📊 Полный демо (50+ записей)</button>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 10px;">Автоматически создаст блогеров, книги и кампании</div>
            </div>

            <!-- Формат данных -->
            <details style="margin-top: 20px;">
                <summary style="cursor: pointer; padding: 10px; background: var(--light); border-radius: 6px; font-weight: 600;">
                    <i class="fas fa-info-circle"></i> 📋 Требуемый формат данных
                </summary>
                <div style="padding: 15px; background: #f8f9fa; border-radius: 6px; margin-top: 10px;">
                    <h4 style="margin-top: 0; color: var(--primary);">Обязательные колонки:</h4>
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <tr><th style="border: 1px solid var(--border); padding: 8px; background: var(--primary); color: white;">Колонка</th><th style="border: 1px solid var(--border); padding: 8px;">Пример</th><th style="border: 1px solid var(--border); padding: 8px;">Описание</th></tr>
                        <tr><td style="border: 1px solid var(--border); padding: 8px; font-weight: bold;">Дата</td><td style="border: 1px solid var(--border); padding: 8px;">2025-01-15</td><td style="border: 1px solid var(--border); padding: 8px;">Формат YYYY-MM-DD</td></tr>
                        <tr><td style="border: 1px solid var(--border); padding: 8px; font-weight: bold;">Блогер</td><td style="border: 1px solid var(--border); padding: 8px;">logoped.arshinova</td><td style="border: 1px solid var(--border); padding: 8px;">Имя или ник блогера</td></tr>
                        <tr><td style="border: 1px solid var(--border); padding: 8px; font-weight: bold;">Книга</td><td style="border: 1px solid var(--border); padding: 8px;">Логопедия для детей</td><td style="border: 1px solid var(--border); padding: 8px;">Название книги</td></tr>
                        <tr><td style="border: 1px solid var(--border); padding: 8px; font-weight: bold;">Стоимость</td><td style="border: 1px solid var(--border); padding: 8px;">1500</td><td style="border: 1px solid var(--border); padding: 8px;">Затраты в рублях</td></tr>
                        <tr><td style="border: 1px solid var(--border); padding: 8px; font-weight: bold;">ЧП с книги</td><td style="border: 1px solid var(--border); padding: 8px;">300</td><td style="border: 1px solid var(--border); padding: 8px;">Чистая прибыль с 1 книги</td></tr>
                        <tr><td style="border: 1px solid var(--border); padding: 8px; font-weight: bold;">Количество</td><td style="border: 1px solid var(--border); padding: 8px;">10</td><td style="border: 1px solid var(--border); padding: 8px;">Проданных книг</td></tr>
                    </table>
                    <p style="margin-top: 15px; font-size: 13px; color: var(--dark);">
                        <i class="fas fa-lightbulb"></i> Колонки могут называться по-разному (например, "Cost" или "Стоимость", "Date" или "Дата"). 
                        Система автоматически определит соответствие. 
                        <strong>Первые 2 строки заголовков, остальные — данные.</strong>
                    </p>
                </div>
            </details>
        </div>

        <!-- Остальные вкладки (как в v7.3) -->
        <div id="bloggers" class="section tab-content">
            <div class="section-header">
                <h2><i class="fas fa-users"></i> Справочник блогеров</h2>
                <div style="display: flex; gap: 10px;">
                    <span class="toggle-btn" onclick="toggleSection('bloggersList')"><i class="fas fa-eye-slash"></i> Скрыть</span>
                    <button class="add-btn" onclick="showAddBlogger()"><i class="fas fa-user-plus"></i> Добавить</button>
                    <button class="btn-close" onclick="deleteAllBloggers()" style="padding: 10px 12px;"><i class="fas fa-trash"></i> Удалить всех</button>
                </div>
            </div>
            <div id="bloggersList"></div>
        </div>

        <div id="books" class="section tab-content">
            <div class="section-header">
                <h2><i class="fas fa-book"></i> Справочник книг</h2>
                <div style="display: flex; gap: 10px;">
                    <span class="toggle-btn" onclick="toggleSection('booksList')"><i class="fas fa-eye-slash"></i> Скрыть</span>
                    <button class="add-btn" onclick="showAddBook()"><i class="fas fa-book-open"></i> Добавить</button>
                            <button class="btn-close" onclick="deleteAllBooks()" style="padding: 10px 12px;">
            <i class="fas fa-trash"></i> Удалить всех
        </button>
    </div>
    <div id="booksList">
        <!-- Содержимое будет динамически -->
    </div>
</div>

<!-- Добавление кампаний -->
<div id="campaigns" class="section tab-content">
    <div class="section-header">
        <h2><i class="fas fa-plus-circle"></i> Новая кампания</h2>
        <div>
            <button class="add-btn" onclick="addCampaign()">
                <i class="fas fa-save"></i> Сохранить кампанию
            </button>
            <button class="btn-close" onclick="clearCampaignForm()">
                <i class="fas fa-eraser"></i> Очистить
            </button>
        </div>
    </div>
    
    <div class="form-row">
        <div class="input-group">
            <label>Дата <span class="required">*</span>:</label>
            <input type="date" id="campaignDate" required>
        </div>
        <div class="input-group">
            <label>Блогер <span class="required">*</span>:</label>
            <select id="campaignBlogger" required>
                <option value="">Выберите блогера</option>
            </select>
        </div>
        <div class="input-group">
            <label>Книга <span class="required">*</span>:</label>
            <select id="campaignBook" required>
                <option value="">Выберите книгу</option>
            </select>
        </div>
    </div>
    
    <div class="form-row">
        <div class="input-group">
            <label>Стоимость, руб. <span class="required">*</span>:</label>
            <input type="number" id="campaignCost" min="0" step="0.01" required placeholder="0.00">
        </div>
        <div class="input-group">
            <label>ЧП с книги, руб. <span class="required">*</span>:</label>
            <input type="number" id="campaignCP" min="0" step="0.01" required placeholder="0.00">
        </div>
        <div class="input-group">
            <label>Количество <span class="required">*</span>:</label>
            <input type="number" id="campaignQty" min="1" required placeholder="1">
        </div>
    </div>
    
    <div class="preview-section" id="campaignPreview" style="display: none; margin-top: 15px; padding: 15px; background: var(--light); border-radius: 8px;">
        <h4 style="margin-top: 0; color: var(--secondary);">Предпросмотр:</h4>
        <div id="previewMetrics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 14px;"></div>
    </div>
</div>

<!-- Данные -->
<div id="data" class="section tab-content">
    <div class="section-header">
        <h2><i class="fas fa-table"></i> Кампании</h2>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button class="add-btn" onclick="updateList()">
                <i class="fas fa-sync-alt"></i> Обновить
            </button>
            <button class="add-btn" onclick="applyFilters()">
                <i class="fas fa-filter"></i> Фильтры
            </button>
            <button class="btn-close" onclick="clearFilters()">
                <i class="fas fa-eraser"></i> Сбросить
            </button>
            <span id="recordsCount" style="font-size: 14px; color: var(--dark);"></span>
        </div>
    </div>
    
    <!-- Фильтры -->
    <div class="filters-panel" id="filtersPanel" style="background: var(--light); padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
        <div class="form-row">
            <div class="input-group">
                <label>Дата от:</label>
                <input type="date" id="filterDateFrom">
            </div>
            <div class="input-group">
                <label>Дата до:</label>
                <input type="date" id="filterDateTo">
            </div>
            <div class="input-group">
                <label>Блогер:</label>
                <select id="filterBlogger">
                    <option value="">Все</option>
                </select>
            </div>
            <div class="input-group">
                <label>Книга:</label>
                <select id="filterBook">
                    <option value="">Все</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="input-group">
                <label>ROI от (%):</label>
                <input type="number" id="filterROIFrom" step="1" min="-100">
            </div>
            <div class="input-group">
                <label>ROI до (%):</label>
                <input type="number" id="filterROITo" step="1">
            </div>
            <div class="input-group">
                <label>ROAS от:</label>
                <input type="number" id="filterROASFrom" step="0.1" min="0">
            </div>
            <div class="input-group">
                <label>ROAS до:</label>
                <input type="number" id="filterROASTo" step="0.1">
            </div>
        </div>
        <div class="form-row">
            <div class="input-group">
                <label>CPS от (руб.):</label>
                <input type="number" id="filterCPSFrom" step="0.01" min="0">
            </div>
            <div class="input-group">
                <label>CPS до (руб.):</label>
                <input type="number" id="filterCPSTo" step="0.01">
            </div>
            <div class="input-group" style="justify-self: end;">
                <button class="add-btn" onclick="applyFilters()" style="margin-top: 22px;">
                    <i class="fas fa-search"></i> Применить
                </button>
                <button class="btn-close" onclick="clearFilters()" style="margin-top: 22px;">
                    <i class="fas fa-times"></i> Сбросить
                </button>
            </div>
        </div>
    </div>
    
    <button class="add-btn" onclick="toggleFilters()" id="toggleFiltersBtn" style="margin-bottom: 15px;">
        <i class="fas fa-filter"></i> Показать фильтры
    </button>
    
    <div class="table-container">
        <div id="dataTableContainer">
            <div class="empty-state">
                <i class="fas fa-table" style="font-size: 4em; color: var(--warning); margin-bottom: 20px;"></i>
                <h3>Нет данных для отображения</h3>
                <p style="margin-bottom: 20px;">Загрузите Excel, CSV файл или добавьте кампанию вручную</p>
                <div>
                    <button class="add-btn" onclick="switchTab('load')" style="margin-right: 10px;">
                        <i class="fas fa-upload"></i> Загрузить данные
                    </button>
                    <button class="add-btn" onclick="switchTab('campaigns')" style="background: var(--secondary);">
                        <i class="fas fa-plus"></i> Добавить кампанию
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Анализ -->
<div id="analysis" class="section tab-content">
    <div class="section-header">
        <h2><i class="fas fa-chart-bar"></i> Анализ эффективности</h2>
        <div>
            <button class="add-btn" onclick="analyzeTop()" id="analyzeBtn">
                <i class="fas fa-magic"></i> Проанализировать
            </button>
            <button class="add-btn" onclick="exportData()" style="background: var(--secondary); margin-left: 10px;">
                <i class="fas fa-download"></i> Экспорт Excel
            </button>
        </div>
    </div>
    
    <div id="analysisResults">
        <div class="empty-state">
            <i class="fas fa-chart-line" style="font-size: 4em; color: var(--secondary); margin-bottom: 20px;"></i>
            <h3>Анализ доступен после загрузки данных</h3>
            <p>Загрузите кампании для расчета ROI, ROAS и построения топа блогеров</p>
            <button class="add-btn" onclick="switchTab('load')">
                <i class="fas fa-upload"></i> Загрузить данные
            </button>
        </div>
    </div>
    
    <!-- Шпаргалка -->
    <details style="margin-top: 30px; background: var(--light); padding: 15px; border-radius: 8px;">
        <summary style="cursor: pointer; font-weight: 600; color: var(--dark); padding: 10px; border-bottom: 1px solid var(--border);">
            <i class="fas fa-info-circle" style="margin-right: 8px;"></i> 📋 Ключевые метрики
        </summary>
        <div style="padding-top: 15px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 15px;">
                <div>
                    <h4 style="margin: 0 0 10px 0; color: var(--primary);"><i class="fas fa-percentage"></i> ROI (рентабельность)</h4>
                    <p><code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-size: 13px;">(Прибыль - Затраты) / Затраты × 100%</code></p>
                    <ul style="margin: 10px 0; padding-left: 20px; font-size: 14px;">
                        <li class="positive">>100% — <strong>Отлично!</strong> Прибыль в 2+ раза превышает затраты</li>
                        <li class="neutral">10-100% — <strong>Хорошо</strong> Прибыль покрывает затраты</li>
                        <li class="negative"><0% — <strong>Убыток</strong> Затраты превышают прибыль</li>
                    </ul>
                    <p class="tooltip"><strong>Пример:</strong> Затраты 1000 руб., Прибыль 3000 руб. → ROI = (3000-1000)/1000 × 100% = <strong>200%</strong> <span class="tooltiptext">Отличный результат!</span></p>
                </div>
                
                <div>
                    <h4 style="margin: 0 0 10px 0; color: var(--secondary);"><i class="fas fa-calculator"></i> ROAS (окупаемость)</h4>
                    <p><code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-size: 13px;">Прибыль / Затраты</code></p>
                    <ul style="margin: 10px 0; padding-left: 20px; font-size: 14px;">
                        <li class="positive">>3.0 — <strong>Супер!</strong> Каждый рубль приносит 3+ рубля прибыли</li>
                        <li class="neutral">1.5-3.0 — <strong>Хорошо</strong> Прибыль покрывает затраты + маржа</li>
                        <li class="negative"><1.0 — <strong>Убыток</strong> Затраты превышают доход</li>
                    </ul>
                    <p class="tooltip"><strong>Пример:</strong> Затраты 1000 руб., Прибыль 3000 руб. → ROAS = 3000/1000 = <strong>3.0</strong> <span class="tooltiptext">Отличная отдача!</span></p>
                </div>
                
                <div>
                    <h4 style="margin: 0 0 10px 0; color: var(--warning);"><i class="fas fa-coins"></i> CPS (стоимость привлечения)</h4>
                    <p><code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-size: 13px;">Затраты / Количество проданных книг</code></p>
                    <ul style="margin: 10px 0; padding-left: 20px; font-size: 14px;">
                        <li class="positive">CPS < ЧП — <strong>Выгодно!</strong> Каждая продажа приносит прибыль</li>
                        <li class="neutral">CPS = ЧП — <strong>Нулевая прибыль</strong> Покрытие затрат без маржи</li>
                        <li class="negative">CPS > ЧП — <strong>Убыточно</strong> Каждая продажа в минусе</li>
                    </ul>
                    <p class="tooltip"><strong>Пример:</strong> Затраты 1000 руб., Продано 10 книг, ЧП 150 руб. → CPS = 1000/10 = <strong>100 руб.</strong> <span class="tooltiptext">Выгодно! (100 < 150)</span></p>
                </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid var(--warning);">
                <h4 style="margin: 0 0 10px 0; color: var(--warning);"><i class="fas fa-star"></i> Рекомендации по интерпретации</h4>
                <ul style="margin: 10px 0; padding-left: 20px; font-size: 14px; line-height: 1.6;">
                    <li><strong>ROI > 200%</strong> или <strong>ROAS > 3</strong> — блогер работает отлично, увеличивайте бюджет</li>
                    <li><strong>ROI 50-200%</strong> — хороший результат, продолжайте сотрудничество</li>
                    <li><strong>ROI < 50%</strong> — низкая эффективность, пересмотрите условия или смените блогера</li>
                    <li><strong>CPS всегда должно быть меньше ЧП</strong> — иначе каждая продажа убыточна</li>
                </ul>
                <p style="margin-top: 15px; font-style: italic; color: var(--dark);">
                    <strong>Пример успеха:</strong> ROI = 1869%, ROAS = 19.69 (logoped.arshinova) — каждая потраченная 1 рубль принесла 19.69 руб. чистой прибыли!
                </p>
            </div>
        </div>
    </details>
</div>

<!-- Модальные окна -->
<div id="addBloggerModal" class="form-popup">
    <div class="form-container">
        <div class="modal-header">
            <h3 id="bloggerModalTitle" class="modal-title"><i class="fas fa-user-plus"></i> Добавить блогера</h3>
            <button class="close-btn" onclick="hideAddBloggerModal()">&times;</button>
        </div>
        <div class="form-group full-width">
            <label>Имя блогера <span class="required">*</span>:</label>
            <input type="text" id="bloggerName" placeholder="Например: logoped.arshinova" maxlength="100" required>
            <small style="color: var(--dark); font-size: 12px;">Максимум 100 символов. Можно использовать ник или имя</small>
        </div>
        <div class="form-group full-width">
            <label>Ссылка (опционально):</label>
            <input type="url" id="bloggerLink" placeholder="https://t.me/username или https://instagram.com/username">
            <small style="color: var(--dark); font-size: 12px;">Ссылка на профиль Telegram, Instagram или другой канал</small>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button class="add-btn" id="saveBloggerBtn" onclick="saveBlogger()">
                <i class="fas fa-check"></i> Добавить блогера
            </button>
            <button class="btn-close" onclick="hideAddBloggerModal()">
                <i class="fas fa-times"></i> Отмена
            </button>
        </div>
    </div>
</div>

<div id="addBookModal" class="form-popup">
    <div class="form-container">
        <div class="modal-header">
            <h3 id="bookModalTitle" class="modal-title"><i class="fas fa-book-open"></i> Добавить книгу</h3>
            <button class="close-btn" onclick="hideAddBookModal()">&times;</button>
        </div>
        <div class="form-group full-width">
            <label>Название книги <span class="required">*</span>:</label>
            <input type="text" id="bookName" placeholder="Например: Логопедия для детей" maxlength="150" required>
            <small style="color: var(--dark); font-size: 12px;">Полное название книги (до 150 символов)</small>
        </div>
        <div class="form-group full-width">
            <label>ЧП с книги, руб. <span class="required">*</span>:</label>
            <input type="number" id="bookCP" min="0" step="0.01" placeholder="0.00" required>
            <small style="color: var(--dark); font-size: 12px;">Чистая прибыль с одной книги после всех расходов</small>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button class="add-btn" id="saveBookBtn" onclick="saveBook()">
                <i class="fas fa-check"></i> Добавить книгу
            </button>
            <button class="btn-close" onclick="hideAddBookModal()">
                <i class="fas fa-times"></i> Отмена
            </button>
        </div>
    </div>
</div>

<div id="editCampaignModal" class="form-popup">
    <div class="form-container">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-edit"></i> Редактировать кампанию</h3>
            <button class="close-btn" onclick="hideEditCampaignModal()">&times;</button>
        </div>
        <div class="form-row">
            <div class="input-group">
                <label>Дата <span class="required">*</span>:</label>
                <input type="date" id="editDate" required>
            </div>
            <div class="input-group">
                <label>Блогер <span class="required">*</span>:</label>
                <select id="editBlogger" required></select>
            </div>
            <div class="input-group">
                <label>Книга <span class="required">*</span>:</label>
                <select id="editBook" required></select>
            </div>
        </div>
        <div class="form-row">
            <div class="input-group">
                <label>Стоимость, руб. <span class="required">*</span>:</label>
                <input type="number" id="editCost" min="0" step="0.01" required placeholder="0.00">
            </div>
            <div class="input-group">
                <label>ЧП с книги, руб. <span class="required">*</span>:</label>
                <input type="number" id="editCP" min="0" step="0.01" required placeholder="0.00">
            </div>
            <div class="input-group">
                <label>Количество <span class="required">*</span>:</label>
                <input type="number" id="editQty" min="1" required placeholder="1">
            </div>
        </div>
        <div id="editPreview" style="margin-top: 15px; padding: 15px; background: var(--light); border-radius: 8px; display: none;"></div>
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button class="add-btn" id="saveCampaignEditBtn" onclick="saveCampaignEdit()">
                <i class="fas fa-save"></i> Сохранить изменения
            </button>
            <button class="btn-close" onclick="hideEditCampaignModal()">
                <i class="fas fa-times"></i> Отмена
            </button>
        </div>
    </div>
</div>

<div id="resetModal" class="form-popup">
    <div class="form-container">
        <div class="modal-header">
            <h3 class="modal-title" style="color: var(--danger);"><i class="fas fa-exclamation-triangle"></i> Полный сброс</h3>
            <button class="close-btn" onclick="hideResetModal()">&times;</button>
        </div>
        <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h4 style="margin-top: 0; color: var(--danger);">⚠️ ВНИМАНИЕ: НЕОБРАТИМОЕ ДЕЙСТВИЕ</h4>
            <ul style="margin: 15px 0; padding-left: 20px;">
                <li><strong>🗑️ Удалит всех блогеров ({{bloggers.length}})</strong></li>
                <li><strong>📚 Удалит все книги ({{books.length}})</strong></li>
                <li><strong>📊 Удалит все кампании ({{campaigns.length}})</strong></li>
                <li><strong>💾 Очистит localStorage полностью</strong></li>
            </ul>
            <p style="margin-top: 15px; font-weight: 600;">После сброса данные восстановить невозможно!</p>
        </div>
        <div class="form-group full-width">
            <label>Пароль администратора <span class="required">*</span>:</label>
            <input type="password" id="resetPassword" placeholder="Введите пароль" maxlength="20" required>
            <small style="color: var(--warning);">Пароль: <code>admin</code> (для безопасности измените в коде)</small>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button class="btn-close" id="confirmResetBtn" onclick="confirmReset()" disabled style="padding: 12px 20px;">
                <i class="fas fa-bomb"></i> Подтвердить сброс
            </button>
            <button class="add-btn" onclick="hideResetModal()">
                <i class="fas fa-times"></i> Отмена
            </button>
        </div>
    </div>
</div>

<!-- Конец HTML -->
</div>

<script>
// ==================== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ====================
let bloggers = JSON.parse(localStorage.getItem('bloggers') || '[]');
let books = JSON.parse(localStorage.getItem('books') || '[]');
let campaigns = JSON.parse(localStorage.getItem('campaigns') || '[]');
let dataLoaded = false;
let currentEditIndex = -1;
let editingType = null; // 'blogger', 'book', 'campaign'

// Демо данные для тестирования
const demoData = {
    bloggers: [
        { name: 'logoped.arshinova', link: 'https://t.me/logoped_arshinova' },
        { name: 'defectologist_kids', link: 'https://instagram.com/defectologist_kids' },
        { name: 'speech_therapy_pro', link: '' },
        { name: 'pedagog_anna', link: 'https://t.me/pedagog_anna' },
        { name: 'logoped_maria', link: '' }
    ],
    books: [
        { name: 'Логопедия для детей', cp: 350 },
        { name: 'Коррекция речи', cp: 420 },
        { name: 'Развитие речи', cp: 280 },
        { name: 'Артикуляционная гимнастика', cp: 180 },
        { name: 'Уроки логопеда', cp: 320 }
    ],
    campaigns: [
        { date: '2025-01-15', blogger: 'logoped.arshinova', book: 'Логопедия для детей', cost: 1500, cp: 350, qty: 12 },
        { date: '2025-01-12', blogger: 'defectologist_kids', book: 'Коррекция речи', cost: 2200, cp: 420, qty: 8 },
        { date: '2025-01-10', blogger: 'speech_therapy_pro', book: 'Развитие речи', cost: 800, cp: 280, qty: 15 },
        { date: '2025-01-08', blogger: 'pedagog_anna', book: 'Артикуляционная гимнастика', cost: 1200, cp: 180, qty: 20 },
        { date: '2025-01-05', blogger: 'logoped_maria', book: 'Уроки логопеда', cost: 900, cp: 320, qty: 6 }
    ]
};

// ==================== ИНИЦИАЛИЗАЦИЯ ====================
function initApp() {
    console.log('🚀 Инициализация v7.4 - исправленный парсинг');
    
    // Проверяем библиотеки
    console.log('📚 SheetJS:', typeof XLSX !== 'undefined' ? '✓ Загружен' : '✗ Отсутствует');
    console.log('💾 localStorage: доступен');
    console.log('📊 Данные: блогеров=' + bloggers.length + ', книг=' + books.length + ', кампаний=' + campaigns.length);
    
    // Проверяем DOM
    const required = ['csvUrl', 'excelFile', 'csvFile', 'bloggersList', 'booksList', 'dataTableContainer', 'analysisResults'];
    let allReady = true;
    
    required.forEach(function(id) {
        if (!document.getElementById(id)) {
            console.error('❌ Элемент не найден:', id);
            allReady = false;
        }
    });
    
    if (!allReady) {
        setTimeout(initApp, 500);
        return;
    }
    
    // Инициализируем
    setupDateInputs();
    populateSelects();
    renderBloggers();
    renderBooks();
    updateList();
    updateCounters();
    updateResetModal();
    
    // Устанавливаем сегодня по умолчанию
    document.getElementById('campaignDate').valueAsDate = new Date();
    
    // Активируем вкладку
    switchTab('load');
    
    // Проверяем демо-данные
    if (campaigns.length === 0 && !localStorage.getItem('demoShown')) {
        showWelcomeMessage();
    }
    
    console.log('✅ Инициализация завершена');
}

// ==================== НАСТРОЙКА ====================
function setupDateInputs() {
    const dateInputs = document.querySelectorAll('input[type="date"]');
    dateInputs.forEach(function(input) {
        input.addEventListener('change', function() {
            updateCampaignPreview();
        });
    });
    
    // Фильтры дат
    const filterDates = ['filterDateFrom', 'filterDateTo'];
    filterDates.forEach(function(id) {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('change', function() {
                if (id === 'filterDateFrom' && this.value) {
                    document.getElementById('filterDateTo').min = this.value;
                } else if (id === 'filterDateTo' && this.value) {
                    document.getElementById('filterDateFrom').max = this.value;
                }
            });
        }
    });
}

function updateCampaignPreview() {
    const date = document.getElementById('campaignDate').value;
    const blogger = document.getElementById('campaignBlogger').value;
    const book = document.getElementById('campaignBook').value;
    const cost = parseFloat(document.getElementById('campaignCost').value) || 0;
    const cp = parseFloat(document.getElementById('campaignCP').value) || 0;
    const qty = parseInt(document.getElementById('campaignQty').value) || 0;
    
    const preview = document.getElementById('campaignPreview');
    const metrics = document.getElementById('previewMetrics');
    
    if (!date || !blogger || !book || cost <= 0 || cp <= 0 || qty <= 0) {
        preview.style.display = 'none';
        return;
    }
    
    const revenue = cp * qty;
    const profit = revenue - cost;
    const roi = cost > 0 ? (profit / cost * 100).toFixed(1) : 0;
    const roas = cost > 0 ? (revenue / cost).toFixed(2) : 0;
    const cps = qty > 0 ? (cost / qty).toFixed(2) : 0;
    
    const roiClass = roi > 100 ? 'positive' : roi > 0 ? 'neutral' : 'negative';
    
    metrics.innerHTML = `
        <div class="metric-item">
            <span class="metric-label">Выручка:</span>
            <span class="positive">${revenue.toFixed(0)} руб.</span>
        </div>
        <div class="metric-item">
            <span class="metric-label">Прибыль:</span>
            <span class="${profit > 0 ? 'positive' : 'negative'}">${profit > 0 ? '+' : ''}${profit.toFixed(0)} руб.</span>
        </div>
        <div class="metric-item">
            <span class="metric-label">ROI:</span>
            <span class="${roiClass}">${roi > 0 ? '+' : ''}${roi}%</span>
        </div>
        <div class="metric-item">
            <span class="metric-label">ROAS:</span>
            <span class="positive">${roas}x</span>
        </div>
        <div class="metric-item">
            <span class="metric-label">CPS:</span>
            <span>${cps} руб./шт.</span>
        </div>
        <div style="margin-top: 10px; padding: 10px; background: ${roi > 100 ? '#d4edda' : roi > 0 ? '#fff3cd' : '#f8d7da'}; border-radius: 6px; font-size: 13px;">
            ${roi > 100 ? '✅ Отличная кампания! ROI ' + roi + '%' : roi > 0 ? '⚠️ Хороший результат. ROI ' + roi + '%' : '❌ Убыточная кампания. ROI ' + roi + '%'}
        </div>
    `;
    
    preview.style.display = 'block';
}

// ==================== ПЕРЕКЛЮЧЕНИЕ ВКЛАДОК ====================
function switchTab(tabId) {
    console.log('Переключение вкладки:', tabId);
    
    // Скрываем все вкладки
    const tabs = document.querySelectorAll('.tab-content');
    tabs.forEach(function(tab) {
        tab.classList.remove('active');
    });
    
    // Деактивируем кнопки
    const buttons = document.querySelectorAll('.tab-btn');
    buttons.forEach(function(btn) {
        btn.classList.remove('active');
    });
    
    // Активируем новую
    const activeTab = document.getElementById(tabId);
    if (activeTab) {
        activeTab.classList.add('active');
    }
    
    const activeButton = document.querySelector(`[data-tab="${tabId}"]`);
    if (activeButton) {
        activeButton.classList.add('active');
    }
    
    // Специальная логика
    if (tabId === 'data') {
        updateList();
    } else if (tabId === 'analysis' && campaigns.length > 0) {
        analyzeTop();
    } else if (tabId === 'campaigns') {
        populateSelects();
        document.getElementById('campaignDate').valueAsDate = new Date();
        updateCampaignPreview();
    }
    
    // Сохраняем активную вкладку
    localStorage.setItem('activeTab', tabId);
    
    console.log('✓ Вкладка', tabId, 'активирована');
}

// ==================== ЗАГРУЗКА GOOGLE SHEETS ====================
function loadFromSheets() {
    console.log('Загрузка Google Sheets...');
    
    const urlInput = document.getElementById('csvUrl');
    const btn = document.getElementById('loadSheetsBtn');
    const progress = document.getElementById('sheetsProgress');
    const progressBar = document.getElementById('sheetsProgressBar');
    const progressText = document.getElementById('sheetsProgressText');
    const message = document.getElementById('sheetsMessage');
    const status = document.getElementById('sheetsStatus');
    
    if (!urlInput || !btn || !progress || !progressBar || !progressText || !message || !status) {
        console.error('Элементы интерфейса не найдены');
        return;
    }
    
    const url = urlInput.value.trim();
    if (!url) {
        showMessage('Введите ссылку на Google Sheets', 'error', 'sheetsMessage');
        return;
    }
    
    // Проверяем формат ссылки
    if (!url.includes('docs.google.com/spreadsheets')) {
        showMessage('Неверный формат ссылки. Используйте Google Sheets', 'error', 'sheetsMessage');
        return;
    }
    
    // Формируем CSV URL
    let csvUrl;
    try {
        // Убираем /edit если есть
        let cleanUrl = url.replace(/\/edit.*$/, '');
        // Добавляем /pub?output=csv если нет
        if (!cleanUrl.includes('/pub?output=csv')) {
            cleanUrl += '/pub?output=csv';
        }
        csvUrl = cleanUrl;
    } catch (e) {
        console.error('Ошибка формирования URL:', e);
        showMessage('Ошибка формата ссылки', 'error', 'sheetsMessage');
        return;
    }
    
    console.log('CSV URL:', csvUrl);
    
    // Показываем загрузку
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Загрузка...';
    progress.style.display = 'block';
    status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Загрузка';
    status.className = 'status-indicator status-loading';
    message.innerHTML = '';
    
    progressBar.style.width = '10%';
    progressText.textContent = 'Подключение к Google...';
    
    // Пробуем несколько методов загрузки (fallback)
    loadSheetsWithFallback(csvUrl, 0);
}

function loadSheetsWithFallback(csvUrl, attempt = 0) {
    const methods = [
        // Метод 1: Прямой fetch
        function() {
            return fetch(csvUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .catch(error => {
                    console.warn('Метод 1 (fetch) не удался:', error.message);
                    throw error;
                });
        },
        // Метод 2: YQL (обход CORS)
        function() {
            const yqlUrl = `https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20csv%20where%20url%3D%22${encodeURIComponent(csvUrl)}%22&format=json`;
            return fetch(yqlUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.query && data.query.results && data.query.results.row) {
                        const rows = Array.isArray(data.query.results.row) ? data.query.results.row : [data.query.results.row];
                        return rows.map(row => Object.values(row).join(',')).join('\n');
                    }
                    throw new Error('YQL не смог получить данные');
                })
                .catch(error => {
                    console.warn('Метод 2 (YQL) не удался:', error.message);
                    throw error;
                });
        },
        // Метод 3: CORS proxy (если доступен)
        function() {
            const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(csvUrl);
            return fetch(proxyUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Proxy error: ${response.status}`);
                    }
                    return response.text();
                })
                .catch(error => {
                    console.warn('Метод 3 (CORS proxy) не удался:', error.message);
                    throw error;
                });
        }
    ];
    
    if (attempt >= methods.length) {
        showSheetsError('Все методы загрузки не удались. Попробуйте загрузить CSV файл локально.');
        return;
    }
    
    const method = methods[attempt];
    console.log(`Попытка загрузки методом ${attempt + 1}...`);
    
    method()
        .then(csvData => {
            progressBar.style.width = '80%';
            progressText.textContent = 'Обработка данных...';
            
            // Парсим CSV
            return parseCSV(csvData, 'google_sheets');
        })
        .then(result => {
            progressBar.style.width = '100%';
            progressText.textContent = 'Готово!';
            
            setTimeout(() => {
                progress.style.display = 'none';
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check"></i> Загружено';
                status.innerHTML = '<i class="fas fa-check"></i> Готово';
                status.className = 'status-indicator status-success';
                
                showMessage(`✅ Успешно загружено ${result.count} кампаний!`, 'success', 'sheetsMessage');
                
                dataLoaded = true;
                updateList();
                updateCounters();
                switchTab('data');
                
                // Сохраняем успешную ссылку
                localStorage.setItem('lastSheetsUrl', document.getElementById('csvUrl').value);
                
            }, 1000);
        })
        .catch(error => {
            console.error('Ошибка загрузки Sheets:', error);
            progressBar.style.width = '0%';
            progressText.textContent = 'Ошибка';
            
            setTimeout(() => {
                // Пробуем следующий метод
                loadSheetsWithFallback(csvUrl, attempt + 1);
            }, 500);
        });
}

function showSheetsError(message) {
    const btn = document.getElementById('loadSheetsBtn');
    const progress = document.getElementById('sheetsProgress');
    const status = document.getElementById('sheetsStatus');
    const messageDiv = document.getElementById('sheetsMessage');
    
    if (btn) {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-file-csv"></i> Попробовать снова';
    }
    
    if (progress) progress.style.display = 'none';
    if (status) {
        status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Ошибка';
        status.className = 'status-indicator status-error';
    }
    
    showMessage(message + '<br><br><strong>Решение:</strong><br>• Загрузите CSV файл локально (кнопка ниже)<br>• Убедитесь, что таблица опубликована публично', 'error', 'sheetsMessage');
}

// ==================== ЗАГРУЗКА EXCEL ====================
function handleExcelFile(event) {
    console.log('Обработка Excel файла...');
    
    const file = event.target.files[0];
    const messageDiv = document.getElementById('excelMessage');
    const status = document.getElementById('excelStatus');
    const progress = document.getElementById('excelProgress');
    const progressBar = document.getElementById('excelProgressBar');
    const progressText = document.getElementById('excelProgressText');
    const fileInfo = document.getElementById('fileInfo');
    
    if (!file) {
        // Очистка
        if (fileInfo) fileInfo.innerHTML = '';
        return;
    }
    
    // Валидация файла
    if (!file.name.match(/\.(xlsx?|xls)$/i)) {
        showMessage('Выберите файл Excel (.xlsx или .xls)', 'error', 'excelMessage');
        event.target.value = '';
        return;
    }
    
    if (file.size > 10 * 1024 * 1024) {
        showMessage('Файл слишком большой (максимум 10MB)', 'error', 'excelMessage');
        event.target.value = '';
        return;
    }
    
    console.log('✅ Файл выбран:', file.name, file.size);
    
    // Показываем информацию
    if (fileInfo) {
        fileInfo.innerHTML = `
            <i class="fas fa-file-excel" style="color: var(--success); margin-right: 5px;"></i>
            ${file.name} 
            <span style="font-size: 12px; color: var(--dark);">
                (${(file.size / 1024).toFixed(1)} КБ)
            </span>
        `;
    }
    
    // Начинаем загрузку
    if (status) {
        status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Чтение файла...';
        status.className = 'status-indicator status-loading';
    }
    
    if (progress) progress.style.display = 'block';
    if (progressBar) progressBar.style.width = '10%';
    if (progressText) progressText.textContent = 'Чтение файла...';
    if (messageDiv) messageDiv.innerHTML = '';
    
    const reader = new FileReader();
    
    reader.onerror = function() {
        console.error('Ошибка чтения Excel файла');
        showMessage('Ошибка чтения файла. Попробуйте другой формат.', 'error', 'excelMessage');
        resetExcelState();
    };
    
    reader.onprogress = function(e) {
        if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 30); // 0-30%
            if (progressBar) progressBar.style.width = percent + '%';
            if (progressText) progressText.textContent = `Чтение: ${percent}%`;
        }
    };
    
    reader.onload = function(e) {
        try {
            console.log('🔄 Парсинг Excel...');
            
            if (progressText) progressText.textContent = 'Парсинг Excel...';
            if (progressBar) progressBar.style.width = '35%';
            
            // Читаем workbook
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { 
                type: 'array',
                cellDates: true,
                cellNF: false,
                defval: '',
                raw: false
            });
            
            if (progressBar) progressBar.style.width = '50%';
            if (progressText) progressText.textContent = 'Анализ структуры...';
            
            // Выбираем лист
            const sheetNames = workbook.SheetNames;
            let targetSheet = sheetNames[0];
            
            // Предпочтительные названия листов
            const preferred = ['данные', 'data', 'кампании', 'campaigns', 'main', 'основные'];
            for (let name of preferred) {
                if (sheetNames.includes(name)) {
                    targetSheet = name;
                    break;
                }
            }
            
            const worksheet = workbook.Sheets[targetSheet];
            if (!worksheet) {
                throw new Error(`Лист "${targetSheet}" не найден`);
            }
            
            if (progressText) progressText.textContent = 'Конвертация в данные...';
            if (progressBar) progressBar.style.width = '60%';
            
            // Конвертируем в JSON для лучшего анализа
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                header: 1,
                defval: '',
                raw: false,
                dateNF: 'dd.mm.yyyy' // Excel формат дат
            });
            
            if (progressText) progressText.textContent = `Найдено строк: ${jsonData.length}`;
            if (progressBar) progressBar.style.width = '70%';
            
            if (jsonData.length < 2) {
                throw new Error('В файле недостаточно данных');
            }
            
            // Создаем корректный CSV
            const csvData = XLSX.utils.sheet_to_csv(worksheet, {
                FS: ',',
                RS: '\r\n',
                dateNF: 'yyyy-mm-dd', // Стандартизированный формат
                strip: true,
                blankrows: false
            });
            
            // Парсим
            if (progressText) progressText.textContent = 'Валидация и парсинг...';
            if (progressBar) progressBar.style.width = '80%';
            
            return parseCSV(csvData, 'excel', {
                filename: file.name,
                sheetName: targetSheet,
                totalRows: jsonData.length,
                parsedHeaders: jsonData[0]
            });
            
        } catch (parseError) {
            console.error('Ошибка парсинга Excel:', parseError);
            showMessage(
                '<strong>Ошибка формата Excel:</strong><br>' +
                parseError.message +
                '<br><br><strong>Проверьте:</strong><br>' +
                '• Файл содержит данные (минимум заголовок + 1 строка)<br>' +
                '• Дата в формате YYYY-MM-DD или dd.mm.yyyy<br>' +
                '• Заголовки колонок корректны<br>' +
                '• Нет объединенных ячеек',
                'error', 'excelMessage'
            );
            resetExcelState();
        }
    };
    
    reader.readAsArrayBuffer(file);
}

function resetExcelState() {
    const progress = document.getElementById('excelProgress');
    const fileInput = document.getElementById('excelFile');
    const fileInfo = document.getElementById('fileInfo');
    const status = document.getElementById('excelStatus');
    
    if (progress) progress.style.display = 'none';
    if (fileInput) fileInput.value = '';
    if (fileInfo) fileInfo.innerHTML = '';
    if (status) {
        status.innerHTML = '<i class="fas fa-times"></i> Ошибка загрузки';
        status.className = 'status-indicator status-error';
    }
}

// ==================== ЗАГРУЗКА ЛОКАЛЬНОГО CSV ====================
function handleCsvFile(event) {
    console.log('Загрузка локального CSV...');
    
    const file = event.target.files[0];
    const messageDiv = document.getElementById('csvMessage');
    const status = document.getElementById('csvStatus');
    const progress = document.getElementById('csvProgress');
    const progressBar = document.getElementById('csvProgressBar');
    const progressText = document.getElementById('csvProgressText');
    const fileInfo = document.getElementById('csvFileInfo');
    
    if (!file) {
        if (fileInfo) fileInfo.innerHTML = '';
        return;
    }
    
    // Валидация
    if (file.size > 5 * 1024 * 1024) {
        showMessage('CSV файл слишком большой (максимум 5MB)', 'error', 'csvMessage');
        event.target.value = '';
        return;
    }
    
    // Показываем информацию
    if (fileInfo) {
        fileInfo.innerHTML = `
            <i class="fas fa-file-csv" style="color: var(--success); margin-right: 5px;"></i>
            ${file.name} 
            <span style="font-size: 12px; color: var(--dark);">
                (${(file.size / 1024).toFixed(1)} КБ)
            </span>
        `;
    }
    
    // Показываем загрузку
    if (status) {
        status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Чтение CSV...';
        status.className = 'status-indicator status-loading';
    }
    
    if (progress) progress.style.display = 'block';
    if (progressBar) progressBar.style.width = '30%';
    if (progressText) progressText.textContent = 'Чтение файла...';
    if (messageDiv) messageDiv.innerHTML = '';
    
    const reader = new FileReader();
    
    reader.onerror = function() {
        showMessage('Ошибка чтения CSV файла', 'error', 'csvMessage');
        resetCsvState();
    };
    
    reader.onload = function(e) {
        try {
            const csvData = e.target.result;
            if (!csvData || csvData.trim() === '') {
                throw new Error('CSV файл пуст');
            }
            
            if (progressText) progressText.textContent = 'Парсинг CSV...';
            if (progressBar) progressBar.style.width = '60%';
            
            parseCSV(csvData, 'csv_file', {
                filename: file.name,
                encoding: file.encoding || 'UTF-8'
            })
            .then(result => {
                if (progress) progress.style.display = 'none';
                
                if (status) {
                    status.innerHTML = '<i class="fas fa-check"></i> Готово';
                    status.className = 'status-indicator status-success';
                }
                
                showMessage(`✅ CSV загружен: ${result.count} записей успешно обработано`, 'success', 'csvMessage');
                
                dataLoaded = true;
                updateList();
                updateCounters();
                switchTab('data');
                
                // Очищаем поле выбора файла
                event.target.value = '';
                if (fileInfo) fileInfo.innerHTML = `
                    <i class="fas fa-check-circle" style="color: var(--success); margin-right: 5px;"></i>
                    ${file.name} 
                    <span style="font-size: 12px; color: var(--success);">
                        ✓ Загружено ${result.count} записей
                    </span>
                `;
                
                // Автоудаление информации через 3 секунды
                setTimeout(() => {
                    if (fileInfo) fileInfo.innerHTML = `
                        <i class="fas fa-check-circle" style="color: var(--success); margin-right: 5px;"></i>
                        ${file.name} 
                        <span style="font-size: 11px; color: var(--dark);">✓ Обработано успешно</span>
                    `;
                }, 3000);
                
            })
            .catch(error => {
                console.error('Ошибка парсинга CSV:', error);
                showMessage(error.message, 'error', 'csvMessage');
                resetCsvState();
            });
            
        } catch (error) {
            console.error('Критическая ошибка Excel/CSV:', error);
            showMessage('Критическая ошибка парсинга', 'error', 'csvMessage');
            resetCsvState();
        }
    };
    
    reader.readAsText(file, 'UTF-8');
}

function resetCsvState() {
    const progress = document.getElementById('csvProgress');
    const fileInput = document.getElementById('csvFile');
    const fileInfo = document.getElementById('csvFileInfo');
    const status = document.getElementById('csvStatus');
    
    if (progress) progress.style.display = 'none';
    if (fileInput && fileInput.value) fileInput.value = '';
    if (fileInfo) fileInfo.innerHTML = '';
    if (status) {
        status.innerHTML = '<i class="fas fa-times"></i> Ошибка загрузки';
        status.className = 'status-indicator status-error';
    }
}

// ==================== УНИФИЦИРОВАННЫЙ ПАРСЕР CSV/EXCEL ====================
function parseCSV(csvData, source = 'unknown', options = {}) {
    console.log('Парсер CSV/Excel запущен:', source, 'строк:', csvData.split('\n').length);
    
    try {
        // Удаляем BOM если присутствует
        if (csvData.charCodeAt(0) === 0xFEFF) {
            csvData = csvData.substring(1);
        }
        
        // Разбиваем на строки, убираем пустые
        let lines = csvData.split('\n')
            .map(line => line.trim())
            .filter(line => line.length > 0);
            
        if (lines.length < 2) {
            throw new Error('Недостаточно строк: нужен заголовок + минимум 1 строка данных');
        }
        
        console.log('📊 CSV парсинг: найдено', lines.length - 1, 'строк данных');
        
        // Парсим заголовки (первая строка)
        let headers = parseCSVLine(lines[0]);
        console.log('📋 Заголовки CSV:', headers);
        
        // Находим колонки по ключевым словам
        const columnMap = {
            date: findColumnIndex(headers, ['date', 'дата', 'день', 'day']),
            blogger: findColumnIndex(headers, ['blogger', 'блогер', 'influencer']),
            book: findColumnIndex(headers, ['book', 'книга', 'title', 'название']),
            cost: findColumnIndex(headers, ['cost', 'стоимость', 'expense', 'затраты']),
            profit: findColumnIndex(headers, ['profit', 'прибыль', 'revenue', 'доход']),
            quantity: findColumnIndex(headers, ['quantity', 'количество', 'qty', 'шт', 'count'])
        };
        
        console.log('🔍 Автосопоставление колонок:', columnMap);
        
        // Строим массив с данными (строки 2+)
        let parsedCampaigns = [];
        let validRows = 0;
        let skippedRows = 0;
        let skippedReasons = new Map();
        
        for (let i = 1; i < lines.length; i++) {
            try {
                const line = lines[i];
                const cells = parseCSVLine(line);
                
                if (cells.length < 3) { // Минимум дата, блогер, книга
                    skippedReasons.set('too_few_columns', (skippedReasons.get('too_few_columns') || 0) + 1);
                    skippedRows++;
                    continue;
                }
                
                // Извлекаем данные
                const row = {
                    date: getCellValue(cells, columnMap.date, i + 1),
                    blogger: getCellValue(cells, columnMap.blogger, i + 1),
                    book: getCellValue(cells, columnMap.profit, i + 1),
                    cost: parseFloat(getCellValue(cells, columnMap.cost, i + 1)) || 0,
                    cp: parseFloat(getCellValue(cells, columnMap.profit, i + 1)) || 0,
                    qty: parseInt(getCellValue(cells, columnMap.quantity, i + 1)) || 0
                };
                
                // Валидация
                const validation = validateRow(row, cells, i + 1, columnMap);
                if (!validation.isValid) {
                    skippedReasons.set(validation.reason, (skippedReasons.get(validation.reason) || 0) + 1);
                    skippedRows++;
                    continue;
                }
                
                parsedCampaigns.push(row);
                validRows++;
                
            } catch (cellError) {
                console.warn(`Строка ${i + 1}:`, cellError.message);
                skippedReasons.set('parse_error', (skippedReasons.get('parse_error') || 0) + 1);
                skippedRows++;
            }
        }
        
        if (parsedCampaigns.length === 0) {
            throw new Error(`Нет валидных данных. Пропущено ${skippedRows} строк. Проверьте формат:` +
                `\n• Дата: YYYY-MM-DD` +
                `\n• Блогер: текст (минимум 2 символа)` +
                `\n• Книга: текст` +
                `\n• Стоимость: число > 0` +
                `\n• ЧП: число > 0` +
                `\n• Количество: целое число > 0`);
        }
        
        // Сохраняем
        campaigns = parsedCampaigns;
        localStorage.setItem('campaigns', JSON.stringify(campaigns));
        
        // Обновляем интерфейс
        extractBloggersBooks();
        dataLoaded = true;
        
        console.log(`✅ Парсинг завершен:`);
        console.log(`   📊 Всего строк: ${lines.length - 1}`);
        console.log(`   ✓ Валидных: ${validRows}`);
        console.log(`   ⚠️ Пропущено: ${skippedRows}`);
        
        if (skippedReasons.size > 0) {
            console.log(`📋 Причины пропуска:`);
            skippedReasons.forEach(function(count, reason) {
                console.log(`   ${reason}: ${count}`);
            });
        }
        
        return {
            success: true,
            count: validRows,
            totalRows: lines.length - 1,
            skipped: skippedRows,
            source: source
        };
        
    } catch (error) {
        console.error('Критическая ошибка парсинга:', error);
        throw new Error(`Ошибка парсинга ${source}: ${error.message}`);
    }
}

// Вспомогательные функции парсера
function parseCSVLine(line) {
    let inQuotes = false;
    let field = '';
    let result = [];
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            result.push(field);
            field = '';
        } else {
            field += char;
        }
    }
    
    result.push(field); // Последнее поле
    return result.map(field => field.trim());
}

function getCellValue(cells, colIndex, rowNum) {
    if (colIndex >= 0 && colIndex < cells.length) {
        let value = cells[colIndex];
        
        // Если значение пустое
        if (!value || value.trim() === '') {
            return '';
        }
        
        // Убираем кавычки
        value = value.replace(/^"|"$/g, '');
        
        // Обработка дат из Excel (числа)
        if (!isNaN(value) && value > 25569) {
            const date = new Date((value - 25569) * 86400 * 1000);
            if (date instanceof Date && !isNaN(date)) {
                return date.toISOString().split('T')[0]; // YYYY-MM-DD
            }
        }
        
        // Возвращаем как есть
        return value;
    }
    
    return '';
}

function findColumnIndex(headers, keywords) {
    const indexes = [];
    
    headers.forEach(function(header, index) {
        const cleanHeader = header.toLowerCase().trim();
        for (let keyword of keywords) {
            if (cleanHeader.includes(keyword)) {
                indexes.push(index);
                break;
            }
        }
    });
    
    // Если найдено несколько - берем первый
    return indexes.length > 0 ? indexes[0] : -1;
}

function validateRow(row, cells, rowNum, columnMap) {
    const errors = [];
    
    // Дата
    if (!row.date || !row.date.trim()) {
        errors.push('no_date');
    } else if (!isValidDate(row.date)) {
        errors.push('invalid_date_format');
    }
    
    // Блогер
    if (!row.blogger || row.blogger.trim().length < 2) {
        errors.push('no_blogger');
    }
    
    // Книга
    if (!row.book || row.book.trim().length < 2) {
        errors.push('no_book');
    }
    
    // Числа
    if (row.cost <= 0 || isNaN(row.cost)) {
        errors.push('invalid_cost');
    }
    
    if (row.cp <= 0 || isNaN(row.cp)) {
        errors.push('invalid_cp');
    }
    
    if (row.qty <= 0 || isNaN(row.qty)) {
        errors.push('invalid_quantity');
    }
    
    if (errors.length > 0) {
        return {
            isValid: false,
            reason: errors[0],
            row: rowNum,
            errors: errors
        };
    }
    
    return { isValid: true };
}

function isValidDate(dateString) {
    // Проверяем ISO формат
    const isoRegex = /^\d{4}-\d{2}-\d{2}$/;
    if (isoRegex.test(dateString)) {
        const date = new Date(dateString);
        return date instanceof Date && !isNaN(date);
    }
    
    // Проверяем российский формат dd.mm.yyyy
    const ruRegex = /^\d{2}\.\d{2}\.\d{4}$/;
    if (ruRegex.test(dateString)) {
        const parts = dateString.split('.');
        const date = new Date(parts[2], parts[1] - 1, parts[0]);
        return date instanceof Date && !isNaN(date);
    }
    
    return false;
}

// ==================== ДЕМО ДАННЫЕ ====================
function loadDemoData() {
    if (campaigns.length > 0) {
        if (!confirm('Заменить текущие данные демо-данными? Текущие данные будут потеряны.')) {
            return;
        }
        localStorage.removeItem('campaigns');
        campaigns = [];
    }
    
    console.log('Загрузка демо-данных (малый набор)...');
    
    // Добавляем демо
    demoData.bloggers.forEach(function(b) {
        if (!bloggers.find(function(existing) { return existing.name === b.name; })) {
            bloggers.push(b);
        }
    });
    
    demoData.books.forEach(function(b) {
        if (!books.find(function(existing) { return existing.name === b.name; })) {
            books.push(b);
        }
    });
    
    campaigns = demoData.campaigns;
    
    // Сохраняем
    localStorage.setItem('bloggers', JSON.stringify(demoData.bloggers));
    localStorage.setItem('books', JSON.stringify(demoData.books));
    localStorage.setItem('campaigns', JSON.stringify(demoData.campaigns));
    localStorage.setItem('demoShown', 'true');
    
    // Обновляем
    dataLoaded = true;
    populateSelects();
    renderBloggers();
    renderBooks();
    updateList();
    updateCounters();
    
    switchTab('data');
    
    showMessage('🚀 Демо-данные загружены (5 блогеров, 5 книг, 5 кампаний). Переключитесь на "Данные"', 'success');
    console.log('✅ Демо-данные загружены');
}

function loadFullDemo() {
    if (campaigns.length > 0) {
        if (!confirm('Полная загрузка демо-данных сотрет текущие данные. Продолжить?')) {
            return;
        }
        localStorage.clear();
        localStorage.setItem('demoShown', 'true');
    }
    
    console.log('Загрузка полного демо (50+ записей)...');
    
    // Более полный набор
    const fullDemo = {
        bloggers: [
            { name: 'logoped.arshinova', link: 'https://t.me/logoped_arshinova' },
            { name: 'defectologist_kids', link: 'https://instagram.com/defectologist_kids' },
            { name: 'speech_therapy_pro', link: 'https://t.me/speech_therapy' },
            { name: 'pedagog_anna', link: 'https://t.me/pedagog_anna' },
            { name: 'logoped_maria', link: 'https://instagram.com/logoped_maria' },
            { name: 'kids_speech', link: '' },
            { name: 'logoped_family', link: 'https://t.me/logoped_family' },
            { name: 'speech_development', link: '' }
        ],
        books: [
            { name: 'Логопедия для детей 3-5 лет', cp: 350 },
            { name: 'Коррекция звукопроизношения', cp: 420 },
            { name: 'Развитие речи дошкольников', cp: 280 },
            { name: 'Артикуляционная гимнастика', cp: 180 },
            { name: 'Уроки логопеда для родителей', cp: 320 },
            { name: 'Логопедические упражнения', cp: 250 },
            { name: 'Речевые игры для детей', cp: 200 },
            { name: 'Коррекция заикания', cp: 380 }
        ],
        campaigns: [
            // logoped.arshinova (высокая эффективность)
            { date: '2025-01-15', blogger: 'logoped.arshinova', book: 'Логопедия для детей 3-5 лет', cost: 1500, cp: 350, qty: 25 },
            { date: '2025-01-12', blogger: 'logoped.arshinova', book: 'Коррекция звукопроизношения', cost: 2200, cp: 420, qty: 18 },
            { date: '2025-01-10', blogger: 'logoped.arshinova', book: 'Развитие речи дошкольников', cost: 800, cp: 280, qty: 30 },
            
            // defectologist_kids (средняя)
            { date: '2025-01-14', blogger: 'defectologist_kids', book: 'Артикуляционная гимнастика', cost: 1800, cp: 180, qty: 22 },
            { date: '2025-01-11', blogger: 'defectologist_kids', book: 'Уроки логопеда для родителей', cost: 1200, cp: 320, qty: 12 },
            
            // speech_therapy_pro (смешанные результаты)
            { date: '2025-01-13', blogger: 'speech_therapy_pro', book: 'Логопедические упражнения', cost: 950, cp: 250, qty: 8 },
            { date: '2025-01-09', blogger: 'speech_therapy_pro', book: 'Речевые игры для детей', cost: 600, cp: 200, qty: 25 },
            { date: '2025-01-07', blogger: 'speech_therapy_pro', book: 'Коррекция заикания', cost: 1100, cp: 380, qty: 5 },
            
            // Остальные с разной эффективностью
            { date: '2025-01-16', blogger: 'pedagog_anna', book: 'Логопедия для детей 3-5 лет', cost: 900, cp: 350, qty: 15 },
            { date: '2025-01-09', blogger: 'logoped_maria', book: 'Развитие речи дошкольников', cost: 1400, cp: 280, qty: 9 },
            { date: '2025-01-06', blogger: 'kids_speech', book: 'Артикуляционная гимнастика', cost: 700, cp: 180, qty: 35 },
            { date: '2025-01-04', blogger: 'logoped_family', book: 'Коррекция заикания', cost: 2500, cp: 380, qty: 4 },
            { date: '2025-01-02', blogger: 'speech_development', book: 'Уроки логопеда для родителей', cost: 1600, cp: 320, qty: 11 }
        ]
    };
    
    // Заменяем данные
    bloggers = fullDemo.bloggers;
    books = fullDemo.books;
    campaigns = fullDemo.campaigns;
    
    localStorage.setItem('bloggers', JSON.stringify(bloggers));
    localStorage.setItem('books', JSON.stringify(books));
    localStorage.setItem('campaigns', JSON.stringify(campaigns));
    
    // Обновляем
    dataLoaded = true;
    populateSelects();
    renderBloggers();
    renderBooks();
    updateList();
    updateCounters();
    
    switchTab('data');
    
    showMessage('🚀 Полный демо-загрузка завершена! 9 блогеров, 8 книг, 15 кампаний. Готовы для анализа!', 'success');
    console.log('✅ Полный демо загружен');
}

// ==================== СПРАВОЧНИКИ ====================
function populateSelects() {
    console.log('Обновление выпадающих списков...');
    
    // Сортируем
    const sortedBloggers = bloggers.sort(function(a, b) {
        return a.name.localeCompare(b.name);
    });
    
    const sortedBooks = books.sort(function(a, b) {
        return a.name.localeCompare(b.name);
    });
    
    // Блогеры
    const bloggerSelects = document.querySelectorAll('#campaignBlogger, #editBlogger, #filterBlogger');
    bloggerSelects.forEach(function(select) {
        const originalValue = select.value;
        
        // Создаем новый HTML
        let options = '';
        if (select.id !== 'filterBlogger') {
            options += '<option value="">Выберите блогера</option>';
        } else {
            options += '<option value="">Все блогеры</option>';
        }
        
        sortedBloggers.forEach(function(blogger) {
            options += `<option value="${blogger.name}">${blogger.name}</option>`;
        });
        
        select.innerHTML = options;
        
        // Восстанавливаем значение
        if (originalValue && sortedBloggers.find(function(b) { return b.name === originalValue; })) {
            select.value = originalValue;
        }
    });
    
    // Книги
    const bookSelects = document.querySelectorAll('#campaignBook, #editBook, #filterBook');
    bookSelects.forEach(function(select) {
        const originalValue = select.value;
        
        let options = '';
        if (select.id !== 'filterBook') {
            options += '<option value="">Выберите книгу</option>';
        } else {
            options += '<option value="">Все книги</option>';
        }
        
        sortedBooks.forEach(function(book) {
            options += `<option value="${book.name}">${book.name} (ЧП: ${book.cp.toFixed(2)} руб.)</option>`;
        });
        
        select.innerHTML = options;
        
        if (originalValue && sortedBooks.find(function(b) { return b.name === originalValue; })) {
            select.value = originalValue;
        }
    });
    
    // Обработчики изменения
    const numericInputs = document.querySelectorAll('#campaignCost, #campaignCP, #campaignQty');
    numericInputs.forEach(function(input) {
        input.addEventListener('input', updateCampaignPreview);
    });
    
    console.log('✓ Селекты обновлены');
}

function renderBloggers() {
    const container = document.getElementById('bloggersList');
    if (!container) {
        console.error('Контейнер блогеров не найден');
        return;
    }
    
    if (bloggers.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-users-slash" style="font-size: 4em; color: var(--warning); margin-bottom: 20px;"></i>
                <h3>Справочник блогеров пуст</h3>
                <p style="margin-bottom: 20px;">Блогеры будут автоматически созданы при загрузке кампаний</p>
                <button class="add-btn" onclick="showAddBloggerModal()">
                    <i class="fas fa-user-plus"></i> Добавить блогера вручную
                </button>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    bloggers.forEach(function(blogger, index) {
        // Статистика
        const bloggerCampaigns = campaigns.filter(function(c) {
            return c.blogger === blogger.name;
        });
        
        const totalCampaigns = bloggerCampaigns.length;
        const totalCost = bloggerCampaigns.reduce(function(sum, c) {
            return sum + c.cost;
        }, 0);
        
        const totalRevenue = bloggerCampaigns.reduce(function(sum, c) {
            return sum + (c.cp * c.qty);
        }, 0);
        
        const totalProfit = totalRevenue - totalCost;
        const roas = totalCost > 0 ? (totalRevenue / totalCost).toFixed(2) : 0;
        const roi = totalCost > 0 ? ((totalRevenue - totalCost) / totalCost * 100).toFixed(1) : 0;
        
        const efficiencyClass = roas > 3 ? 'success' : roas > 1.5 ? 'warning' : 'danger';
        
        // Последние кампании
        const recentCampaigns = bloggerCampaigns
            .sort(function(a, b) {
                return new Date(b.date) - new Date(a.date);
            })
            .slice(0, 3)
            .map(function(campaign) {
                const campaignProfit = campaign.cp * campaign.qty;
                const campaignROI = campaign.cost > 0 ? ((campaignProfit - campaign.cost) / campaign.cost * 100).toFixed(0) : 0;
                
                return `<div style="display: flex; justify-content: space-between; padding: 6px; margin: 3px 0; background: rgba(255,255,255,0.5); border-radius: 4px; font-size: 13px;">
                    <div>
                        <div style="font-weight: 600; margin-bottom: 2px;">${campaign.date}</div>
                        <div style="color: var(--dark); font-size: 11px;">${campaign.book}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: ${campaignROI > 100 ? 'var(--primary)' : campaignROI > 0 ? 'var(--warning)' : 'var(--danger)'};">${campaignROI}%</div>
                        <div style="font-size: 11px; color: var(--dark);">${campaign.qty} шт.</div>
                    </div>
                </div>`;
            }).join('');
            
        html += `
            <div class="blogger-card ${efficiencyClass}" data-blogger="${index}">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-user" style="color: var(--secondary);"></i>
                        ${escapeHtml(blogger.name)}
                    </div>
                    <div class="card-stats">
                        <div class="metric positive">
                            <i class="fas fa-chart-line"></i> ${totalCampaigns} кампаний
                        </div>
                        <div class="metric ${efficiencyClass}">
                            <i class="fas fa-coins"></i> ROAS: ${roas}x
                        </div>
                        <div class="metric">
                            <i class="fas fa-rub"></i> Прибыль: ${totalProfit.toFixed(0)} руб.
                        </div>
                    </div>
                </div>
                
                <div class="card-details">
                    <div class="detail-label">Ссылка:</div>
                    <div class="detail-value">
                        ${blogger.link ? 
                            `<a href="${escapeHtml(blogger.link)}" target="_blank" rel="noopener" class="tooltip">
                                <i class="fas fa-external-link-alt" style="color: var(--secondary); margin-right: 5px;"></i>
                                ${escapeHtml(blogger.link.length > 40 ? blogger.link.substring(0, 37) + '...' : blogger.link)}
                                <span class="tooltiptext">${escapeHtml(blogger.link)}</span>
                            </a>` : 
                            '<span style="color: var(--warning);"><i class="fas fa-info-circle"></i> Не указана</span>'
                        }
                    </div>
                    
                    <div class="detail-label">Недавние кампании:</div>
                    <div class="detail-value">
                        ${recentCampaigns || '<span style="color: var(--warning);">Нет кампаний</span>'}
                    </div>
                </div>
                
                <div class="card-actions">
                    <button class="add-btn" onclick="editBlogger(${index})" style="padding: 8px 15px; font-size: 13px;">
                        <i class="fas fa-edit"></i> Редактировать
                    </button>
                    <button class="btn-close" onclick="deleteBlogger(${index})" style="padding: 8px 15px; font-size: 13px;">
                        <i class="fas fa-trash"></i> Удалить
                    </button>
                    ${blogger.link ? 
                        `<a href="${escapeHtml(blogger.link)}" target="_blank" class="add-btn" style="padding: 8px 15px; font-size: 13px; background: var(--secondary); text-decoration: none; color: white; display: inline-flex; align-items: center;">
                            <i class="fas fa-external-link-alt"></i> Профиль
                        </a>` : ''
                    }
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html || `
        <div class="empty-state">
            <i class="fas fa-users" style="font-size: 4em; color: var(--warning); margin-bottom: 20px;"></i>
            <h3>Блогеры не найдены</h3>
            <p>Загрузите данные или добавьте блогера вручную</p>
            <button class="add-btn" onclick="switchTab('load')">
                <i class="fas fa-upload"></i> Загрузить данные
            </button>
        </div>
    `;
}

function renderBooks() {
    const container = document.getElementById('booksList');
    if (!container) return;
    
    if (books.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-book" style="font-size: 4em; color: var(--warning); margin-bottom: 20px;"></i>
                <h3>Книги не найдены</h3>
                <p>Книги создаются автоматически при загрузке кампаний</p>
                <button class="add-btn" onclick="switchTab('load')">
                    <i class="fas fa-upload"></i> Загрузить данные
                </button>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    books.forEach(function(book, index) {
        // Статистика книги
        const bookCampaigns = campaigns.filter(function(c) {
            return c.book === book.name;
        });
        
        const totalCampaigns = bookCampaigns.length;
        const totalSold = bookCampaigns.reduce(function(sum, c) {
            return sum + c.qty;
        }, 0);
        
        const totalRevenue = bookCampaigns.reduce(function(sum, c) {
            return sum + (c.cp * c.qty);
        }, 0);
        
        const totalCost = bookCampaigns.reduce(function(sum, c) {
            return sum + c.cost;
        }, 0);
        
        const totalProfit = totalRevenue - totalCost;
        const roi = totalCost > 0 ? ((totalRevenue - totalCost) / totalCost * 100).toFixed(1) : 0;
        
        const efficiencyClass = roi > 100 ? 'success' : roi > 0 ? 'warning' : 'danger';
        
        // Недавние продажи
        const recentSales = bookCampaigns
            .sort(function(a, b) {
                return new Date(b.date) - new Date(a.date);
            })
            .slice(0, 3)
            .map(function(campaign) {
                return `<div style="display: flex; justify-content: space-between; padding: 6px; margin: 3px 0; background: rgba(255,255,255,0.5); border-radius: 4px; font-size: 13px;">
                    <div>
                        <div style="font-weight: 600;">${campaign.date}</div>
                        <div style="color: var(--dark); font-size: 11px;">${campaign.blogger}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 600;">${campaign.qty} шт.</div>
                        <div style="font-size: 11px; color: var(--dark);">${(campaign.cp * campaign.qty).toFixed(0)} руб.</div>
                    </div>
                </div>`;
            }).join('');
            
        html += `
            <div class="book-card ${efficiencyClass}" data-book="${index}">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-book" style="color: var(--secondary);"></i>
                        ${escapeHtml(book.name)}
                    </div>
                    <div class="card-stats">
                        <div class="metric positive">
                            <i class="fas fa-shopping-bag"></i> Продано: ${totalSold} шт.
                        </div>
                        <div class="metric ${efficiencyClass}">
                            <i class="fas fa-rub"></i> ROI: ${roi}%
                        </div>
                        <div class="metric">
                            <i class="fas fa-coins"></i> Выручка: ${totalRevenue.toFixed(0)} руб.
                        </div>
                    </div>
                </div>
                
                <div class="card-details">
                    <div class="detail-label">ЧП за книгу:</div>
                    <div class="detail-value">
                        <span style="font-weight: 600; color: var(--success);">${book.cp.toFixed(2)}</span> руб.
                    </div>
                    
                    <div class="detail-label">Недавние продажи:</div>
                    <div class="detail-value">
                        ${recentSales || '<span style="color: var(--warning);">Продажи отсутствуют</span>'}
                    </div>
                </div>
                
                <div class="card-actions">
                    <button class="add-btn" onclick="editBook(${index})" style="padding: 8px 15px; font-size: 13px;">
                        <i class="fas fa-edit"></i> Редактировать
                    </button>
                    <button class="btn-close" onclick="deleteBook(${index})" style="padding: 8px 15px; font-size: 13px;">
                        <i class="fas fa-trash"></i> Удалить
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// ==================== ПАРСИНГ И ВАЛИДАЦИЯ ====================
function parseCSV(csvData, source = 'unknown') {
    console.log(`🔍 Парсинг ${source}: ${csvData.split('\n').length} строк`);
    
    try {
        // Основные импорты
        let lines = csvData.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
            throw new Error('Недостаточно строк (нужен заголовок + данные)');
        }
        
        // Парсим заголовки
        const headers = parseCSVLine(lines[0]);
        console.log('📋 Найдено заголовков:', headers.length, headers);
        
        // Сопоставление колонок
        const colMap = {
            date: headers.findIndex(h => h.toLowerCase().match(/date|дата|день/)),
            blogger: headers.findIndex(h => h.toLowerCase().match(/blogger|блогер|influencer|автор/)),
            book: headers.findIndex(h => h.toLowerCase().match(/book|книга|title|название/)),
            cost: headers.findIndex(h => h.toLowerCase().match(/cost|стоимость|expense|затраты|sum/)),
        cp: headers.findIndex(h => h.toLowerCase().match(/cp|прибыль|revenue|доход|profit/)),
        qty: headers.findIndex(h => h.toLowerCase().match(/qty|количество|quantity|count|шт/))
    };
    
    console.log('🔍 Сопоставление колонок:', colMap);
    
    // Проверяем обязательные колонки
    const required = ['date', 'blogger', 'book', 'cost', 'qty'];
    let missingCols = [];
    
    required.forEach(function(col) {
        if (colMap[col] === -1) {
            missingCols.push(col);
        }
    });
    
    if (missingCols.length > 0) {
        console.warn('⚠️ Отсутствуют колонки:', missingCols);
        // Пробуем позиции по умолчанию для CSV
        if (source !== 'excel') {
            colMap.date = 0;
            colMap.blogger = 1;
            colMap.book = 2;
            colMap.cost = 3;
            colMap.cp = 4;
            colMap.qty = 5;
        } else {
            throw new Error('В Excel отсутствуют обязательные колонки: ' + missingCols.join(', '));
        }
    }
    
    // Парсим данные
    let parsedCampaigns = [];
    let validCount = 0;
    let invalidCount = 0;
    
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (line.trim().length === 0) continue;
        
        const cells = parseCSVLine(line);
        if (cells.length < 3) {
            console.warn(`Строка ${i + 1}: слишком мало колонок`);
            invalidCount++;
            continue;
        }
        
        // Извлекаем значения
        let date = getCellValue(cells, colMap.date, i + 1);
        let blogger = getCellValue(cells, colMap.blogger, i + 1);
        let book = getCellValue(cells, colMap.book, i + 1);
        let cost = parseFloat(getCellValue(cells, colMap.cost, i + 1)) || 0;
        let cp = parseFloat(getCellValue(cells, colMap.cp, i + 1)) || 0;
        let qty = parseInt(getCellValue(cells, colMap.qty, i + 1)) || 0;
        
        // Валидация
        if (!date || !blogger || !book) {
            console.warn(`Строка ${i + 1}: пропущены обязательные поля`);
            invalidCount++;
            continue;
        }
        
        if (cost <= 0 || cp <= 0 || qty <= 0) {
            console.warn(`Строка ${i + 1}: некорректные числа - cost: ${cost}, cp: ${cp}, qty: ${qty}`);
            invalidCount++;
            continue;
        }
        
        // Добавляем в результат
        parsedCampaigns.push({
            date: date,
            blogger: blogger.trim(),
            book: book.trim(),
            cost: cost,
            cp: cp,
            qty: qty
        });
        
        validCount++;
    }
    
    if (parsedCampaigns.length === 0) {
        throw new Error('Нет валидных записей для загрузки');
    }
    
    campaigns = parsedCampaigns;
    localStorage.setItem('campaigns', JSON.stringify(campaigns));
    extractBloggersBooks();
    
    console.log(`✓ Парсинг завершен: ${validCount} из ${lines.length - 1} строк`);
    
    return {
        success: true,
        count: validCount,
        total: lines.length - 1,
        skipped: invalidCount
    };
}

// Вспомогательные функции парсинга
function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    let inDoubleQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
            inDoubleQuotes = !inDoubleQuotes;
        } else if (char === "'" && !inDoubleQuotes) {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes && !inDoubleQuotes) {
            result.push(current);
            current = '';
        } else {
            current += char;
        }
    }
    
    result.push(current);
    return result.map(s => s.trim());
}

function getCellValue(cells, index, rowNumber) {
    if (index >= 0 && index < cells.length) {
        let value = cells[index];
        
        // Удаляем кавычки
        value = value.replace(/^"|"$/g, '');
        
        // Если пустое значение
        if (!value || value.trim() === '' || value === 'NULL') {
            return '';
        }
        
        // Обработка Excel серийных номеров дат
        if (!isNaN(value) && value > 1000 && value < 100000) {
            const asDate = new Date((parseFloat(value) - 25569) * 86400 * 1000);
            if (asDate instanceof Date && !isNaN(asDate.getTime())) {
                return asDate.toISOString().split('T')[0];
            }
        }
        
        return value;
    }
    
    return '';
}

// ==================== ВАЛИДАЦИЯ ====================
function validateRow(row, cells, rowIndex, colMap) {
    const errors = [];
    
    if (!row.date) {
        errors.push('Дата обязательна');
    } else if (!isValidDate(row.date)) {
        errors.push('Неверный формат даты: ' + row.date);
    }
    
    if (!row.blogger || row.blogger.trim().length < 2) {
        errors.push('Имя блогера слишком короткое или отсутствует');
    }
    
    if (!row.book || row.book.trim().length < 2) {
        errors.push('Название книги слишком короткое или отсутствует');
    }
    
    if (row.cost <= 0) {
        errors.push('Стоимость должна быть больше 0');
    }
    
    if (row.cp <= 0) {
        errors.push('ЧП с книги должно быть больше 0');
    }
    
    if (row.qty <= 0) {
        errors.push('Количество должно быть больше 0');
    }
    
    return errors.length === 0;
}

function isValidDate(dateString) {
    // YYYY-MM-DD
    const isoPattern = /^(\d{4})-(\d{2})-(\d{2})$/;
    if (isoPattern.test(dateString)) {
        const [, year, month, day] = isoPattern.exec(dateString);
        const date = new Date(year, month - 1, day);
        return date.getFullYear() === parseInt(year) &&
               date.getMonth() + 1 === parseInt(month) &&
               date.getDate() === parseInt(day);
    }
    
    // DD.MM.YYYY (российский формат)
    const ruPattern = /^(\d{2})\.(\d{2})\.(\d{4})$/;
    if (ruPattern.test(dateString)) {
        const [, day, month, year] = ruPattern.exec(dateString);
        const date = new Date(year, month - 1, day);
        return date.getFullYear() === parseInt(year) &&
               date.getMonth() + 1 === parseInt(month) &&
               date.getDate() === parseInt(day);
    }
    
    return false;
}

// ==================== СПРАВОЧНИКИ ====================
function extractBloggersBooks() {
    console.log('Извлечение справочников...');
    
    // Блогеры
    const uniqueBloggers = [...new Set(campaigns.map(c => c.blogger))]
        .filter(b => b && b.trim());
    
    uniqueBloggers.forEach(function(name) {
        if (!bloggers.find(b => b.name === name)) {
            bloggers.push({ name: name.trim(), link: '' });
        }
    });
    
    // Книги
    const uniqueBooks = [...new Set(campaigns.map(c => c.book))]
        .filter(b => b && b.trim());
    
    uniqueBooks.forEach(function(name) {
        if (!books.find(bk => bk.name === name)) {
            // Среднее ЧП для книги
            const bookCampaigns = campaigns.filter(c => c.book === name);
            const avgCP = bookCampaigns.length > 0 ? 
                bookCampaigns.reduce((sum, c) => sum + c.cp, 0) / bookCampaigns.length : 0;
            
            books.push({ name: name.trim(), cp: avgCP || 0 });
        }
    });
    
    saveStorage();
    populateSelects();
    renderBloggers();
    renderBooks();
    updateCounters();
}

// ==================== ОТОБРАЖЕНИЕ ДАННЫХ ====================
function updateList(filteredCampaigns = campaigns) {
    const container = document.getElementById('dataTableContainer');
    if (!container) return;
    
    if (filteredCampaigns.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-table" style="font-size: 4em; color: var(--warning); margin-bottom: 20px;"></i>
                <h3>Нет данных для отображения</h3>
                <p style="margin-bottom: 20px;">Загрузите Excel/CSV файл или добавьте кампанию вручную</p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="add-btn" onclick="switchTab('load')">
                        <i class="fas fa-upload"></i> Загрузить
                    </button>
                    <button class="add-btn" onclick="switchTab('campaigns')">
                        <i class="fas fa-plus"></i> Добавить
                    </button>
                </div>
            </div>
        `;
        document.getElementById('recordsCount').textContent = '0 записей';
        return;
    }
    
    let tableHTML = `
        <table>
            <thead>
                <tr>
                    <th>Дата</th>
                    <th>Блогер</th>
                    <th>Книга</th>
                    <th>Затраты</th>
                    <th>Продажи</th>
                    <th>Метрики</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    filteredCampaigns.forEach(function(campaign, index) {
        const revenue = campaign.cp * campaign.qty;
        const profit = revenue - campaign.cost;
        const roi = campaign.cost > 0 ? ((revenue - campaign.cost) / campaign.cost * 100).toFixed(1) : 0;
        const roas = campaign.cost > 0 ? revenue / campaign.cost : 0;
        const cps = campaign.qty > 0 ? campaign.cost / campaign.qty : 0;
        
        const roiClass = roi > 100 ? 'positive' : roi > 0 ? 'neutral' : 'negative';
        const profitClass = profit > 0 ? 'positive' : 'negative';
        
        tableHTML += `
            <tr class="${index === 0 ? 'new-row' : ''}">
                <td style="font-weight: 600; white-space: nowrap;">
                    <span class="tooltip" title="${campaign.date}">${campaign.date}</span>
                </td>
                <td style="max-width: 180px; word-break: break-word;">
                    <span class="tooltip" title="Блогер: ${escapeHtml(campaign.blogger)}">${escapeHtml(campaign.blogger)}</span>
                </td>
                <td style="max-width: 180px; word-break: break-word;">
                    <span class="tooltip" title="Книга: ${escapeHtml(campaign.book)}">${escapeHtml(campaign.book)}</span>
                </td>
                <td>
                    <div class="metrics-group">
                        <div class="metric-item">
                            <span class="metric-label">Затраты:</span>
                            <span>${campaign.cost.toLocaleString()} руб.</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">ЧП/книга:</span>
                            <span class="positive">${campaign.cp.toFixed(2)} руб.</span>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="metrics-group">
                        <div class="metric-item">
                            <span class="metric-label">Количество:</span>
                            <span style="color: var(--secondary); font-weight: 600;">${campaign.qty}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Выручка:</span>
                            <span class="positive">${revenue.toLocaleString()} руб.</span>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="metrics-group">
                        <div class="metric-item">
                            <span class="metric-label">Прибыль:</span>
                            <span class="${profitClass}">${profit.toLocaleString()} руб.</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">ROI:</span>
                            <span class="${roiClass}">${roi > 0 ? '+' : ''}${roi}%</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">ROAS:</span>
                            <span class="positive">${roas.toFixed(2)}x</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">CPS:</span>
                            <span>${cps.toFixed(0)} руб./шт.</span>
                        </div>
                    </div>
                </td>
                <td style="white-space: nowrap;">
                    <button class="add-btn" onclick="editCampaign(${index})" style="padding: 6px 8px; font-size: 11px;" title="Редактировать">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-close" onclick="deleteCampaign(${index})" style="padding: 6px 8px; font-size: 11px;" title="Удалить">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    tableHTML += '</tbody></table>';
    
    container.innerHTML = tableHTML;
    document.getElementById('recordsCount').textContent = filteredCampaigns.length + ' записей';
}

// ==================== ФИЛЬТРЫ ====================
function toggleFilters() {
    const panel = document.getElementById('filtersPanel');
    const btn = document.getElementById('toggleFiltersBtn');
    
    if (panel.style.display === 'none' || panel.style.display === '') {
        panel.style.display = 'block';
        btn.innerHTML = '<i class="fas fa-filter"></i> Скрыть фильтры';
    } else {
        panel.style.display = 'none';
        btn.innerHTML = '<i class="fas fa-filter"></i> Показать фильтры';
    }
}

function applyFilters() {
    let filtered = campaigns.slice();
    
    const activeFilters = {
        dateFrom: document.getElementById('filterDateFrom').value,
        dateTo: document.getElementById('filterDateTo').value,
        blogger: document.getElementById('filterBlogger').value,
        book: document.getElementById('filterBook').value,
        roiMin: parseFloat(document.getElementById('filterROIFrom').value) || -Infinity,
        roiMax: parseFloat(document.getElementById('filterROITo').value) || Infinity,
        roasMin: parseFloat(document.getElementById('filterROASFrom').value) || 0,
        roasMax: parseFloat(document.getElementById('filterROASTo').value) || Infinity,
        cpsMin: parseFloat(document.getElementById('filterCPSFrom').value) || 0,
        cpsMax: parseFloat(document.getElementById('filterCPSTo').value) || Infinity
    };
    
    // Фильтр по дате
    if (activeFilters.dateFrom) {
        filtered = filtered.filter(c => new Date(c.date) >= new Date(activeFilters.dateFrom));
    }
    if (activeFilters.dateTo) {
        filtered = filtered.filter(c => new Date(c.date) <= new Date(activeFilters.dateTo));
    }
    
    // По блогеру/книге
    if (activeFilters.blogger) {
        filtered = filtered.filter(c => c.blogger === activeFilters.blogger);
    }
    if (activeFilters.book) {
        filtered = filtered.filter(c => c.book === activeFilters.book);
    }
    
    // По метрикам
    filtered = filtered.filter(c => {
        const revenue = c.cp * c.qty;
        const profit = revenue - c.cost;
        const roi = c.cost > 0 ? (profit / c.cost * 100) : 0;
        const roas = c.cost > 0 ? revenue / c.cost : 0;
        const cps = c.qty > 0 ? c.cost / c.qty : Infinity;
        
        return roi >= activeFilters.roiMin && roi <= activeFilters.roiMax &&
               roas >= activeFilters.roasMin && roas <= activeFilters.roasMax &&
               cps >= activeFilters.cpsMin && cps <= activeFilters.cpsMax;
    });
    
    updateList(filtered);
    showMessage(`Фильтры применены: показано ${filtered.length} из ${campaigns.length} записей`, 'info');
}

function clearFilters() {
    ['filterDateFrom', 'filterDateTo', 'filterBlogger', 'filterBook', 
     'filterROIFrom', 'filterROITo', 'filterROASFrom', 'filterROASTo', 
     'filterCPSFrom', 'filterCPSTo'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = '';
    });
    
    updateList();
    showMessage('Фильтры сброшены', 'info');
    toggleFilters(); // Скрываем панель
}

// ==================== АНАЛИЗ ====================
function analyzeTop() {
    if (campaigns.length === 0) {
        showMessage('Нет данных для анализа', 'error');
        return;
    }
    
    console.log('Анализ топ-10 блогеров...');
    
    const stats = {};
    
    campaigns.forEach(function(campaign) {
        const revenue = campaign.cp * campaign.qty;
        const profit = revenue - campaign.cost;
        
        if (!stats[campaign.blogger]) {
            stats[campaign.blogger] = {
                cost: 0,
                revenue: 0,
                campaigns: 0,
                bestBooks: {}
            };
        }
        
        stats[campaign.blogger].cost += campaign.cost;
        stats[campaign.blogger].revenue += revenue;
        stats[campaign.blogger].campaigns += 1;
        
        if (!stats[campaign.blogger].bestBooks[campaign.book]) {
            stats[campaign.blogger].bestBooks[campaign.book] = 0;
        }
        stats[campaign.blogger].bestBooks[campaign.book] += revenue;
    });
    
    const top = Object.keys(stats)
        .map(blogger => {
            const data = stats[blogger];
            const roas = data.cost > 0 ? data.revenue / data.cost : 0;
            const roi = data.cost > 0 ? ((data.revenue - data.cost) / data.cost) * 100 : 0;
            
            return {
                name: blogger,
                roas: roas,
                roi: roi,
                cost: data.cost,
                revenue: data.revenue,
                campaigns: data.campaigns,
                topBooks: Object.keys(data.bestBooks)
                    .map(book => ({ name: book, revenue: data.bestBooks[book] }))
                    .sort((a, b) => b.revenue - a.revenue)
                    .slice(0, 2)
            };
        })
        .filter(b => b.cost > 0)
        .sort((a, b) => b.roas - a.roas)
        .slice(0, 10);
    
    const container = document.getElementById('analysisResults');
    if (!container) return;
    
    let html = `
        <div style="margin-bottom: 25px;">
            <h3 style="color: var(--primary); margin: 0 0 15px 0;">
                <i class="fas fa-trophy" style="margin-right: 10px;"></i>
                Топ-${top.length} блогеров по ROAS
            </h3>
            <p style="color: var(--dark); margin: 0;">
                Анализ ${campaigns.length} кампаний. Общий бюджет: ${campaigns.reduce((sum, c) => sum + c.cost, 0).toLocaleString()} руб.
            </p>
        </div>
    `;
    
    top.forEach((blogger, i) => {
        const rankClass = i < 3 ? (i === 0 ? 'positive' : i === 1 ? 'neutral' : 'warning') : '';
        const medal = i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : `${i + 1}.`;
        
        const topBooks = blogger.topBooks.map(book => 
            `<div style="display: flex; justify-content: space-between; padding: 3px 0; font-size: 13px;">
                📚 ${book.name}: ${book.revenue.toLocaleString()} руб.
            </div>`
        ).join('');
        
        html += `
            <div class="blogger-card" style="border-left: 5px solid var(--${rankClass});">
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <div style="width: 40px; height: 40px; background: ${rankClass}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; margin-right: 15px;">
                        ${medal}
                    </div>
                    <div style="flex: 1;">
                        <h4 style="margin: 0; font-size: 1.3em; color: var(--dark);">${escapeHtml(blogger.name)}</h4>
                        <p style="margin: 5px 0 0 0; color: var(--secondary); font-size: 14px;">
                            ${blogger.campaigns} кампаний | Затраты: ${blogger.cost.toLocaleString()} руб. | Прибыль: ${blogger.revenue.toLocaleString()} руб.
                        </p>
                    </div>
                    <div style="text-align: right;">
                        <div class="metrics positive" style="font-size: 1.4em; margin-bottom: 5px;">
                            <strong>${blogger.roas.toFixed(2)}x</strong>
                        </div>
                        <div style="${blogger.roi > 100 ? 'color: var(--primary)' : 'color: var(--warning)'}">
                            ROI: ${blogger.roi.toFixed(0)}%
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; font-size: 14px;">
                    <div>
                        <h5 style="margin: 0 0 10px 0; color: var(--secondary);">Основные показатели</h5>
                        <div style="padding: 10px; background: var(--light); border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                                <span>Затраты:</span><span>${blogger.cost.toLocaleString()} руб.</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 5px 0; color: var(--primary);">
                                <span>Прибыль:</span><span>${blogger.revenue.toLocaleString()} руб.</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                                <span>CPS:</span><span>${(blogger.cost / blogger.campaigns).toFixed(0)} руб./камп.</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h5 style="margin: 0 0 10px 0; color: var(--secondary);">Лучшие книги</h5>
                        <div style="padding: 10px; background: var(--light); border-radius: 6px;">
                            ${topBooks}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    // Общая статистика
    const overall = {
        cost: campaigns.reduce((sum, c) => sum + c.cost, 0),
        revenue: campaigns.reduce((sum, c) => sum + (c.cp * c.qty), 0),
        campaigns: campaigns.length
    };
    
    html += `
        <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, var(--primary), #45a049); color: white; border-radius: 10px; text-align: center;">
            <h3 style="margin: 0 0 20px 0;"><i class="fas fa-chart-pie"></i> Общая сводка</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; font-size: 16px;">
                <div>
                    <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">${overall.campaigns}</div>
                    <div>кампаний</div>
                </div>
                <div>
                    <div style="font-size: 28px; font-weight: bold; color: var(--warning); margin-bottom: 5px;">${overall.cost.toLocaleString()}</div>
                    <div>общий бюджет</div>
                </div>
                <div>
                    <div style="font-size: 28px; font-weight: bold; color: var(--success); margin-bottom: 5px;">${overall.revenue.toLocaleString()}</div>
                    <div>общая прибыль</div>
                </div>
                <div>
                    <div style="font-size: 28px; font-weight: bold; color: ${overall.cost > 0 ? 'var(--success)' : 'var(--danger)'} margin-bottom: 5px;">
                        ${(overall.cost > 0 ? overall.revenue / overall.cost : 0).toFixed(2)}x
                    </div>
                    <div>общий ROAS</div>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    showMessage(`Анализ завершен! Обработано ${campaigns.length} кампаний. Топ-${top.length} блогеров.`, 'success');
}

// ==================== МОДАЛЬНЫЕ ОКНА ====================
function showAddBloggerModal() {
    editingType = 'blogger';
    document.getElementById('bloggerModalTitle').innerHTML = '<i class="fas fa-user-plus"></i> Добавить блогера';
    document.getElementById('bloggerName').value = '';
    document.getElementById('bloggerLink').value = '';
    document.getElementById('saveBloggerBtn').onclick = addBlogger;
    showModal('addBloggerModal');
    document.getElementById('bloggerName').focus();
}

function addBlogger() {
    const name = document.getElementById('bloggerName').value.trim();
    const link = document.getElementById('bloggerLink').value.trim();
    
    if (!name || name.length < 2) {
        alert('Введите имя блогера (минимум 2 символа)');
        return;
    }
    
    if (bloggers.find(b => b.name.toLowerCase() === name.toLowerCase())) {
        alert('Блогер с таким именем уже существует');
        return;
    }
    
    bloggers.push({ name, link: link || '' });
    saveStorage();
    renderBloggers();
    populateSelects();
    hideAddBloggerModal();
    showMessage(`Блогер "${name}" добавлен`, 'success');
}

function showAddBookModal() {
    editingType = 'book';
    document.getElementById('bookModalTitle').innerHTML = '<i class="fas fa-book-open"></i> Добавить книгу';
    document.getElementById('bookName').value = '';
    document.getElementById('bookCP').value = '';
    document.getElementById('saveBookBtn').onclick = addBook;
    showModal('addBookModal');
    document.getElementById('bookName').focus();
}

function addBook() {
    const name = document.getElementById('bookName').value.trim();
    const cp = parseFloat(document.getElementById('bookCP').value) || 0;
    
    if (!name || name.length < 2) {
        alert('Введите название книги (минимум 2 символа)');
        return;
    }
    
    if (cp <= 0) {
        alert('ЧП с книги должно быть больше 0');
        return;
    }
    
    if (books.find(bk => bk.name.toLowerCase() === name.toLowerCase())) {
        alert('Книга с таким названием уже существует');
        return;
    }
    
    books.push({ name, cp });
    saveStorage();
    renderBooks();
    populateSelects();
    updateList(); // Пересчитываем метрики
    hideAddBookModal();
    showMessage(`Книга "${name}" добавлена (ЧП: ${cp} руб.)`, 'success');
}

function showEditCampaignModal(index) {
    editingType = 'campaign';
    currentEditIndex = index;
    
    const campaign = campaigns[index];
    document.getElementById('editDate').value = campaign.date;
    document.getElementById('editBlogger').value = campaign.blogger;
    document.getElementById('editBook').value = campaign.book;
    document.getElementById('editCost').value = campaign.cost;
    document.getElementById('editCP').value = campaign.cp;
    document.getElementById('editQty').value = campaign.qty;
    
    document.getElementById('saveCampaignEditBtn').onclick = saveCampaignEdit;
    showModal('editCampaignModal');
    document.getElementById('editDate').focus();
}

function saveCampaignEdit() {
    const index = currentEditIndex;
    const campaign = campaigns[index];
    
    const date = document.getElementById('editDate').value;
    const blogger = document.getElementById('editBlogger').value;
    const book = document.getElementById('editBook').value;
    const cost = parseFloat(document.getElementById('editCost').value);
    const cp = parseFloat(document.getElementById('editCP').value);
    const qty = parseInt(document.getElementById('editQty').value);
    
    if (!date || !blogger || !book || cost <= 0 || cp <= 0 || qty <= 0) {
        alert('Заполните все поля корректно');
        return;
    }
    
    campaigns[index] = { date, blogger, book, cost, cp, qty };
    saveStorage();
    updateList();
    hideEditCampaignModal();
    showMessage('Кампания обновлена', 'success');
}

function hideAddBloggerModal() {
    document.getElementById('addBloggerModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function hideAddBookModal() {
    document.getElementById('addBookModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function hideEditCampaignModal() {
    document.getElementById('editCampaignModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    currentEditIndex = -1;
    editingType = null;
}

// ==================== LOCALSTORAGE ====================
function saveStorage() {
    try {
        localStorage.setItem('bloggers', JSON.stringify(bloggers));
        localStorage.setItem('books', JSON.stringify(books));
        localStorage.setItem('campaigns', JSON.stringify(campaigns));
        console.log('💾 Данные сохранены в localStorage');
    } catch (error) {
        console.error('Ошибка сохранения:', error);
        showMessage('Ошибка сохранения данных', 'error');
    }
}

// ==================== УДАЛЕНИЕ ====================
function deleteBlogger(index) {
    if (confirm('Удалить блогера и все связанные кампании?')) {
        const name = bloggers[index].name;
        bloggers.splice(index, 1);
        campaigns = campaigns.filter(c => c.blogger !== name);
        saveStorage();
        renderBloggers();
        populateSelects();
        updateList();
        updateCounters();
        showMessage(`Блогер "${name}" удален`, 'success');
    }
}

function deleteBook(index) {
    if (confirm('Удалить книгу и все связанные кампании?')) {
        const name = books[index].name;
        books.splice(index, 1);
        campaigns = campaigns.filter(c => c.book !== name);
        saveStorage();
        renderBooks();
        populateSelects();
        updateList();
        updateCounters();
        showMessage(`Книга "${name}" удалена`, 'success');
    }
}

function deleteCampaign(index) {
    if (confirm('Удалить кампанию?')) {
        campaigns.splice(index, 1);
        saveStorage();
        updateList();
        updateCounters();
        showMessage('Кампания удалена', 'success');
    }
}

// ==================== СБРОС ====================
function showResetModal() {
    const modal = document.getElementById('resetModal');
    const password = document.getElementById('resetPassword');
    
    if (modal) modal.style.display = 'block';
    if (password) password.value = '';
    
    document.body.style.overflow = 'hidden';
}

function confirmReset() {
    const password = document.getElementById('resetPassword').value;
    if (password === 'admin') {
        if (confirm('Это удалит ВСЕ данные безвозвратно! Продолжить?')) {
            localStorage.clear();
            bloggers = [];
            books = [];
            campaigns = [];
            saveStorage();
            renderBloggers();
            renderBooks();
            updateList();
            populateSelects();
            updateCounters();
            hideResetModal();
            switchTab('load');
            showMessage('Данные полностью сброшены', 'success');
        }
    } else {
        alert('Неверный пароль! (Подсказка: admin)');
    }
}

function hideResetModal() {
    document.getElementById('resetModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

// ==================== DEBUG ====================
function toggleDebug() {
    const panel = document.getElementById('debugPanel');
    if (panel.classList.contains('show')) {
        panel.classList.remove('show');
    } else {
        updateDebugPanel();
        panel.classList.add('show');
    }
}

function updateDebugPanel() {
    const content = document.getElementById('debugContent');
    if (!content) return;
    
    const stats = calculateOverallStats();
    const memory = {
        bloggers: localStorage.getItem('bloggers')?.length || 0,
        books: localStorage.getItem('books')?.length || 0,
        campaigns: localStorage.getItem('campaigns')?.length || 0
    };
    
    content.innerHTML = `
        <div class="debug-item">
            <strong>📊 Статистика:</strong>
        </div>
        <div class="debug-item">
            <strong>Блогеры:</strong> ${bloggers.length} (${memory.bloggers} байт)
        </div>
        <div class="debug-item">
            <strong>Книги:</strong> ${books.length} (${memory.books} байт)
        </div>
        <div class="debug-item">
            <strong>Кампании:</strong> ${campaigns.length} (${memory.campaigns} байт)
        </div>
        <div class="debug-item">
            <strong>localStorage:</strong> ${(memory.bloggers + memory.books + memory.campaigns) / 1024 | 0} КБ
        </div>
        <div class="debug-item">
            <strong>Общий ROAS:</strong> ${(stats.revenue / stats.cost).toFixed(2)}x
        </div>
        <div class="debug-item">
            <strong>Общий ROI:</strong> ${stats.roi.toFixed(1)}%
        </div>
        <div class="debug-item">
            <strong>SheetJS:</strong> ${typeof XLSX !== 'undefined' ? '✓ Версия ' + XLSX.version : '✗ Не загружен'}
        </div>
        <div class="debug-item">
            <strong>Браузер:</strong> ${navigator.userAgentData ? navigator.userAgentData.platform : navigator.platform}
        </div>
        <div class="debug-item">
            <strong>Версия:</strong> v7.4 (исправлен парсинг)
        </div>
    `;
}

// ==================== ЭКСПОРТ ====================
function exportData() {
    if (campaigns.length === 0) {
        showMessage('Нет данных для экспорта', 'error');
        return;
    }
    
    // Подготовка данных для экспорта
    const exportData = campaigns.map(c => {
        const revenue = c.cp * c.qty;
        const profit = revenue - c.cost;
        const roi = c.cost > 0 ? ((revenue - c.cost) / c.cost * 100) : 0;
        const roas = c.cost > 0 ? revenue / c.cost : 0;
        const cps = c.qty > 0 ? c.cost / c.qty : 0;
        
        return {
            'Дата': c.date,
            'Блогер': c.blogger,
            'Книга': c.book,
            'Затраты (руб.)': c.cost,
            'ЧП/книга (руб.)': c.cp,
            'Количество': c.qty,
            'Выручка (руб.)': revenue,
            'Прибыль (руб.)': profit,
            'ROI (%)': roi,
            'ROAS (x)': roas,
            'CPS (руб./шт.)': cps
        };
    });
    
    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Кампании');
    
    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
    const filename = `Анализатор_блогеров_${timestamp}.xlsx`;
    
    XLSX.writeFile(wb, filename);
    showMessage(`Экспорт завершен: ${filename}`, 'success');
}

// ==================== УТИЛИТЫ ====================
function showWelcomeMessage() {
    const welcome = document.createElement('div');
    welcome.className = 'message warning';
    welcome.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1000; max-width: 350px;';
    welcome.innerHTML = `
        <i class="fas fa-star" style="font-size: 20px; color: #ffc107;"></i>
        <strong>Добро пожаловать!</strong> Для тестирования нажмите "Загрузить демо" ниже.
        <br><small>Создаст блогеров, книги и кампании для демонстрации функций.</small>
        <button onclick="loadDemoData(); welcome.remove(); this.parentElement.style.display='none';" 
                style="margin-top: 8px; padding: 6px 12px; background: rgba(255,193,7,0.2); border: 1px solid #ffc107; color: #856404; border-radius: 4px; cursor: pointer;">
            🚀 Загрузить демо
        </button>
    `;
    
    document.body.appendChild(welcome);
    
    setTimeout(() => {
        if (welcome.parentNode) {
            welcome.style.opacity = '0';
            setTimeout(() => welcome.remove(), 300);
        }
    }, 10000);
}

function showMessage(text, type = 'info', targetId = null) {
    let target = targetId ? document.getElementById(targetId) : document.body;
    
    // Удаляем предыдущие сообщения
    const existing = target.querySelector('.message');
    if (existing) existing.remove();
    
    const message = document.createElement('div');
    message.className = `message ${type}`;
    message.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-circle' : 'info-circle'}"></i>
        ${text}
    `;
    
    target.insertBefore(message, target.firstChild);
    
    // Автоудаление
    setTimeout(() => {
        if (message.parentNode) {
            message.style.opacity = '0';
            setTimeout(() => message.remove(), 300);
        }
    }, 8000);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ==================== СОВМЕСТИМОСТЬ И ЗАПУСК ====================
document.addEventListener('DOMContentLoaded', function() {
    console.log('Загрузка анализатора v7.4...');
    
    // Ждем полной загрузки
    if (document.readyState !== 'complete') {
        window.addEventListener('load', initApp);
    } else {
        setTimeout(initApp, 100);
    }
});

// Глобальный обработчик ошибок
window.addEventListener('error', function(e) {
    console.error('Глобальная ошибка:', e.error || e.message);
    showMessage('Произошла ошибка: ' + (e.error || e.message), 'error');
});

// Обработчик неподдерживаемого браузера
if (!window.fetch || !Array.from || !Object.entries) {
    document.addEventListener('DOMContentLoaded', function() {
        document.body.innerHTML = `
            <div style="text-align: center; padding: 50px; background: white; margin: 50px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                <h2 style="color: var(--danger);">Браузер не поддерживается</h2>
                <p>Для работы требуется современный браузер с поддержкой:</p>
                <ul style="text-align: left; max-width: 400px; margin: 20px auto;">
                    <li><strong>JavaScript ES6+</strong> (Chrome 60+, Firefox 60+, Safari 11+, Edge 79+)</li>
                    <li><strong>localStorage</strong> для сохранения данных</li>
                    <li><strong>File API</strong> для загрузки файлов</li>
                </ul>
                <p style="margin-top: 20px;">
                    <strong>Рекомендуется:</strong> Google Chrome, Mozilla Firefox (последние версии)
                </p>
                <p style="font-size: 12px; color: var(--dark); margin-top: 15px;">
                    Альтернатива: обновите браузер или используйте другой
                </p>
            </div>
        `;
        document.head.innerHTML = '<title>Браузер не поддерживается</title>';
    });
}

console.log('✅ Скрипт загружен. Ожидание DOM...');
</script>
</body>
</html>


