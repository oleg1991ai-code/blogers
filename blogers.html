<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –±–ª–æ–≥–µ—Ä–æ–≤ (–∏–∑ Google Sheets —Å Proxy)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f4f4f4; }
        input, select, button { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #0056b3; }
        .delete-btn { background: #dc3545; width: auto; padding: 5px 10px; margin: 0 5px 0 0; font-size: 12px; }
        .delete-btn:hover { background: #c82333; }
        .edit-btn { background: #ffc107; color: black; width: auto; padding: 5px 10px; margin: 0 5px 0 0; font-size: 12px; }
        .edit-btn:hover { background: #e0a800; }
        .copy-btn { background: #28a745; width: auto; padding: 5px 10px; margin: 0 2px; font-size: 12px; }
        .copy-btn:hover { background: #218838; }
        .copy-btn:disabled { background: #6c757d; cursor: not-allowed; }
        .reset-btn { background: #ffc107; color: black; margin-top: 20px; width: auto; padding: 10px 20px; }
        .reset-btn:hover { background: #e0a800; }
        #results, #top-table, #data-list, #blogger-dir, #book-dir { margin-top: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        th { background: #dee2e6; cursor: pointer; position: relative; }
        th:hover { background: #ced4da; }
        .sort-arrow { font-size: 12px; margin-left: 5px; }
        .hidden { display: none; }
        .data-table { overflow-x: auto; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 20px; border-radius: 8px; width: 400px; max-width: 90%; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        .sort-info { font-style: italic; color: #6c757d; margin-top: 5px; }
        .invalid-date { color: #dc3545; font-style: italic; }
        .filter-section { background: #e9ecef; padding: 15px; border-radius: 5px; margin-bottom: 10px; }
        .filter-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; align-items: end; }
        .filter-row label { min-width: 100px; flex: 0 0 auto; font-weight: bold; }
        .filter-row input, .filter-row select { flex: 1 1 150px; max-width: 200px; }
        .filter-btn { width: auto; padding: 8px 15px; background: #28a745; }
        .filter-btn:hover { background: #218838; }
        .clear-btn { background: #6c757d; }
        .clear-btn:hover { background: #5a6268; }
        #tableContainer { margin-top: 10px; }
        .blogger-link { word-break: break-all; max-width: 200px; }
        .dir-table th:last-child, .dir-table td:last-child { width: 150px; }
        .dir-toggle-btn { background: #17a2b8; margin-bottom: 10px; width: auto; padding: 10px 20px; }
        .dir-toggle-btn:hover { background: #138496; }
        #book-dir { margin-top: 20px; }
        #addForm { background: #e9ecef; padding: 15px; border-radius: 5px; }
        #effPreview, #editEffPreview { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 3px; font-size: 14px; border-left: 4px solid #007bff; }
        .cheat-sheet { background: #d4edda; padding: 10px; border-radius: 5px; margin: 10px 0; cursor: pointer; border: 1px solid #c3e6cb; }
        .cheat-details { display: none; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 3px; }
        .toast { position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 12px 20px; border-radius: 5px; z-index: 2000; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .load-section { margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6; }
        .toggle-local { width: auto; padding: 8px 15px; background: #6c757d; color: white; margin-top: 10px; }
        .no-data { text-align: center; color: #6c757d; font-style: italic; }
    </style>
</head>
<body>
    <h1>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –±–ª–æ–≥–µ—Ä–æ–≤ (–∏–∑ Google Sheets —Å Proxy)</h1>
    
    <div class="load-section">
        <h2>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h2>
        <label for="googleUrl">–°—Å—ã–ª–∫–∞ –Ω–∞ Google Sheets (published CSV):</label>
        <input type="url" id="googleUrl" placeholder="https://docs.google.com/spreadsheets/d/e/.../pub?output=csv" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vRK-2p3_uOFcFBb6HdP3ybMjt3RAlxnf7FN69RRNcomTykj6gJm-kC6EOEV74G1QQ/pub?output=csv">
        <small>Published /pub?output=csv ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é. –î–ª—è /edit: Publish to web ‚Üí CSV. Excel fallback –Ω–∏–∂–µ.</small>
        <br>
        <button onclick="loadFromGoogleSheets()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Google Sheets</button>
        
        <button class="toggle-local" onclick="toggleLocalUpload()">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π Excel</button>
        <div id="localUploadSection" class="hidden">
            <input type="file" id="excelFile" accept=".xlsx,.xls">
            <br>
            <button onclick="loadExcel()">–ó–∞–≥—Ä—É–∑–∏—Ç—å Excel</button>
        </div>
        <div id="loadStatus" class="no-data"></div>
    </div>
    
    <div id="blogger-dir" class="hidden">
        <h2>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –±–ª–æ–≥–µ—Ä–æ–≤</h2>
        <button class="dir-toggle-btn" onclick="toggleBloggerDir()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å | ‚ûñ –ó–∞–∫—Ä—ã—Ç—å</button>
        <button onclick="addBlogger()">+ –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–≥–µ—Ä–∞</button>
        <div id="bloggerTableContainer"></div>
    </div>
    
    <div id="book-dir" class="hidden">
        <h2>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∫–Ω–∏–≥</h2>
        <button class="dir-toggle-btn" onclick="toggleBookDir()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å | ‚ûñ –ó–∞–∫—Ä—ã—Ç—å</button>
        <button onclick="addBook()">+ –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É</button>
        <div id="bookTableContainer"></div>
    </div>
    
    <div id="addForm">
        <h2>–î–æ–±–∞–≤–∏—Ç—å/–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é</h2>
        <label for="date">–î–∞—Ç–∞:</label>
        <input type="date" id="date" required>
        
        <label for="blogger">–ë–ª–æ–≥–µ—Ä:</label>
        <select id="blogger" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–≥–µ—Ä–∞</option>
        </select>
        
        <label for="book">–ö–Ω–∏–≥–∞:</label>
        <select id="book" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–Ω–∏–≥—É</option>
        </select>
        
        <label for="cost">–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–∫–ª–∞–º—ã (—Ä—É–±.):</label>
        <input type="number" id="cost" step="0.01" min="0" required oninput="calculateEff()">
        
        <label for="profitPerBook">–ß–ü —Å –∫–Ω–∏–≥–∏ (—Ä—É–±.):</label>
        <input type="number" id="profitPerBook" step="0.01" min="0" required oninput="calculateEff()">
        
        <label for="quantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö —à—Ç.:</label>
        <input type="number" id="quantity" min="0" required oninput="calculateEff()">
        
        <button onclick="addCampaign()">+ –î–æ–±–∞–≤–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é</button>
        <div id="effPreview"></div>
    </div>
    
    <div id="data-list">
        <h2>–°–ø–∏—Å–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</h2>
        <button onclick="showDataList()">üîÑ –ü–æ–∫–∞–∑–∞—Ç—å/–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        <div id="filterSection" class="filter-section hidden">
            <h3>–§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</h3>
            <div class="filter-row">
                <label>–î–∞—Ç–∞ –æ—Ç:</label>
                <input type="date" id="filterDateFrom">
                <label>–î–∞—Ç–∞ –¥–æ:</label>
                <input type="date" id="filterDateTo">
            </div>
            <div class="filter-row">
                <label>–ë–ª–æ–≥–µ—Ä:</label>
                <select id="filterBlogger">
                    <option value="">–í—Å–µ –±–ª–æ–≥–µ—Ä—ã</option>
                </select>
                <label>–ö–Ω–∏–≥–∞:</label>
                <select id="filterBook">
                    <option value="">–í—Å–µ –∫–Ω–∏–≥–∏</option>
                </select>
            </div>
            <div class="filter-row">
                <label>ROI –º–∏–Ω (%):</label>
                <input type="number" id="filterROIMin" step="1">
                <label>ROI –º–∞–∫—Å (%):</label>
                <input type="number" id="filterROIMax" step="1">
            </div>
            <div class="filter-row">
                <label>ROAS –º–∏–Ω:</label>
                <input type="number" id="filterROASMin" step="0.01">
                <label>ROAS –º–∞–∫—Å:</label>
                <input type="number" id="filterROASMax" step="0.01">
            </div>
            <div class="filter-row">
                <label>CPS –º–∏–Ω (—Ä—É–±.):</label>
                <input type="number" id="filterCPSMin" step="0.01">
                <label>CPS –º–∞–∫—Å (—Ä—É–±.):</label>
                <input type="number" id="filterCPSMax" step="0.01">
            </div>
            <button class="filter-btn" onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
            <button class="filter-btn clear-btn" onclick="clearFilters()">–û—á–∏—Å—Ç–∏—Ç—å</button>
            
            <div class="cheat-sheet" onclick="toggleCheatSheet()">
                üìã –®–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º (–∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π)
            </div>
            <div id="cheatDetails" class="cheat-details">
                <strong>ROI (%):</strong> (–ü—Ä–∏–±—ã–ª—å - –ó–∞—Ç—Ä–∞—Ç—ã) / –ó–∞—Ç—Ä–∞—Ç—ã * 100. >0% ‚Äî –ø—Ä–∏–±—ã–ª—å; >100% ‚Äî –æ—Ç–ª–∏—á–Ω–∞—è –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å.<br>
                <strong>ROAS:</strong> –ü—Ä–∏–±—ã–ª—å / –ó–∞—Ç—Ä–∞—Ç—ã. >1 ‚Äî –æ–∫—É–ø–∞–µ—Ç—Å—è; >3 ‚Äî —Å—É–ø–µ—Ä—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ.<br>
                <strong>CPS (—Ä—É–±./—à—Ç.):</strong> –ó–∞—Ç—Ä–∞—Ç—ã / –ö–æ–ª-–≤–æ. –ß–µ–º –Ω–∏–∂–µ, —Ç–µ–º –ª—É—á—à–µ (–∏–¥–µ–∞–ª—å–Ω–æ < –ß–ü —Å –∫–Ω–∏–≥–∏).<br>
                <em>–î–∞–Ω–Ω—ã–µ –∏–∑ –≤–∞—à–µ–≥–æ sheet: e.g., row20 ROI=1869% (logoped.arshinova, '–ö–∞–∫ –±–∞–±–∞ –Ø–≥–∞...').</em>
            </div>
        </div>
        <p id="noDataMsg" class="no-data">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –∫–∞–º–ø–∞–Ω–∏—é –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.</p>
        <div id="tableContainer"></div>
        <div id="sortInfo" class="sort-info"></div>
    </div>
    
    <div id="top-table">
        <h2>–¢–æ–ø-10 –±–ª–æ–≥–µ—Ä–æ–≤ (–ø–æ —Å—Ä–µ–¥–Ω–µ–º—É ROAS)</h2>
        <button onclick="analyzeTop()">üîÑ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
        <p class="no-data" id="noTopMsg">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.</p>
        <div id="topTableContainer"></div>
    </div>
    
    <button class="reset-btn" onclick="openResetModal()">üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ (localStorage)</button>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- –ú–æ–¥–∞–ª—ã -->
    <div id="resetModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeResetModal()">&times;</span>
            <h3>–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö</h3>
            <p>–≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –∫–∞–º–ø–∞–Ω–∏–∏, –±–ª–æ–≥–µ—Ä–æ–≤ –∏ –∫–Ω–∏–≥–∏ –∏–∑ localStorage. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª–µ–º.</p>
            <input type="password" id="resetPassword" placeholder="–ü–∞—Ä–æ–ª—å –¥–ª—è —Å–±—Ä–æ—Å–∞">
            <br>
            <button onclick="resetData()">–°–±—Ä–æ—Å–∏—Ç—å</button>
            <button onclick="closeResetModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="bloggerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeBloggerModal()">&times;</span>
            <h3 id="bloggerModalTitle">–ë–ª–æ–≥–µ—Ä</h3>
            <label for="bloggerName">–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–≥–µ—Ä–∞:</label>
            <input type="text" id="bloggerName" required>
            <label for="bloggerLink">–°—Å—ã–ª–∫–∞ (URL):</label>
            <input type="url" id="bloggerLink" placeholder="https://t.me/... –∏–ª–∏ https://vk.com/...">
            <br>
            <button onclick="saveBlogger()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button onclick="closeBloggerModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="bookModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeBookModal()">&times;</span>
            <h3 id="bookModalTitle">–ö–Ω–∏–≥–∞</h3>
            <label for="bookName">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏:</label>
            <input type="text" id="bookName" required>
            <br>
            <button onclick="saveBook()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button onclick="closeBookModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="campaignModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCampaignModal()">&times;</span>
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é</h3>
            <label for="editDate">–î–∞—Ç–∞:</label>
            <input type="date" id="editDate">
            <label for="editBlogger">–ë–ª–æ–≥–µ—Ä:</label>
            <select id="editBlogger"></select>
            <label for="editBook">–ö–Ω–∏–≥–∞:</label>
            <select id="editBook"></select>
            <label for="editCost">–°—Ç–æ–∏–º–æ—Å—Ç—å (—Ä—É–±.):</label>
            <input type="number" id="editCost" step="0.01" min="0" oninput="calculateEditEff()">
            <label for="editProfitPerBook">–ß–ü —Å –∫–Ω–∏–≥–∏ (—Ä—É–±.):</label>
            <input type="number" id="editProfitPerBook" step="0.01" min="0" oninput="calculateEditEff()">
            <label for="editQuantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
            <input type="number" id="editQuantity" min="0" oninput="calculateEditEff()">
            <div id="editEffPreview"></div>
            <input type="hidden" id="editCampaignId">
            <br>
            <button onclick="saveCampaignEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            <button onclick="closeCampaignModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script>
        let campaigns = JSON.parse(localStorage.getItem('campaigns')) || [];
        let bloggers = JSON.parse(localStorage.getItem('bloggers')) || [];
        let books = JSON.parse(localStorage.getItem('books')) || [];
        let sortColumn = 'date';
        let sortDirection = 'desc';
        let filters = {};
        let editingBloggerId = null;
        let editingBookId = null;
        let editingCampaignId = null;

        // Utility functions
        function formatNumber(num) {
            return num % 1 === 0 ? num.toString() : num.toFixed(2).replace('.', ',');
        }

        function extractBloggerName(fullUrl) {
            if (!fullUrl) return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
            const match = fullUrl.match(/\/([^\/\?]+)(\?|$)/);
            return match ? match[1] : fullUrl.trim().split('/').pop();
        }

        function normalizeDate(rawDate) {
            if (!rawDate || rawDate === '' || rawDate === '.') return 'N/A';
            let dateStr = rawDate.toString().trim();
            try {
                if (dateStr.includes('..')) dateStr = dateStr.replace(/\.\./g, '/'); // e.g., 28..02.2025 ‚Üí 28/02/2025
                if (dateStr.includes(' ')) dateStr = dateStr.split(' ')[0];
                if (dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) { // MM/DD/YYYY
                    const parts = dateStr.split('/');
                    return `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                } else if (dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{2}$/)) { // MM/DD/YY
                    const parts = dateStr.split('/');
                    const year = `20${parts[2]}`;
                    return `${year}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                }
                const parsed = new Date(dateStr);
                if (!isNaN(parsed.getTime())) {
                    const year = parsed.getFullYear();
                    const month = (parsed.getMonth() + 1).toString().padStart(2, '0');
                    const day = parsed.getDate().toString().padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
            } catch (e) {
                console.warn('Date parse error:', rawDate, e);
            }
            return 'N/A';
        }

        function calculateMetrics(cost, totalProfit, quantity) {
            const roi = cost > 0 ? Math.round(((totalProfit - cost) / cost * 100) * 100) / 100 : 0;
            const roas = cost > 0 ? (totalProfit / cost).toFixed(2) : 0;
            const cps = quantity > 0 ? (cost / quantity).toFixed(2) : 0;
            return { roi, roas: parseFloat(roas), cps: parseFloat(cps) };
        }

        function calculateEff() {
            const cost = parseFloat(document.getElementById('cost').value) || 0;
            const profitPerBook = parseFloat(document.getElementById('profitPerBook').value) || 0;
            const quantity = parseInt(document.getElementById('quantity').value) || 0;
            if (cost <= 0 || profitPerBook <= 0 || quantity <= 0) {
                document.getElementById('effPreview').innerHTML = '<em>–í–≤–µ–¥–∏—Ç–µ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è preview.</em>';
                return;
            }
            const totalProfit = quantity * profitPerBook;
            const { roi, roas, cps } = calculateMetrics(cost, totalProfit, quantity);
            document.getElementById('effPreview').innerHTML = 
                `<strong>–ß–ü –≤—Å–µ–≥–æ: ${formatNumber(totalProfit)} —Ä—É–±.</strong><br>` +
                `ROI: ${roi}%<br>` +
                `ROAS: ${roas}<br>` +
                `CPS: ${cps} —Ä—É–±./—à—Ç.`;
        }

        function calculateEditEff() {
            const cost = parseFloat(document.getElementById('editCost').value) || 0;
            const profitPerBook = parseFloat(document.getElementById('editProfitPerBook').value) || 0;
            const quantity = parseInt(document.getElementById('editQuantity').value) || 0;
            if (cost <= 0 || profitPerBook <= 0 || quantity <= 0) {
                document.getElementById('editEffPreview').innerHTML = '';
                return;
            }
            const totalProfit = quantity * profitPerBook;
            const { roi, roas, cps } = calculateMetrics(cost, totalProfit, quantity);
            document.getElementById('editEffPreview').innerHTML = 
                `–ß–ü –≤—Å–µ–≥–æ: ${formatNumber(totalProfit)} —Ä—É–±.<br>` +
                `ROI: ${roi}%<br>` +
                `ROAS: ${roas}<br>` +
                `CPS: ${cps} —Ä—É–±./—à—Ç.`;
        }

        function copyLinkToClipboard(link) {
            if (!link) return showToast('–ù–µ—Ç —Å—Å—ã–ª–∫–∏ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.');
            navigator.clipboard.writeText(link).then(() => {
                showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
            }).catch(() => {
                const ta = document.createElement('textarea');
                ta.value = link;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
            });
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 3000);
        }

        // CSV parsing and load functions (as before, with improvements)
        function simpleFillDown(json, colIndex) {
            let lastValue = '';
            for (let i = 1; i < json.length; i++) { // Skip header
                if (json[i][colIndex] && json[i][colIndex] !== '') lastValue = json[i][colIndex];
                else if (lastValue !== '') json[i][colIndex] = lastValue;
            }
            return json;
        }

        function parseCSV(csvText) {
            if (!csvText) throw new Error('CSV –ø—É—Å—Ç–æ–π.');
            csvText = csvText.replace(/^\uFEFF/, '').trim();
            if (csvText.startsWith('<!DOCTYPE') || csvText.includes('Sorry')) {
                throw new Error('HTML-–æ—à–∏–±–∫–∞ –æ—Ç Google. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /pub?output=csv (Publish to web).');
            }
            console.log('CSV snippet:', csvText.substring(0, 500));
            const lines = csvText.split(/\r?\n/).filter(l => l.trim());
            if (lines.length < 2) throw new Error('–ú–∞–ª–æ —Å—Ç—Ä–æ–∫ –≤ CSV.');
            
            let delimiter = ',';
            if (lines[0].split(',').length < 5) delimiter = ';';
            console.log('Delimiter:', delimiter, 'Lines:', lines.length);
            
            const result = lines.map(line => {
                const row = [];
                let cell = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') inQuotes = !inQuotes;
                    else if (char === delimiter && !inQuotes) {
                        row.push(cell.replace(/^"|"$/g, '').trim());
                        cell = '';
                    } else cell += char;
                }
                row.push(cell.replace(/^"|"$/g, '').trim());
                return row.filter(c => c !== ''); // Skip empty cells
            }).filter(row => row.length > 0);
            console.log('Parsed rows:', result.length, 'Header:', result[0]);
            return result;
        }

        function loadFromGoogleSheets() {
    const url = document.getElementById('googleUrl').value.trim();
    if (!url) return document.getElementById('loadStatus').innerHTML = '–í–≤–µ–¥–∏—Ç–µ URL.';
    
    let csvUrl = url.includes('/pub?output=csv') ? url : null;
    if (!csvUrl) {
        const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
        if (!match) return alert('–ù–µ–≤–µ—Ä–Ω—ã–π URL.');
        csvUrl = `https://docs.google.com/spreadsheets/d/${match[1]}/export?format=csv&gid=0`;
    }
    
    document.getElementById('loadStatus').innerHTML = '–ó–∞–≥—Ä—É–∂–∞–µ–º CSV... (–ø—Ä–æ–±—É–µ–º proxies)';
    
    // –ú–∞—Å—Å–∏–≤ proxies –¥–ª—è fallback
    const proxies = [
        `https://corsproxy.io/?${encodeURIComponent(csvUrl)}`,  // 1: corsproxy
        `https://thingproxy.freeboard.io/fetch/${csvUrl}`,     // 2: thingproxy (—Å—Ç–∞–±–∏–ª—å–Ω—ã–π)
        `https://api.allorigins.win/get?url=${encodeURIComponent(csvUrl)}`  // 3: allorigins
    ];
    
    // –§—É–Ω–∫—Ü–∏—è fetch —Å retry
    function tryFetch(fetchUrl, attempt = 1) {
        return fetch(fetchUrl)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                if (fetchUrl.includes('allorigins')) return response.json().then(data => data.contents);  // Wrapper
                return response.text();  // –ü—Ä—è–º–æ–π CSV
            })
            .catch(error => {
                console.warn(`Proxy ${attempt} failed:`, error);
                if (attempt < proxies.length) {
                    document.getElementById('loadStatus').innerHTML = `Proxy ${attempt} failed, –ø—Ä–æ–±—É–µ–º ${attempt + 1}...`;
                    return tryFetch(proxies[attempt], attempt + 1);
                }
                // Fallback: –ü—Ä—è–º–æ–π fetch (—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ HTTP-—Å–µ—Ä–≤–µ—Ä–µ)
                document.getElementById('loadStatus').innerHTML = 'Proxies failed, –ø—Ä–æ–±—É–µ–º –ø—Ä—è–º–æ–π fetch...';
                return fetch(csvUrl).then(r => r.ok ? r.text() : Promise.reject(new Error('–ü—Ä—è–º–æ–π fetch failed: CORS –∏–ª–∏ 403. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä.')))
                    .catch(e => {
                        throw new Error(`–í—Å–µ –º–µ—Ç–æ–¥—ã failed: ${e.message}. –†–µ—à–µ–Ω–∏–µ: 1) –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (python -m http.server). 2) Excel fallback.`);
                    });
            });
    }
    
    tryFetch(proxies[0])
        .then(csvText => {
            console.log('CSV length:', csvText.length, 'Snippet:', csvText.substring(0, 200));
            if (!csvText || csvText.length < 100) throw new Error('CSV –ø—É—Å—Ç–æ–π –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π.');
            
            const json = parseCSV(csvText);
            const processedJson = simpleFillDown(json, 1);
            
            // Processing (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
            campaigns = [];
            let totalRows = processedJson.length - 1;
            let validRows = 0;
            let skippedRows = 0;
            const newBloggers = new Set();
            const newBooks = new Set();
            
            for (let index = 1; index < processedJson.length; index++) {
                const row = processedJson[index];
                if (row.length < 10) { skippedRows++; continue; }
                const fullBloggerUrl = row[1] ? row[1].toString().trim() : '';
                const bloggerName = extractBloggerName(fullBloggerUrl);
                const bookName = row[9] ? row[9].toString().trim() : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è';
                if (!bloggerName || bloggerName === '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π') { skippedRows++; continue; }
                
                newBloggers.add(bloggerName);
                newBooks.add(bookName);
                
                const date = normalizeDate(row[0]);
                if (date === 'N/A') { skippedRows++; continue; }
                const cost = parseFloat((row[5] || '0').toString().replace(',', '.')) || 0;
                const quantity = parseFloat((row[6] || '0').toString().replace(',', '.')) || 0;
                const profitPerBook = parseFloat((row[7] || '0').toString().replace(',', '.')) || 0;
                const totalProfit = quantity * profitPerBook;
                
                if (cost <= 0 || quantity <= 0 || profitPerBook <= 0) { skippedRows++; continue; }
                
                const { roi, roas, cps } = calculateMetrics(cost, totalProfit, quantity);
                
                let blogger = bloggers.find(b => b.name === bloggerName);
                if (!blogger) {
                    blogger = { id: bloggers.length, name: bloggerName, link: fullBloggerUrl };
                    bloggers.push(blogger);
                } else {
                    blogger.link = fullBloggerUrl;
                }
                
                let book = books.find(bk => bk.name === bookName);
                if (!book) {
                    book = { id: books.length, name: bookName };
                    books.push(book);
                }
                
                campaigns.push({
                    id: campaigns.length,
                    bloggerId: blogger.id,
                    bookId: book.id,
                    date, cost, profitPerBook, quantity, totalProfit,
                    roi, roas, cps
                });
                validRows++;
            }
            
            localStorage.setItem('campaigns', JSON.stringify(campaigns));
            localStorage.setItem('bloggers', JSON.stringify(bloggers));
            localStorage.setItem('books', JSON.stringify(books));
            populateSelects();
            updateFilterSelects();
            const msg = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${validRows} –∏–∑ ${totalRows} (skipped ${skippedRows}). –ë–ª–æ–≥–µ—Ä–æ–≤: ${newBloggers.size}, –∫–Ω–∏–≥: ${newBooks.size}.`;
            document.getElementById('loadStatus').innerHTML = msg;
            console.log(msg);
            
            document.getElementById('filterSection').style.display = campaigns.length > 0 ? 'block' : 'none';
            document.getElementById('noDataMsg').style.display = campaigns.length > 0 ? 'none' : 'block';
            showDataList();
        })
        .catch(error => {
            console.error('Load error:', error);
            document.getElementById('loadStatus').innerHTML = `–û—à–∏–±–∫–∞: ${error.message}. <button onclick="toggleLocalUpload()">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Excel</button>`;
            alert(error.message);
        });
}


        function toggleLocalUpload() {
            document.getElementById('localUploadSection').classList.toggle('hidden');
        }

        function loadExcel() {
            const file = document.getElementById('excelFile').files[0];
            if (!file) return showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.');
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    let json = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false });
                    
                    // Handle merges
                    const merges = ws['!merges'] || [];
                    merges.forEach(m => {
                        const val = json[m.s.r][m.s.c];
                        for (let r = m.s.r; r <= m.e.r; r++) for (let c = m.s.c; c <= m.e.c; c++) if (!json[r][c]) json[r][c] = val;
                    });
                    
                    // Processing like CSV
                    campaigns = [];
                    let valid = 0, skipped = 0;
                    const newBloggers = new Set(), newBooks = new Set();
                    
                    for (let i = 1; i < json.length; i++) {
                        const row = json[i];
                        if (!row || row.length < 10) { skipped++; continue; }
                        const fullUrl = row[1]?.toString().trim() || '';
                        const bloggerName = extractBloggerName(fullUrl);
                        const bookName = row[9]?.toString().trim() || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è';
                        if (!bloggerName || bloggerName === '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π') { skipped++; continue; }
                        
                        newBloggers.add(bloggerName);
                        newBooks.add(bookName);
                        
                        const date = normalizeDate(row[0]);
                        if (date === 'N/A') { skipped++; continue; }
                        const cost = parseFloat(row[5]?.toString().replace(',', '.') || '0');
                        const quantity = parseFloat(row[6]?.toString().replace(',', '.') || '0');
                        const profitPerBook = parseFloat(row[7]?.toString().replace(',', '.') || '0');
                        const totalProfit = quantity * profitPerBook;
                        
                        if (cost <= 0 || quantity <= 0 || profitPerBook <= 0) { skipped++; continue; }
                        
                        const { roi, roas, cps } = calculateMetrics(cost, totalProfit, quantity);
                        
                        let blogger = bloggers.find(b => b.name === bloggerName);
                        if (!blogger) {
                            blogger = { id: bloggers.length, name: bloggerName, link: fullUrl };
                            bloggers.push(blogger);
                        } else blogger.link = fullUrl;
                        
                        let book = books.find(bk => bk.name === bookName);
                        if (!book) {
                            book = { id: books.length, name: bookName };
                            books.push(book);
                        }
                        
                        campaigns.push({ id: campaigns.length, bloggerId: blogger.id, bookId: book.id, date, cost, profitPerBook, quantity, totalProfit, roi, roas, cps });
                        valid++;
                    }
                    
                    localStorage.setItem('campaigns', JSON.stringify(campaigns));
                    localStorage.setItem('bloggers', JSON.stringify(bloggers));
                    localStorage.setItem('books', JSON.stringify(books));
                    populateSelects();
                    updateFilterSelects();
                    document.getElementById('loadStatus').innerHTML = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ Excel: ${valid} –∏–∑ ${json.length - 1} (skipped ${skipped}).`;
                    showDataList();
                    document.getElementById('filterSection').classList.remove('hidden');
                    showToast('Excel –∑–∞–≥—Ä—É–∂–µ–Ω!');
                } catch (e) {
                    console.error(e);
                    showToast('–û—à–∏–±–∫–∞ Excel: ' + e.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Sp—Ä–∞–≤–æ—á–Ω–∏–∫ functions
        function populateSelects() {
            const bloggerSelect = document.getElementById('blogger');
            const bookSelect = document.getElementById('book');
            bloggerSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–≥–µ—Ä–∞</option>';
            bookSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–Ω–∏–≥—É</option>';
            bloggers.forEach(b => {
                bloggerSelect.innerHTML += `<option value="${b.id}">${b.name}</option>`;
            });
            books.forEach(bk => {
                bookSelect.innerHTML += `<option value="${bk.id}">${bk.name}</option>`;
            });
        }

        function updateFilterSelects() {
            const filterBlogger = document.getElementById('filterBlogger');
            const filterBook = document.getElementById('filterBook');
            filterBlogger.innerHTML = '<option value="">–í—Å–µ –±–ª–æ–≥–µ—Ä—ã</option>';
            filterBook.innerHTML = '<option value="">–í—Å–µ –∫–Ω–∏–≥–∏</option>';
            bloggers.forEach(b => {
                filterBlogger.innerHTML += `<option value="${b.id}">${b.name}</option>`;
            });
            books.forEach(bk => {
                filterBook.innerHTML += `<option value="${bk.id}">${bk.name}</option>`;
            });
        }

        function toggleBloggerDir() {
            const dir = document.getElementById('blogger-dir');
            dir.classList.toggle('hidden');
            if (!dir.classList.contains('hidden')) showBloggerTable();
        }

        function showBloggerTable() {
            let html = '<table class="dir-table"><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–°—Å—ã–ª–∫–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';
            bloggers.forEach(b => {
                const link = b.link || '';
                const hasLink = link.trim() !== '';
                html += `<tr>
                    <td>${b.name}</td>
                    <td><a href="${link}" target="_blank" style="color: ${hasLink ? '#007bff' : '#6c757d'}">${hasLink ? link : '–ù–µ—Ç —Å—Å—ã–ª–∫–∏'}</a> ${hasLink ? `<button class="copy-btn" onclick="copyLinkToClipboard('${link.replace(/'/g, "\\'")}')">üìã</button>` : ''}</td>
                    <td><button class="edit-btn" onclick="editBlogger(${b.id})">–†–µ–¥.</button> <button class="delete-btn" onclick="deleteBlogger(${b.id})">–£–¥–∞–ª.</button></td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('bloggerTableContainer').innerHTML = html;
        }

        function addBlogger() {
            editingBloggerId = null;
            document.getElementById('bloggerModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–≥–µ—Ä–∞';
            document.getElementById('bloggerName').value = '';
            document.getElementById('bloggerLink').value = '';
            document.getElementById('bloggerModal').style.display = 'block';
        }

        function editBlogger(id) {
            editingBloggerId = id;
            const b = bloggers.find(b => b.id === id);
            document.getElementById('bloggerModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–≥–µ—Ä–∞';
            document.getElementById('bloggerName').value = b.name;
            document.getElementById('bloggerLink').value = b.link || '';
            document.getElementById('bloggerModal').style.display = 'block';
        }

        function saveBlogger() {
            const name = document.getElementById('bloggerName').value.trim();
            const link = document.getElementById('bloggerLink').value.trim();
            if (!name) return showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ.');
            if (editingBloggerId !== null) {
                const b = bloggers.find(b => b.id === editingBloggerId);
                b.name = name;
                b.link = link;
            } else {
                const newId = bloggers.length;
                bloggers.push({ id: newId, name, link });
            }
            localStorage.setItem('bloggers', JSON.stringify(bloggers));
            populateSelects();
            updateFilterSelects();
            closeBloggerModal();
            showBloggerTable();
            showToast('–ë–ª–æ–≥–µ—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
        }

        function deleteBlogger(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –±–ª–æ–≥–µ—Ä–∞? –≠—Ç–æ —É–¥–∞–ª–∏—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏.')) return;
            bloggers = bloggers.filter(b => b.id !== id);
            campaigns = campaigns.filter(c => c.bloggerId !== id);
            localStorage.setItem('bloggers', JSON.stringify(bloggers));
            localStorage.setItem('campaigns', JSON.stringify(campaigns));
            populateSelects();
            updateFilterSelects();
            showBloggerTable();
            showDataList();
            showToast('–ë–ª–æ–≥–µ—Ä —É–¥–∞–ª—ë–Ω.');
        }

        function closeBloggerModal() {
            document.getElementById('bloggerModal').style.display = 'none';
            editingBloggerId = null;
        }

        // Book functions (analogous)
        function toggleBookDir() {
            const dir = document.getElementById('book-dir');
            dir.classList.toggle('hidden');
            if (!dir.classList.contains('hidden')) showBookTable();
        }

        function showBookTable() {
            let html = '<table class="dir-table"><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';
            books.forEach(bk => {
                html += `<tr>
                    <td>${bk.name}</td>
                    <td><button class="edit-btn" onclick="editBook(${bk.id})">–†–µ–¥.</button> <button class="delete-btn" onclick="deleteBook(${bk.id})">–£–¥–∞–ª.</button></td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('bookTableContainer').innerHTML = html;
        }

        function addBook() {
            editingBookId = null;
            document.getElementById('bookModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É';
            document.getElementById('bookName').value = '';
            document.getElementById('bookModal').style.display = 'block';
        }

        function editBook(id) {
            editingBookId = id;
            const bk = books.find(b => b.id === id);
            document.getElementById('bookModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–∏–≥—É';
            document.getElementById('bookName').value = bk.name;
            document.getElementById('bookModal').style.display = 'block';
        }

        function saveBook() {
            const name = document.getElementById('bookName').value.trim();
            if (!name) return showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ.');
            if (editingBookId !== null) {
                const bk = books.find(b => b.id === editingBookId);
                bk.name = name;
            } else {
                const newId = books.length;
                books.push({ id: newId, name });
            }
            localStorage.setItem('books', JSON.stringify(books));
            populateSelects();
            updateFilterSelects();
            closeBookModal();
            showBookTable();
            showToast('–ö–Ω–∏–≥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
        }

        function deleteBook(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É? –≠—Ç–æ —É–¥–∞–ª–∏—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏.')) return;
            books = books.filter(b => b.id !== id);
            campaigns = campaigns.filter(c => c.bookId !== id);
            localStorage.setItem('books', JSON.stringify(books));
            localStorage.setItem('campaigns', JSON.stringify(campaigns));
            populateSelects();
            updateFilterSelects();
            showBookTable();
            showDataList();
            showToast('–ö–Ω–∏–≥–∞ —É–¥–∞–ª–µ–Ω–∞.');
        }

        function closeBookModal() {
            document.getElementById('bookModal').style.display = 'none';
            editingBookId = null;
        }

        // Campaign functions
        function addCampaign() {
            const date = document.getElementById('date').value;
            const bloggerId = parseInt(document.getElementById('blogger').value);
            const bookId = parseInt(document.getElementById('book').value);
            const cost = parseFloat(document.getElementById('cost').value);
            const profitPerBook = parseFloat(document.getElementById('profitPerBook').value);
            const quantity = parseInt(document.getElementById('quantity').value);
            if (!date || isNaN(bloggerId) || isNaN(bookId) || cost <= 0 || profitPerBook <= 0 || quantity <= 0) {
                return showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.');
            }
            const totalProfit = quantity * profitPerBook;
            const { roi, roas, cps } = calculateMetrics(cost, totalProfit, quantity);
            const newId = campaigns.length;
            campaigns.push({ id: newId, bloggerId, bookId, date, cost, profitPerBook, quantity, totalProfit, roi, roas, cps });
            localStorage.setItem('campaigns', JSON.stringify(campaigns));
            clearAddForm();
            showDataList();
            showToast('–ö–∞–º–ø–∞–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
        }

        function clearAddForm() {
            document.getElementById('date').value = '';
            document.getElementById('blogger').value = '';
            document.getElementById('book').value = '';
            document.getElementById('cost').value = '';
            document.getElementById('profitPerBook').value = '';
            document.getElementById('quantity').value = '';
            document.getElementById('effPreview').innerHTML = '';
        }

        function editCampaign(id) {
            editingCampaignId = id;
            const c = campaigns.find(c => c.id === id);
            if (!c) return;
            document.getElementById('editDate').value = c.date;
            document.getElementById('editBlogger').value = c.bloggerId;
            document.getElementById('editBook').value = c.bookId;
            document.getElementById('editCost').value = c.cost;
            document.getElementById('editProfitPerBook').value = c.profitPerBook;
            document.getElementById('editQuantity').value = c.quantity;
            document.getElementById('editCampaignId').value = id;
            calculateEditEff();
            document.getElementById('campaignModal').style.display = 'block';
        }

        function populateEditSelects() {
            const editBlogger = document.getElementById('editBlogger');
            const editBook = document.getElementById('editBook');
            editBlogger.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>';
            editBook.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>';
            bloggers.forEach(b => {
                editBlogger.innerHTML += `<option value="${b.id}">${b.name}</option>`;
            });
            books.forEach(bk => {
                editBook.innerHTML += `<option value="${bk.id}">${bk.name}</option>`;
            });
        }

        function saveCampaignEdit() {
            const id = parseInt(document.getElementById('editCampaignId').value);
            const date = document.getElementById('editDate').value;
            const bloggerId = parseInt(document.getElementById('editBlogger').value);
            const bookId = parseInt(document.getElementById('editBook').value);
            const cost = parseFloat(document.getElementById('editCost').value);
            const profitPerBook = parseFloat(document.getElementById('editProfitPerBook').value);
            const quantity = parseInt(document.getElementById('editQuantity').value);
            if (!date || isNaN(bloggerId) || isNaN(bookId) || cost <= 0 || profitPerBook <= 0 || quantity <= 0) {
                return showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.');
            }
            const totalProfit = quantity * profitPerBook;
            const { roi, roas, cps } = calculateMetrics(cost, totalProfit, quantity);
            const c = campaigns.find(c => c.id === id);
            if (c) {
                c.date = date;
                c.bloggerId = bloggerId;
                c.bookId = bookId;
                c.cost = cost;
                c.profitPerBook = profitPerBook;
                c.quantity = quantity;
                c.totalProfit = totalProfit;
                c.roi = roi;
                c.roas = roas;
                c.cps = cps;
            }
            localStorage.setItem('campaigns', JSON.stringify(campaigns));
            closeCampaignModal();
            showDataList();
            showToast('–ö–∞–º–ø–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
        }

        function closeCampaignModal() {
            document.getElementById('campaignModal').style.display = 'none';
            editingCampaignId = null;
        }

        // Filter and sort
        function applyFilters() {
            filters.dateFrom = document.getElementById('filterDateFrom').value;
            filters.dateTo = document.getElementById('filterDateTo').value;
            filters.bloggerId = parseInt(document.getElementById('filterBlogger').value) || null;
            filters.bookId = parseInt(document.getElementById('filterBook').value) || null;
            filters.roiMin = parseFloat(document.getElementById('filterROIMin').value) || null;
            filters.roiMax = parseFloat(document.getElementById('filterROIMax').value) || null;
            filters.roasMin = parseFloat(document.getElementById('filterROASMin').value) || null;
            filters.roasMax = parseFloat(document.getElementById('filterROASMax').value) || null;
            filters.cpsMin = parseFloat(document.getElementById('filterCPSMin').value) || null;
            filters.cpsMax = parseFloat(document.getElementById('filterCPSMax').value) || null;
            showDataList();
            showToast('–§–∏–ª—å—Ç—Ä—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã.');
        }

        function clearFilters() {
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterBlogger').value = '';
            document.getElementById('filterBook').value = '';
            document.getElementById('filterROIMin').value = '';
            document.getElementById('filterROIMax').value = '';
            document.getElementById('filterROASMin').value = '';
            document.getElementById('filterROASMax').value = '';
            document.getElementById('filterCPSMin').value = '';
            document.getElementById('filterCPSMax').value = '';
            filters = {};
            showDataList();
            showToast('–§–∏–ª—å—Ç—Ä—ã –æ—á–∏—â–µ–Ω—ã.');
        }

        function toggleCheatSheet() {
            const details = document.getElementById('cheatDetails');
            details.style.display = details.style.display === 'none' ? 'block' : 'none';
        }

        function sortBy(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            showDataList();
        }

        function showDataList() {
            let filtered = campaigns.filter(c => {
                if (filters.dateFrom && c.date < filters.dateFrom) return false;
                if (filters.dateTo && c.date > filters.dateTo) return false;
                if (filters.bloggerId && c.bloggerId !== filters.bloggerId) return false;
                if (filters.bookId && c.bookId !== filters.bookId) return false;
                if (filters.roiMin && c.roi < filters.roiMin) return false;
                if (filters.roiMax && c.roi > filters.roiMax) return false;
                if (filters.roasMin && c.roas < filters.roasMin) return false;
                if (filters.roasMax && c.roas > filters.roasMax) return false;
                if (filters.cpsMin && c.cps < filters.cpsMin) return false;
                if (filters.cpsMax && c.cps > filters.cpsMax) return false;
                return true;
            });

            // Sort
            filtered.sort((a, b) => {
                let valA = a[sortColumn], valB = b[sortColumn];
                if (sortColumn === 'date') {
                    valA = new Date(valA); valB = new Date(valB);
                } else if (['cost', 'quantity', 'totalProfit', 'roi', 'roas', 'cps'].includes(sortColumn)) {
                    valA = parseFloat(valA); valB = parseFloat(valB);
                }
                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // Render
            let html = '<table class="data-table"><thead><tr>';
            const headers = [
                { key: 'date', label: '–î–∞—Ç–∞', sortable: true },
                { key: 'bloggerName', label: '–ë–ª–æ–≥–µ—Ä', sortable: false },
                { key: 'bookName', label: '–ö–Ω–∏–≥–∞', sortable: false },
                { key: 'cost', label: '–°—Ç–æ–∏–º–æ—Å—Ç—å (—Ä—É–±.)', sortable: true },
                { key: 'quantity', label: '–ö–æ–ª-–≤–æ', sortable: true },
                { key: 'totalProfit', label: '–ß–ü –≤—Å–µ–≥–æ (—Ä—É–±.)', sortable: true },
                { key: 'roi', label: 'ROI (%)', sortable: true },
                { key: 'roas', label: 'ROAS', sortable: true },
                { key: 'cps', label: 'CPS (—Ä—É–±./—à—Ç.)', sortable: true },
                { key: 'actions', label: '–î–µ–π—Å—Ç–≤–∏—è', sortable: false }
            ];
            headers.forEach(h => {
                html += `<th onclick="${h.sortable ? `sortBy('${h.key}')` : ''}">${h.label} ${sortColumn === h.key ? `<span class="sort-arrow">${sortDirection === 'asc' ? '‚Üë' : '‚Üì'}</span>` : ''}</th>`;
            });
            html += '</tr></thead><tbody>';

            if (filtered.length === 0) {
                html += '<tr><td colspan="10" class="no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º.</td></tr>';
            } else {
                filtered.forEach(c => {
                    const blogger = bloggers.find(b => b.id === c.bloggerId);
                    const book = books.find(bk => bk.id === c.bookId);
                    html += `<tr>
                        <td>${c.date}</td>
                        <td>${blogger ? blogger.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'}</td>
                        <td>${book ? book.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'}</td>
                        <td>${formatNumber(c.cost)}</td>
                        <td>${c.quantity}</td>
                        <td>${formatNumber(c.totalProfit)}</td>
                        <td>${c.roi}%</td>
                        <td>${c.roas}</td>
                        <td>${c.cps}</td>
                        <td><button class="edit-btn" onclick="editCampaign(${c.id})">–†–µ–¥.</button> <button class="delete-btn" onclick="deleteCampaign(${c.id})">–£–¥–∞–ª.</button></td>
                    </tr>`;
                });
            }
            html += '</tbody></table>';

            document.getElementById('tableContainer').innerHTML = html;
            document.getElementById('noDataMsg').style.display = filtered.length > 0 ? 'none' : 'block';
            document.getElementById('sortInfo').innerHTML = `–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: ${sortColumn} (${sortDirection}) | –ù–∞–π–¥–µ–Ω–æ: ${filtered.length} –∏–∑ ${campaigns.length}`;
        }

        function deleteCampaign(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é?')) return;
            campaigns = campaigns.filter(c => c.id !== id);
            localStorage.setItem('campaigns', JSON.stringify(campaigns));
            showDataList();
            showToast('–ö–∞–º–ø–∞–Ω–∏—è —É–¥–∞–ª–µ–Ω–∞.');
        }

        function analyzeTop() {
            if (campaigns.length === 0) return showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.');
            const bloggerStats = {};
            bloggers.forEach(b => {
                const camp = campaigns.filter(c => c.bloggerId === b.id);
                if (camp.length === 0) return;
                const totalCost = camp.reduce((sum, c) => sum + c.cost, 0);
                const totalProfit = camp.reduce((sum, c) => sum + c.totalProfit, 0);
                const totalQty = camp.reduce((sum, c) => sum + c.quantity, 0);
                const avgRoi = camp.reduce((sum, c) => sum + c.roi, 0) / camp.length;
                const avgRoas = totalProfit / totalCost;
                const avgCps = totalCost / totalQty;
                bloggerStats[b.name] = { campaigns: camp.length, totalCost, totalProfit, totalQty, avgRoi: Math.round(avgRoi), avgRoas: parseFloat(avgRoas.toFixed(2)), avgCps: parseFloat(avgCps.toFixed(2)) };
            });

            const top = Object.entries(bloggerStats)
                .sort(([,a], [,b]) => b.avgRoas - a.avgRoas)
                .slice(0, 10);

            let html = '<table><thead><tr><th>–ë–ª–æ–≥–µ—Ä</th><th>–ö–∞–º–ø–∞–Ω–∏–π</th><th>–û–±—â–∏–π ROAS</th><th>–°—Ä–µ–¥–Ω–∏–π ROI (%)</th><th>–°—Ä–µ–¥–Ω–∏–π CPS (—Ä—É–±.)</th></tr></thead><tbody>';
            top.forEach(([name, stats]) => {
                html += `<tr>
                    <td>${name}</td>
                    <td>${stats.campaigns}</td>
                    <td>${stats.avgRoas}</td>
                    <td>${stats.avgRoi}</td>
                    <td>${stats.avgCps}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('topTableContainer').innerHTML = html;
            document.getElementById('noTopMsg').style.display = 'none';
            showToast(`–¢–æ–ø-–∞–Ω–∞–ª–∏–∑ –≥–æ—Ç–æ–≤ (–ª—É—á—à–∏–π: ${top[0]?.[0]} —Å ROAS ${top[0]?.[1].avgRoas}).`);
        }

        // Reset functions
        function openResetModal() {
            document.getElementById('resetModal').style.display = 'block';
            document.getElementById('resetPassword').value = '';
        }

        function closeResetModal() {
            document.getElementById('resetModal').style.display = 'none';
        }

        function resetData() {
            const pass = document.getElementById('resetPassword').value;
            if (pass !== '628502') return showToast('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.');
            localStorage.removeItem('campaigns');
            localStorage.removeItem('bloggers');
            localStorage.removeItem('books');
            campaigns = [];
            bloggers = [];
            books = [];
            populateSelects();
            updateFilterSelects();
            showDataList();
            closeResetModal();
            document.getElementById('filterSection').classList.add('hidden');
            document.getElementById('loadStatus').innerHTML = '–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã.';
            showToast('–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã!');
            location.reload();
        }

        // Modal close on outside click
        window.onclick = e => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
                editingBloggerId = editingBookId = editingCampaignId = null;
            }
        };

        // Init
        populateSelects();
        updateFilterSelects();
        if (campaigns.length > 0) {
            showDataList();
            document.getElementById('filterSection').classList.remove('hidden');
        }
    </script>
</body>
</html>
