<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализатор блогеров (v7.3: полная поддержка Excel)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SheetJS для полной поддержки Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #4CAF50;
            --secondary: #2196F3;
            --danger: #f44336;
            --warning: #ff9800;
            --light: #f5f5f5;
            --dark: #333;
            --border: #ddd;
            --text-large: 16px;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: var(--text-large);
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { text-align: center; color: var(--primary); margin-bottom: 30px; font-size: 2.5em; }
        .section {
            background: white;
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .section:hover { transform: translateY(-2px); }
        .hidden { display: none; }
        .toggle-btn { cursor: pointer; color: var(--secondary); font-weight: bold; margin-right: 10px; }
        .add-btn { 
            background: linear-gradient(45deg, var(--primary), #45a049);
            color: white; 
            padding: 10px 15px; 
            border: none; 
            border-radius: 20px; 
            cursor: pointer; 
            font-size: 16px; 
            transition: all 0.3s ease;
        }
        .add-btn:hover { box-shadow: 0 4px 8px rgba(76,175,80,0.3); transform: scale(1.05); }
        .add-btn:disabled { background: var(--border); cursor: not-allowed; transform: none; }
        input, select, button {
            margin: 5px; 
            padding: 12px; 
            border: 1px solid var(--border); 
            border-radius: 6px; 
            font-size: var(--text-large);
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        input:focus, select:focus { outline: none; border-color: var(--secondary); box-shadow: 0 0 5px rgba(33,150,243,0.3); }
        input:disabled, select:disabled { background: #f0f0f0; cursor: not-allowed; }
        .form-group { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 15px; 
            align-items: center; 
            margin-bottom: 15px; 
            font-size: var(--text-large);
        }
        .form-group label { min-width: 120px; font-weight: bold; color: var(--dark); }
        .file-info { font-size: 14px; color: var(--secondary); margin-left: 10px; }
        .table-container {
            overflow-x: auto; 
            margin-top: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 800px; 
            background: white;
            font-size: 14px; 
        }
        th, td { 
            padding: 15px 12px; 
            text-align: left; 
            border-bottom: 1px solid var(--border); 
            word-wrap: break-word; 
            max-width: 150px; 
            vertical-align: top;
        }
        th { 
            background: linear-gradient(45deg, var(--primary), #45a049); 
            color: white; 
            font-weight: bold; 
            position: sticky; top: 0;
            z-index: 10;
            white-space: nowrap; 
        }
        tr:hover { background: var(--light); }
        .metrics { 
            font-weight: bold; 
            font-size: 16px; 
            padding: 10px; 
        }
        .positive { color: var(--primary); }
        .negative { color: var(--danger); }
        .neutral { color: var(--warning); }
        .metrics-group { 
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .metric-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
            border-bottom: 1px dotted var(--border);
        }
        .metric-label { font-weight: bold; color: var(--dark); }
        .form-popup { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 50%; 
            top: 50%; 
            transform: translate(-50%, -50%); 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
            min-width: 350px; 
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlide 0.3s ease;
        }
        @keyframes modalSlide { from { opacity: 0; transform: translate(-50%, -60%); } to { opacity: 1; transform: translate(-50%, -50%); } }
        .form-container { display: flex; flex-direction: column; gap: 15px; }
        .form-container input { width: 100%; box-sizing: border-box; font-size: var(--text-large); }
        .btn-close { background: var(--danger); color: white; margin-left: 10px; }
        .btn-close:hover { background: #d32f2f; }
        .tabs { 
            display: flex; 
            background: var(--light); 
            border-radius: 8px 8px 0 0; 
            overflow: hidden; 
            margin-bottom: 0; 
            font-size: var(--text-large);
        }
        .tab-btn { 
            flex: 1; 
            padding: 15px; 
            background: none; 
            border: none; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.3s;
        }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .blogger-card, .book-card { 
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: box-shadow 0.3s;
            font-size: var(--text-large);
        }
        .blogger-card:hover, .book-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 10px;
            font-size: 18px; 
        }
        .card-details {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        .card-actions {
            display: flex;
            gap: 10px;
        }
        .card-actions button {
            padding: 8px 12px;
            font-size: 14px;
        }
        .progress { width: 100%; height: 8px; background: var(--light); border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .progress-bar { 
            height: 100%; 
            background: linear-gradient(90deg, var(--primary), var(--secondary)); 
            transition: width 0.3s ease-in-out; 
            width: 0%; 
            border-radius: 4px;
        }
        .progress-text { font-size: 14px; color: var(--dark); margin-top: 5px; text-align: center; }
        .tooltip { 
            position: relative; 
            display: inline-block; 
            border-bottom: 1px dotted #ccc; 
            cursor: help; 
            font-size: var(--text-large);
        }
        .tooltip .tooltiptext { 
            visibility: hidden; 
            background: var(--dark); 
            color: white; 
            text-align: center; 
            padding: 8px 12px; 
            border-radius: 6px; 
            position: absolute; 
            z-index: 1; 
            bottom: 125%; 
            left: 50%; 
            margin-left: -80px; 
            opacity: 0; 
            transition: opacity 0.3s;
            white-space: nowrap; 
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--warning);
            font-size: 18px;
            font-style: italic;
        }
        .success-message {
            background: var(--primary);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        .error-message {
            background: var(--danger);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--light);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @media (max-width: 768px) {
            body { font-size: 14px; padding: 10px; }
            .form-group { flex-direction: column; align-items: stretch; }
            .form-group label { min-width: auto; }
            table { font-size: 12px; min-width: 600px; }
            th, td { padding: 10px 8px; max-width: 120px; }
            .card-details { grid-template-columns: 1fr; }
            .metrics { font-size: 14px; }
            .tabs { flex-direction: column; }
            .tab-btn { border-bottom: 1px solid var(--border); }
        }
        .status-indicator {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-ready { background: var(--light); color: var(--primary); }
        .status-loading { background: var(--warning); color: white; }
        .status-success { background: var(--primary); color: white; }
        .status-error { background: var(--danger); color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-chart-line"></i> Анализатор блогеров (v7.3: полная поддержка Excel)</h1>
        <p style="text-align: center; color: var(--secondary); font-size: 14px;">
            <i class="fas fa-check-circle"></i> SheetJS подключен — Excel файлы загружаются автоматически!
        </p>

        <!-- Статус загрузки -->
        <div style="text-align: center; margin-bottom: 20px;">
            <div class="status-indicator status-ready" id="loadStatus">
                <i class="fas fa-check"></i> Готов к загрузке
            </div>
        </div>

        <!-- Вкладки -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="load" onclick="switchTab('load')"><i class="fas fa-upload"></i> Загрузка</button>
            <button class="tab-btn" data-tab="bloggers" onclick="switchTab('bloggers')"><i class="fas fa-users"></i> Блоггеры (<span id="bloggerCount">0</span>)</button>
            <button class="tab-btn" data-tab="books" onclick="switchTab('books')"><i class="fas fa-book"></i> Книги (<span id="bookCount">0</span>)</button>
            <button class="tab-btn" data-tab="campaigns" onclick="switchTab('campaigns')"><i class="fas fa-plus"></i> Кампании</button>
            <button class="tab-btn" data-tab="data" onclick="switchTab('data')"><i class="fas fa-table"></i> Данные (<span id="campaignCount">0</span>)</button>
            <button class="tab-btn" data-tab="analysis" onclick="switchTab('analysis')"><i class="fas fa-analytics"></i> Анализ</button>
        </div>

        <!-- Загрузка данных -->
        <div id="load" class="section tab-content active">
            <h2><i class="fas fa-cloud-download-alt"></i> Загрузка данных</h2>
            
            <!-- Google Sheets -->
            <div class="form-group">
                <label><i class="fas fa-file-csv"></i> Google Sheets (CSV):</label>
                <input type="text" id="csvUrl" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv" size="60" 
                       value="https://docs.google.com/spreadsheets/d/e/2PACX-1v.../pub?output=csv">
                <div class="status-indicator status-ready" style="margin-left: 10px;">Готов</div>
            </div>
            <button class="add-btn" onclick="loadFromSheets()" id="sheetsBtn">
                <i class="fas fa-file-csv"></i> Загрузить из Sheets
            </button>

            <!-- Excel -->
            <div class="form-group" style="margin-top: 20px;">
                <label><i class="fas fa-file-excel"></i> Excel файл (.xlsx, .xls):</label>
                <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="loadFromExcel(event)" style="margin-right: 10px;">
                <button class="add-btn" onclick="document.getElementById('excelFile').click()">
                    <i class="fas fa-file-excel"></i> Выбрать Excel файл
                </button>
                <div class="file-info" id="fileInfo" style="display: none;"></div>
                <div class="status-indicator status-ready" style="margin-left: 10px;">Готов</div>
            </div>

            <!-- Прогресс -->
            <div class="progress" id="progressContainer" style="display: none;">
                <div class="progress-bar" id="progressBar"></div>
                <div class="progress-text" id="progressText">Подготовка...</div>
            </div>
            
            <div id="loadMessage"></div>
            
            <details style="margin-top: 20px;">
                <summary><i class="fas fa-info-circle"></i> Формат данных</summary>
                <div style="padding: 15px; background: var(--light); border-radius: 6px; font-size: 14px;">
                    <p><strong>Обязательные колонки:</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Дата (YYYY-MM-DD)</li>
                        <li>Блогер (имя или ник)</li>
                        <li>Книга (название)</li>
                        <li>Стоимость (руб.)</li>
                        <li>ЧП с книги (руб.)</li>
                        <li>Количество (шт.)</li>
                    </ul>
                    <p><small>Колонки могут называться по-разному. Система автоматически найдет соответствие.</small></p>
                </div>
            </details>
        </div>

        <!-- Блоггеры -->
        <div id="bloggers" class="section tab-content">
            <h2><i class="fas fa-users"></i> Справочник блогеров</h2>
            <div class="form-group">
                <span class="toggle-btn" onclick="toggleSection('bloggersList')"><i class="fas fa-eye-slash"></i> Скрыть список</span>
                <button class="add-btn" onclick="showAddBlogger()"><i class="fas fa-user-plus"></i> Добавить блогера</button>
                <button class="btn-close" onclick="deleteAllBloggers()" style="margin-left: 10px;"><i class="fas fa-trash"></i> Удалить всех</button>
            </div>
            <div id="bloggersList">
                <div class="empty-state">
                    <i class="fas fa-users" style="font-size: 48px; color: var(--warning); margin-bottom: 10px;"></i>
                    <p>Нет блогеров. Загрузите данные или добавьте вручную.</p>
                    <button class="add-btn" onclick="showAddBlogger()" style="padding: 8px 15px; font-size: 14px; margin-top: 10px;">
                        <i class="fas fa-user-plus"></i> Добавить первого блогера
                    </button>
                </div>
            </div>
        </div>

        <!-- Книги -->
        <div id="books" class="section tab-content">
            <h2><i class="fas fa-book"></i> Справочник книг</h2>
            <div class="form-group">
                <span class="toggle-btn" onclick="toggleSection('booksList')"><i class="fas fa-eye-slash"></i> Скрыть список</span>
                <button class="add-btn" onclick="showAddBook()"><i class="fas fa-book-open"></i> Добавить книгу</button>
                <button class="btn-close" onclick="deleteAllBooks()" style="margin-left: 10px;"><i class="fas fa-trash"></i> Удалить все</button>
            </div>
            <div id="booksList">
                <div class="empty-state">
                    <i class="fas fa-book" style="font-size: 48px; color: var(--warning); margin-bottom: 10px;"></i>
                    <p>Нет книг. Загрузите данные или добавьте вручную.</p>
                    <button class="add-btn" onclick="showAddBook()" style="padding: 8px 15px; font-size: 14px; margin-top: 10px;">
                        <i class="fas fa-book-open"></i> Добавить первую книгу
                    </button>
                </div>
            </div>
        </div>

        <!-- Кампании -->
        <div id="campaigns" class="section tab-content">
            <h2><i class="fas fa-plus-circle"></i> Добавить новую кампанию</h2>
            <div class="form-group">
                <label>Дата кампании:</label> 
                <input type="date" id="campaignDate">
                <label>Блогер:</label> 
                <select id="campaignBlogger">
                    <option value="">Выберите блогера</option>
                </select>
            </div>
            <div class="form-group">
                <label>Книга:</label> 
                <select id="campaignBook">
                    <option value="">Выберите книгу</option>
                </select>
                <label>Стоимость (руб.):</label> 
                <input type="number" id="campaignCost" min="0" step="0.01" placeholder="0.00">
            </div>
            <div class="form-group">
                <label>ЧП с книги (руб.):</label> 
                <input type="number" id="campaignCP" min="0" step="0.01" placeholder="0.00">
                <label>Количество (шт.):</label> 
                <input type="number" id="campaignQty" min="0" placeholder="0">
            </div>
            <div class="form-group" style="justify-content: flex-start;">
                <button class="add-btn" onclick="addCampaign()" id="addCampaignBtn">
                    <i class="fas fa-plus"></i> Добавить кампанию
                </button>
                <button class="btn-close" onclick="clearCampaignForm()" style="margin-left: 10px;">
                    <i class="fas fa-eraser"></i> Очистить форму
                </button>
            </div>
        </div>

        <!-- Данные -->
        <div id="data" class="section tab-content">
            <h2><i class="fas fa-table"></i> Все кампании</h2>
            <div class="form-group">
                <button class="add-btn" onclick="updateList()"><i class="fas fa-sync-alt"></i> Обновить таблицу</button>
                <button class="add-btn" onclick="applyFilters()"><i class="fas fa-filter"></i> Применить фильтры</button>
                <button class="btn-close" onclick="clearFilters()" style="margin-left: 10px;"><i class="fas fa-eraser"></i> Сбросить фильтры</button>
                <button class="btn-close" onclick="deleteAllCampaigns()" style="margin-left: 10px;"><i class="fas fa-trash"></i> Удалить все</button>
            </div>
            
            <!-- Фильтры -->
            <div style="background: var(--light); padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h3 style="margin-top: 0;"><i class="fas fa-filter"></i> Фильтры</h3>
                <div class="form-group">
                    <label>Дата от:</label> <input type="date" id="filterDateFrom">
                    <label>Дата до:</label> <input type="date" id="filterDateTo">
                </div>
                <div class="form-group">
                    <label>Блогер:</label> 
                    <select id="filterBlogger">
                        <option value="">Все блогеры</option>
                    </select>
                    <label>Книга:</label> 
                    <select id="filterBook">
                        <option value="">Все книги</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ROI от (%):</label> <input type="number" id="filterROIMin" min="-100" step="1" placeholder="-100">
                    <label>ROI до (%):</label> <input type="number" id="filterROIMax" step="1" placeholder="1000">
                </div>
                <div class="form-group">
                    <label>ROAS от:</label> <input type="number" id="filterROASMin" min="0" step="0.1" placeholder="0">
                    <label>ROAS до:</label> <input type="number" id="filterROASMax" step="0.1" placeholder="10">
                </div>
                <div class="form-group">
                    <label>CPS от (руб.):</label> <input type="number" id="filterCPSMin" min="0" step="0.01" placeholder="0">
                    <label>CPS до (руб.):</label> <input type="number" id="filterCPSMax" step="0.01" placeholder="1000">
                </div>
            </div>

            <div class="table-container" id="dataList">
                <div class="empty-state">
                    <i class="fas fa-table" style="font-size: 48px; color: var(--warning); margin-bottom: 10px;"></i>
                    <p>Нет данных для отображения</p>
                    <p style="font-size: 14px; color: var(--dark);">
                        Загрузите Excel/CSV файл или <a href="#" onclick="switchTab('campaigns'); return false;" style="color: var(--secondary);">добавьте кампанию вручную</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Анализ -->
        <div id="analysis" class="section tab-content">
            <h2><i class="fas fa-chart-bar"></i> Анализ эффективности</h2>
            <div class="form-group">
                <button class="add-btn" onclick="analyzeTop()" id="analyzeBtn"><i class="fas fa-magic"></i> Проанализировать топ-10</button>
                <button class="add-btn" onclick="showSummary()" style="margin-left: 10px;"><i class="fas fa-chart-pie"></i> Общая сводка</button>
                <button class="btn-close" onclick="exportData()" style="margin-left: 10px;"><i class="fas fa-download"></i> Экспорт</button>
            </div>
            <div id="topBloggers" style="min-height: 200px;">
                <div class="empty-state">
                    <i class="fas fa-chart-bar" style="font-size: 48px; color: var(--warning); margin-bottom: 10px;"></i>
                    <p>Нажмите "Проанализировать" для построения топ-10</p>
                </div>
            </div>
            
            <!-- Шпаргалка -->
            <details style="margin-top: 20px;">
                <summary><i class="fas fa-info-circle"></i> 📋 Шпаргалка по метрикам</summary>
                <div style="padding: 15px; background: var(--light); border-radius: 6px; font-size: var(--text-large);">
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px;">
                        <div>
                            <h4 style="margin-top: 0; color: var(--primary);"><strong>ROI (%)</strong></h4>
                            <p><code>(Прибыль - Затраты) / Затраты × 100</code></p>
                            <p class="tooltip">>100% <span class="tooltiptext">Отлично! Прибыль в 2+ раза превышает затраты</span></p>
                            <p class="tooltip">>500% <span class="tooltiptext">Супер! 6x отдача от вложений</span></p>
                            <p class="negative">&lt;0% <span class="tooltiptext">Убыток, пересмотрите стратегию</span></p>
                        </div>
                        <div>
                            <h4 style="margin-top: 0; color: var(--secondary);"><strong>ROAS</strong></h4>
                            <p><code>Прибыль / Затраты</code></p>
                            <p class="tooltip">>3 <span class="tooltiptext">Отлично! Каждый рубль приносит 3+ рубля прибыли</span></p>
                            <p class="tooltip">>5 <span class="tooltiptext">Идеально! 5x отдача</span></p>
                            <p class="negative">&lt;1 <span class="tooltiptext">Убыточно</span></p>
                        </div>
                        <div>
                            <h4 style="color: var(--warning);"><strong>CPS (руб./шт.)</strong></h4>
                            <p><code>Затраты / Количество</code></p>
                            <p class="tooltip">&lt;ЧП <span class="tooltiptext">Выгодно! Стоимость привлечения ниже прибыли с единицы</span></p>
                            <p class="tooltip">=ЧП <span class="tooltiptext">Нулевая прибыль, только покрытие затрат</span></p>
                            <p class="negative">&gt;ЧП <span class="tooltiptext">Убыточно на единицу</span></p>
                        </div>
                    </div>
                    <p style="margin-top: 15px; font-style: italic; color: var(--dark);">
                        <strong>Пример успеха:</strong> ROI=1869%, ROAS=19.69 (logoped.arshinova) — каждая 1 рубль вложений принесла 19.69 руб. прибыли!
                    </p>
                </div>
            </details>
        </div>

        <!-- Сброс -->
        <div class="section" style="text-align: center; margin-top: 30px; padding: 20px; background: #fff3cd; border: 1px solid var(--warning); border-radius: 8px;">
            <h3 style="color: var(--warning); margin-top: 0;"><i class="fas fa-exclamation-triangle"></i> ⚠️ Сброс данных</h3>
            <p style="color: var(--dark);">Это действие <strong>необратимо</strong> удалит всех блогеров, книги и кампании.</p>
            <button class="btn-close" onclick="showReset()" style="padding: 12px 20px; font-size: 16px; margin: 10px;">
                <i class="fas fa-bomb"></i> <strong>Сбросить ВСЁ</strong>
            </button>
            <p style="font-size: 12px; color: var(--warning); margin-top: 10px;">
                <strong>Пароль:</strong> <code>admin</code> (для безопасности измените в коде)
            </p>
        </div>

        <!-- Модальные окна -->
        <div id="addBloggerModal" class="form-popup">
            <div class="form-container">
                <h3><i class="fas fa-user-edit"></i> <span id="bloggerModalTitle">Добавить</span> блогера</h3>
                <label>Название блогера <span style="color: var(--danger);">*</span>:</label>
                <input type="text" id="bloggerName" placeholder="Например: logoped.arshinova" maxlength="100" required>
                <label>Ссылка (Telegram/Instagram):</label>
                <input type="url" id="bloggerLink" placeholder="https://t.me/username или https://instagram.com/username">
                <div class="form-group" style="justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button class="add-btn" id="saveBloggerBtn"><i class="fas fa-check"></i> Сохранить</button>
                    <button class="btn-close" onclick="hideAddBlogger()"><i class="fas fa-times"></i> Отмена</button>
                </div>
                <p style="font-size: 12px; color: var(--dark); margin-top: 10px;">
                    <i class="fas fa-info-circle"></i> Поле "Название" обязательно. Ссылка необязательна.
                </p>
            </div>
        </div>

        <div id="addBookModal" class="form-popup">
            <div class="form-container">
                <h3><i class="fas fa-book"></i> <span id="bookModalTitle">Добавить</span> книгу</h3>
                <label>Название книги <span style="color: var(--danger);">*</span>:</label>
                <input type="text" id="bookName" placeholder="Например: Логопедия для детей" maxlength="150" required>
                <label>ЧП с книги (руб.) <span style="color: var(--danger);">*</span>:</label>
                <input type="number" id="bookCP" min="0" step="0.01" placeholder="0.00" required>
                <div class="form-group" style="justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button class="add-btn" id="saveBookBtn"><i class="fas fa-check"></i> Сохранить</button>
                    <button class="btn-close" onclick="hideAddBook()"><i class="fas fa-times"></i> Отмена</button>
                </div>
                <p style="font-size: 12px; color: var(--dark); margin-top: 10px;">
                    <i class="fas fa-info-circle"></i> ЧП — чистая прибыль с одной книги после всех расходов.
                </p>
            </div>
        </div>

        <div id="editCampaignModal" class="form-popup">
            <div class="form-container">
                <h3><i class="fas fa-edit"></i> Редактировать кампанию</h3>
                <div class="form-group">
                    <label>Дата <span style="color: var(--danger);">*</span>:</label> 
                    <input type="date" id="editDate" required>
                    <label>Блогер <span style="color: var(--danger);">*</span>:</label> 
                    <select id="editBlogger" required></select>
                </div>
                <div class="form-group">
                    <label>Книга <span style="color: var(--danger);">*</span>:</label> 
                    <select id="editBook" required></select>
                    <label>Стоимость (руб.) <span style="color: var(--danger);">*</span>:</label> 
                    <input type="number" id="editCost" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>ЧП с книги (руб.) <span style="color: var(--danger);">*</span>:</label> 
                    <input type="number" id="editCP" min="0" step="0.01" required>
                    <label>Количество (шт.) <span style="color: var(--danger);">*</span>:</label> 
                    <input type="number" id="editQty" min="0" required>
                </div>
                <div class="form-group" style="justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button class="add-btn" id="saveCampaignBtn"><i class="fas fa-check"></i> Сохранить изменения</button>
                    <button class="btn-close" onclick="hideEditCampaign()"><i class="fas fa-times"></i> Отмена</button>
                </div>
            </div>
        </div>

        <div id="resetModal" class="form-popup">
            <div class="form-container">
                <h3><i class="fas fa-exclamation-triangle"></i> <strong style="color: var(--danger);">Полный сброс</strong></h3>
                <div style="background: #fff3cd; padding: 15px; border-radius: 6px; border-left: 4px solid var(--danger); margin-bottom: 20px;">
                    <p style="margin: 0; color: var(--danger); font-weight: bold;">
                        <i class="fas fa-exclamation-triangle"></i> Это действие НЕОБРАТИМО!
                    </p>
                    <ul style="margin: 10px 0; padding-left: 20px; color: var(--dark);">
                        <li>🗑️ Удалит <strong id="resetBloggersCount">0</strong> блогеров</li>
                        <li>📚 Удалит <strong id="resetBooksCount">0</strong> книг</li>
                        <li>📊 Удалит <strong id="resetCampaignsCount">0</strong> кампаний</li>
                        <li>💾 Очистит localStorage полностью</li>
                    </ul>
                </div>
                <label style="font-weight: bold;">Пароль администратора <span style="color: var(--danger);">*</span>:</label>
                <input type="password" id="resetPassword" placeholder="Введите пароль" maxlength="20" required>
                <div class="form-group" style="justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button class="btn-close" onclick="resetAll()" id="confirmResetBtn" disabled style="padding: 12px 20px; font-size: 16px;">
                        <i class="fas fa-bomb"></i> <strong>ПОДТВЕРДИТЬ СБРОС</strong>
                    </button>
                    <button class="add-btn" onclick="hideReset()"><i class="fas fa-times"></i> Отмена</button>
                </div>
                <div style="text-align: center; margin-top: 15px; font-size: 12px; color: var(--warning); padding: 10px; background: #fff3cd; border-radius: 6px;">
                    <strong>Пароль:</strong> <code>admin</code><br>
                    <small>Для безопасности измените пароль в функции resetAll() в коде</small>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ====================
        let bloggers = JSON.parse(localStorage.getItem('bloggers') || '[]');
        let books = JSON.parse(localStorage.getItem('books') || '[]');
        let campaigns = JSON.parse(localStorage.getItem('campaigns') || '[]');
        let dataLoaded = false;
        let currentEditIndex = -1;
        let isEditingBlogger = false;
        let isEditingBook = false;

        // Обновление счетчиков в интерфейсе
        function updateCounters() {
            document.getElementById('bloggerCount').textContent = bloggers.length;
            document.getElementById('bookCount').textContent = books.length;
            document.getElementById('campaignCount').textContent = campaigns.length;
            document.getElementById('resetBloggersCount').textContent = bloggers.length;
            document.getElementById('resetBooksCount').textContent = books.length;
            document.getElementById('resetCampaignsCount').textContent = campaigns.length;
        }

        // ==================== ИНИЦИАЛИЗАЦИЯ ====================
        function initApp() {
            console.log('🚀 Инициализация Анализатора блогеров v7.3');
            console.log('📊 SheetJS:', typeof XLSX !== 'undefined' ? '✓ Загружен' : '✗ Не найден');
            console.log('📈 Загружено: блогеров=' + bloggers.length + ', книг=' + books.length + ', кампаний=' + campaigns.length);
            
            // Проверяем DOM элементы
            const requiredElements = ['bloggersList', 'booksList', 'dataList', 'csvUrl', 'excelFile', 'progressBar', 'loadStatus'];
            let allElementsFound = true;
            
            requiredElements.forEach(function(id) {
                if (!document.getElementById(id)) {
                    console.error('❌ Элемент не найден:', id);
                    allElementsFound = false;
                }
            });
            
            if (!allElementsFound) {
                console.error('💥 Критическая ошибка DOM. Обновите страницу.');
                showError('Ошибка интерфейса. Обновите страницу (F5).');
                return false;
            }

            // Инициализируем интерфейс
            populateSelects();
            renderBloggers();
            renderBooks();
            updateCounters();
            
            if (campaigns.length > 0) {
                dataLoaded = true;
                updateList();
                document.getElementById('loadStatus').innerHTML = '<i class="fas fa-check"></i> Данные загружены';
                document.getElementById('loadStatus').className = 'status-indicator status-success';
            }

            // Активируем первую вкладку
            switchTab('load');
            
            // Настраиваем обработчики
            setupEventListeners();
            
            console.log('✅ Приложение инициализировано успешно');
            showMessage('Готов к работе! SheetJS подключен для Excel.', 'success');
            return true;
        }

        function setupEventListeners() {
            // Проверка пароля сброса в реальном времени
            const resetPassword = document.getElementById('resetPassword');
            if (resetPassword) {
                resetPassword.addEventListener('input', function() {
                    const confirmBtn = document.getElementById('confirmResetBtn');
                    if (confirmBtn) {
                        confirmBtn.disabled = this.value !== 'admin';
                        confirmBtn.style.opacity = this.value === 'admin' ? '1' : '0.5';
                    }
                });
            }
        }

        // ==================== ПЕРЕКЛЮЧЕНИЕ ВКЛАДОК ====================
        function switchTab(tabId) {
            try {
                console.log('🔄 Переключение на вкладку:', tabId);
                
                // Скрываем все вкладки
                const allTabs = document.querySelectorAll('.tab-content');
                allTabs.forEach(function(tab) {
                    if (tab && tab.classList.contains('active')) {
                        tab.classList.remove('active');
                    }
                });

                // Деактивируем кнопки
                const allButtons = document.querySelectorAll('.tab-btn');
                allButtons.forEach(function(btn) {
                    if (btn && btn.classList.contains('active')) {
                        btn.classList.remove('active');
                    }
                });

                // Активируем нужную вкладку
                const targetTab = document.getElementById(tabId);
                if (targetTab) {
                    targetTab.classList.add('active');
                }

                // Активируем кнопку
                const targetButton = document.querySelector('.tab-btn[data-tab="' + tabId + '"]');
                if (targetButton) {
                    targetButton.classList.add('active');
                }

                // Специальная логика
                if (tabId === 'data' && campaigns.length > 0) {
                    updateList();
                } else if (tabId === 'analysis' && campaigns.length > 0) {
                    // Можно автоанализ при переключении
                }

                console.log('✅ Вкладка "' + tabId + '" активирована');
            } catch (error) {
                console.error('❌ Ошибка switchTab:', error);
                showError('Ошибка переключения вкладок. Обновите страницу.');
            }
        }

        // ==================== ЗАГРУЗКА GOOGLE SHEETS ====================
        function loadFromSheets() {
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const loadMessage = document.getElementById('loadMessage');
            const sheetsBtn = document.getElementById('sheetsBtn');
            const loadStatus = document.getElementById('loadStatus');
            const urlInput = document.getElementById('csvUrl');
            
            if (!progressBar || !progressText || !loadMessage || !sheetsBtn || !loadStatus || !urlInput) {
                showError('Ошибка интерфейса загрузки');
                return;
            }

            const url = urlInput.value.trim();
            if (!url || !url.includes('docs.google.com')) {
                showError('Введите корректную ссылку на Google Sheets!');
                urlInput.focus();
                return;
            }

            // Показываем прогресс
            progressContainer.style.display = 'block';
            sheetsBtn.disabled = true;
            sheetsBtn.innerHTML = '<div class="loading"></div> Загрузка...';
            loadStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Загрузка';
            loadStatus.className = 'status-indicator status-loading';
            loadMessage.innerHTML = '';

            // Формируем URL
            let csvUrl = url;
            if (!url.includes('/pub?output=csv')) {
                const baseUrl = url.includes('/edit') ? url.split('/edit')[0] : url;
                csvUrl = baseUrl + '/pub?output=csv';
            }

            console.log('📥 Загрузка CSV:', csvUrl);

            fetch(csvUrl, { 
                method: 'GET',
                headers: { 'Accept': 'text/csv,*/*' },
                mode: 'cors'
            })
            .then(function(response) {
                progressBar.style.width = '30%';
                progressText.textContent = 'Проверка соединения...';
                
                if (!response.ok) {
                    let errorMsg = 'Ошибка HTTP ' + response.status;
                    if (response.status === 404) errorMsg += ' (файл не найден)';
                    if (response.status === 403) errorMsg += ' (нет доступа)';
                    throw new Error(errorMsg);
                }
                
                if (!response.headers.get('content-type') || !response.headers.get('content-type').includes('text/csv')) {
                    throw new Error('Ответ не содержит CSV данных');
                }
                
                return response.text();
            })
            .then(function(csvText) {
                progressBar.style.width = '60%';
                progressText.textContent = 'Парсинг данных...';
                
                if (!csvText || csvText.trim().length < 10) {
                    throw new Error('CSV файл пуст или поврежден');
                }
                
                parseCSV(csvText, 'sheets');
                
                progressBar.style.width = '90%';
                progressText.textContent = 'Сохранение...';
                
            })
            .catch(function(error) {
                console.error('❌ Ошибка загрузки Sheets:', error);
                
                progressBar.style.width = '0%';
                progressText.textContent = 'Ошибка';
                sheetsBtn.disabled = false;
                sheetsBtn.innerHTML = '<i class="fas fa-file-csv"></i> Загрузить из Sheets';
                loadStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Ошибка';
                loadStatus.className = 'status-indicator status-error';
                
                showError('Ошибка загрузки Google Sheets:<br>' + error.message + '<br><br><strong>Возможные причины:</strong><br>' +
                         '• Неправильная ссылка<br>' +
                         '• Таблица не опубликована публично<br>' +
                         '• Ограничен доступ к файлу<br>' +
                         '• Неправильный формат CSV');
                
                loadMessage.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i> ' + error.message + '</div>';
            })
            .finally(function() {
                // Финализация (выполнится всегда)
                setTimeout(function() {
                    progressContainer.style.display = 'none';
                    if (dataLoaded) {
                        loadStatus.innerHTML = '<i class="fas fa-check"></i> Успешно загружено';
                        loadStatus.className = 'status-indicator status-success';
                        loadMessage.innerHTML = '<div class="success-message"><i class="fas fa-check-circle"></i> Загружено ' + campaigns.length + ' кампаний! Переключитесь на вкладку "Данные".</div>';
                        switchTab('data');
                    }
                }, 1500);
            });
        }

        // ==================== ЗАГРУЗКА EXCEL (ПОЛНАЯ РЕАЛИЗАЦИЯ) ====================
        function loadFromExcel(event) {
            console.log('📁 Загрузка Excel файла...');
            
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const loadMessage = document.getElementById('loadMessage');
            const fileInput = document.getElementById('excelFile');
            const fileInfo = document.getElementById('fileInfo');
            const loadStatus = document.getElementById('loadStatus');
            
            if (!progressBar || !progressText || !loadMessage || !fileInput || !fileInfo || !loadStatus) {
                showError('Ошибка интерфейса загрузки Excel');
                return;
            }

            const file = event.target.files[0];
            if (!file) {
                // Пользователь отменил выбор
                fileInput.value = '';
                return;
            }

            // Проверяем формат файла
            if (!file.name.match(/\.(xlsx?|xls)$/i)) {
                showError('Выберите файл Excel (.xlsx или .xls)');
                fileInput.value = '';
                return;
            }

            // Проверяем размер (макс 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showError('Файл слишком большой (макс. 10MB). Выберите меньший файл.');
                fileInput.value = '';
                return;
            }

            console.log('✅ Файл валиден:', file.name, '(' + (file.size / 1024 / 1024).toFixed(2) + ' MB)');

            // Показываем информацию о файле
            fileInfo.style.display = 'inline';
            fileInfo.innerHTML = '<i class="fas fa-file-excel"></i> ' + escapeHtml(file.name) + ' (' + (file.size / 1024).toFixed(1) + ' КБ)';

            // Показываем прогресс
            progressContainer.style.display = 'block';
            loadStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Чтение Excel...';
            loadStatus.className = 'status-indicator status-loading';
            loadMessage.innerHTML = '';

            // Проверяем SheetJS
            if (typeof XLSX === 'undefined') {
                console.error('❌ SheetJS не загружен');
                showError('Библиотека SheetJS не загружена. Проверьте интернет-соединение.');
                progressContainer.style.display = 'none';
                loadStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Ошибка';
                loadStatus.className = 'status-indicator status-error';
                fileInput.value = '';
                fileInfo.style.display = 'none';
                return;
            }

            const reader = new FileReader();
            
            reader.onerror = function() {
                console.error('❌ Ошибка чтения файла');
                showError('Ошибка чтения файла Excel');
                resetExcelUpload();
            };
            
            reader.onprogress = function(e) {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total * 100).toFixed(0);
                    progressBar.style.width = percent + '%';
                    progressText.textContent = 'Чтение файла... ' + percent + '%';
                }
            };
            
            reader.onload = function(e) {
                try {
                    progressText.textContent = 'Обработка Excel...';
                    progressBar.style.width = '40%';
                    
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { 
                        type: 'array',
                        cellDates: true, // Для корректной работы с датами
                        cellNF: false
                    });
                    
                    progressBar.style.width = '60%';
                    progressText.textContent = 'Извлечение данных...';
                    
                    // Берем первый лист или с названием "Sheet1", "Data", etc.
                    let sheetName = workbook.SheetNames[0];
                    const preferredNames = ['Sheet1', 'Data', 'Кампании', 'Campaigns'];
                    for (let name of preferredNames) {
                        if (workbook.SheetNames.includes(name)) {
                            sheetName = name;
                            break;
                        }
                    }
                    
                    const worksheet = workbook.Sheets[sheetName];
                    if (!worksheet) {
                        throw new Error('Лист с данными не найден');
                    }
                    
                    // Конвертируем в JSON для анализа структуры
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        header: 1,
                        defval: '',
                        blankrows: false,
                        dateNF: 'yyyy-mm-dd'
                    });
                    
                    progressBar.style.width = '75%';
                    progressText.textContent = 'Парсинг ' + jsonData.length + ' строк...';
                    
                    if (jsonData.length < 2) {
                        throw new Error('В файле недостаточно данных (минимум заголовок + 1 строка)');
                    }
                    
                    // Конвертируем в CSV для унифицированного парсинга
                    const csvText = XLSX.utils.sheet_to_csv(worksheet, { 
                        FS: ',',
                        RS: '\n',
                        dateNF: 'yyyy-mm-dd',
                        strip: true
                    });
                    
                    // Ограничиваем до 2000 строк для производительности
                    const limitedCsv = csvText.split('\n').slice(0, 2001).join('\n');
                    
                    progressBar.style.width = '85%';
                    progressText.textContent = 'Валидация данных...';
                    
                    parseCSV(limitedCsv, 'excel', {
                        sourceFile: file.name,
                        sheetName: sheetName,
                        totalRows: jsonData.length
                    });
                    
                    progressBar.style.width = '100%';
                    progressText.textContent = 'Готово!';
                    
                } catch (error) {
                    console.error('❌ Ошибка обработки Excel:', error);
                    showError('Ошибка обработки Excel:<br>' + error.message + '<br><br><strong>Проверьте:</strong><br>' +
                             '• Файл не поврежден<br>' +
                             '• Есть данные в таблице<br>' +
                             '• Корректные заголовки колонок');
                    resetExcelUpload();
                    return;
                }
                
                // Финализация успешной загрузки
                setTimeout(function() {
                    progressContainer.style.display = 'none';
                    fileInput.value = '';
                    fileInfo.style.display = 'none';
                    
                    loadStatus.innerHTML = '<i class="fas fa-check"></i> Excel загружен';
                    loadStatus.className = 'status-indicator status-success';
                    
                    loadMessage.innerHTML = `
                        <div class="success-message">
                            <i class="fas fa-check-circle"></i> 
                            Excel файл "<strong>${escapeHtml(file.name)}</strong>" успешно загружен!
                            <br><small>Импортировано ${campaigns.length} кампаний из листа "${sheetName}"</small>
                        </div>
                    `;
                    
                    dataLoaded = true;
                    updateList();
                    updateCounters();
                    switchTab('data');
                    populateSelects();
                    
                    console.log('✅ Excel успешно обработан:', campaigns.length, 'кампаний');
                }, 1500);
                
            };
            
            // Запускаем чтение
            reader.readAsArrayBuffer(file);
        }

        // Сброс состояния загрузки Excel
        function resetExcelUpload() {
            const progressContainer = document.getElementById('progressContainer');
            const fileInput = document.getElementById('excelFile');
            const fileInfo = document.getElementById('fileInfo');
            const loadStatus = document.getElementById('loadStatus');
            
            if (progressContainer) progressContainer.style.display = 'none';
            if (fileInput) fileInput.value = '';
            if (fileInfo) fileInfo.style.display = 'none';
            if (loadStatus) {
                loadStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Ошибка загрузки';
                loadStatus.className = 'status-indicator status-error';
            }
        }

        // ==================== ПАРСИНГ CSV/EXCEL ====================
        function parseCSV(csvText, source = 'unknown', metadata = {}) {
            console.log('🔍 Парсинг данных из', source, metadata);
            
            try {
                // Удаляем BOM (Byte Order Mark)
                if (csvText.charCodeAt(0) === 0xFEFF) {
                    csvText = csvText.slice(1);
                }
                
                // Разбиваем на строки
                let lines = csvText.split('\n').map(function(line) { 
                    return line.trim(); 
                }).filter(function(line) { 
                    return line.length > 0; 
                });
                
                if (lines.length < 2) {
                    throw new Error(source === 'excel' ? 'В Excel файле нет данных' : 'CSV файл пуст или содержит только заголовок');
                }
                
                console.log('📊 Найдено строк:', lines.length);
                
                // Парсим заголовки
                let headers = lines[0].split(',').map(function(h) { 
                    return h.trim().toLowerCase().replace(/"/g, ''); 
                });
                
                console.log('📋 Заголовки:', headers);
                
                // Ищем индексы колонок (гибкий поиск)
                const colMap = {
                    date: findColumn(headers, ['date', 'дата', 'день', 'day']),
                    blogger: findColumn(headers, ['blogger', 'блогер', 'influencer', 'автор']),
                    book: findColumn(headers, ['book', 'книга', 'title', 'название']),
                    cost: findColumn(headers, ['cost', 'стоимость', 'expense', 'затраты']),
                    cp: findColumn(headers, ['cp', 'прибыль', 'revenue', 'доход', 'profit']),
                    qty: findColumn(headers, ['qty', 'quantity', 'количество', 'count', 'шт'])
                };
                
                console.log('🔍 Соответствие колонок:', colMap);
                
                // Проверяем обязательные колонки
                const required = ['date', 'blogger', 'book', 'cost', 'qty'];
                let missing = [];
                
                required.forEach(function(col) {
                    if (colMap[col] === -1) {
                        missing.push(col);
                    }
                });
                
                if (missing.length > 0) {
                    console.warn('⚠️ Отсутствуют колонки:', missing);
                    if (source === 'excel') {
                        throw new Error('В файле отсутствуют обязательные колонки: ' + missing.join(', '));
                    } else {
                        // Для CSV пробуем позиции по умолчанию
                        colMap.date = 0;
                        colMap.blogger = 1;
                        colMap.book = 2;
                        colMap.cost = 3;
                        colMap.cp = 4;
                        colMap.qty = 5;
                        console.log('🔄 Используем позиции по умолчанию:', colMap);
                    }
                }
                
                // Парсим данные
                let parsedCount = 0;
                let errorCount = 0;
                let parsedCampaigns = [];
                
                for (let i = 1; i < lines.length && parsedCount < 2000; i++) {
                    try {
                        const line = lines[i];
                        const values = line.split(',').map(function(v) { 
                            return v.trim().replace(/"/g, '').replace(/'/g, ''); 
                        });
                        
                        if (values.length < Math.max(...Object.values(colMap)) + 1) {
                            console.warn('📉 Недостаточно колонок в строке', i + 1);
                            errorCount++;
                            continue;
                        }
                        
                        // Извлекаем значения
                        const rowData = {
                            date: getValue(values, colMap.date),
                            blogger: getValue(values, colMap.blogger),
                            book: getValue(values, colMap.book),
                            cost: parseFloat(getValue(values, colMap.cost)) || 0,
                            cp: parseFloat(getValue(values, colMap.cp)) || 0,
                            qty: parseInt(getValue(values, colMap.qty)) || 0,
                            row: i + 1 // Номер строки для отладки
                        };
                        
                        // Валидация
                        const validationErrors = validateCampaign(rowData);
                        if (validationErrors.length > 0) {
                            console.warn('⚠️ Ошибки в строке', rowData.row, ':', validationErrors.join(', '));
                            errorCount++;
                            continue;
                        }
                        
                        parsedCampaigns.push(rowData);
                        parsedCount++;
                        
                    } catch (rowError) {
                        console.warn('❌ Ошибка обработки строки', i + 1, ':', rowError.message);
                        errorCount++;
                    }
                }
                
                if (parsedCount === 0) {
                    throw new Error('Нет валидных данных для импорта');
                }
                
                // Сохраняем
                campaigns = parsedCampaigns;
                localStorage.setItem('campaigns', JSON.stringify(campaigns));
                
                // Автоматически создаем справочники
                extractBloggersBooks();
                
                console.log('✅ Парсинг завершен:');
                console.log('   ✓ Обработано строк:', lines.length - 1);
                console.log('   ✓ Импортировано:', parsedCount);
                console.log('   ⚠️  Пропущено:', errorCount);
                
                // Обновляем интерфейс
                dataLoaded = true;
                updateList();
                updateCounters();
                populateSelects();
                
                // Статистика
                const sourceInfo = source === 'excel' ? 
                    `Файл: ${metadata.sourceFile || 'Неизвестно'}, Лист: ${metadata.sheetName || 'Sheet1'}, Строк: ${metadata.totalRows || 'Неизвестно'}` : 
                    'Источник: Google Sheets CSV';
                
                showMessage(
                    `✅ Импорт завершен!<br>` +
                    `<strong>${parsedCount}</strong> кампаний успешно загружено<br>` +
                    `<small>${sourceInfo}</small><br>` +
                    `<small style="color: #ffc107;">Пропущено ${errorCount} некорректных строк</small>`,
                    'success'
                );
                
                return { success: true, count: parsedCount, errors: errorCount };
                
            } catch (error) {
                console.error('❌ Критическая ошибка парсинга:', error);
                showError('Ошибка обработки данных:<br>' + error.message);
                throw error;
            }
        }

        // Вспомогательные функции парсинга
        function findColumn(headers, keywords) {
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase();
                for (let keyword of keywords) {
                    if (header.includes(keyword)) {
                        return i;
                    }
                }
            }
            return -1;
        }

        function getValue(values, colIndex) {
            if (colIndex >= 0 && colIndex < values.length) {
                return values[colIndex] || '';
            }
            return '';
        }

        function validateCampaign(data) {
            const errors = [];
            
            if (!data.date || !data.date.trim()) {
                errors.push('нет даты');
            } else if (!isValidDate(data.date)) {
                errors.push('неверный формат даты');
            }
            
            if (!data.blogger || !data.blogger.trim() || data.blogger.trim().length < 2) {
                errors.push('нет блогера или слишком короткое имя');
            }
            
            if (!data.book || !data.book.trim() || data.book.trim().length < 2) {
                errors.push('нет книги или слишком короткое название');
            }
            
            if (data.cost <= 0 || isNaN(data.cost)) {
                errors.push('стоимость <= 0');
            }
            
            if (data.cp <= 0 || isNaN(data.cp)) {
                errors.push('ЧП <= 0');
            }
            
            if (data.qty <= 0 || isNaN(data.qty)) {
                errors.push('количество <= 0');
            }
            
            return errors;
        }

        function isValidDate(dateString) {
            const date = new Date(dateString);
            return date instanceof Date && !isNaN(date) && dateString.match(/^\d{4}-\d{2}-\d{2}$/);
        }

        // ==================== СПРАВОЧНИКИ ====================
        function extractBloggersBooks() {
            console.log('📚 Извлечение справочников из кампаний...');
            
            const originalCount = { bloggers: bloggers.length, books: books.length };
            
            // Новые блогеры
            const newBloggers = campaigns
                .map(function(c) { return c.blogger.trim(); })
                .filter(function(name, index, self) {
                    return name && self.indexOf(name) === index && !bloggers.find(function(b) { return b.name === name; });
                });
            
            newBloggers.forEach(function(name) {
                bloggers.push({ name: name, link: '' });
            });
            
            // Новые книги
            const newBooks = campaigns
                .map(function(c) { return c.book.trim(); })
                .filter(function(name, index, self) {
                    return name && self.indexOf(name) === index && !books.find(function(b) { return b.name === name; });
                });
            
            newBooks.forEach(function(name) {
                // Ищем ЧП по названию книги в существующих записях
                const avgCP = campaigns
                    .filter(function(c) { return c.book === name; })
                    .reduce(function(sum, c) { return sum + c.cp; }, 0) / campaigns.filter(function(c) { return c.book === name; }).length || 0;
                
                books.push({ name: name, cp: avgCP || 0 });
            });
            
            if (newBloggers.length > 0 || newBooks.length > 0) {
                saveStorage();
                populateSelects();
                renderBloggers();
                renderBooks();
                updateCounters();
                
                console.log('✅ Добавлено:');
                console.log('   📝 Блогеров:', newBloggers.length);
                console.log('   📚 Книг:', newBooks.length);
                
                if (newBloggers.length > 0) {
                    showMessage(`Автоматически добавлено ${newBloggers.length} новых блогеров из данных`, 'success');
                }
                if (newBooks.length > 0) {
                    showMessage(`Автоматически добавлено ${newBooks.length} новых книг из данных`, 'success');
                }
            }
        }

        function populateSelects() {
            console.log('🔧 Заполнение выпадающих списков...');
            
            // Сортируем
            const sortedBloggers = bloggers.sort(function(a, b) { return a.name.localeCompare(b.name); });
            const sortedBooks = books.sort(function(a, b) { return a.name.localeCompare(b.name); });
            
            // Блогеры
            const bloggerSelectIds = ['campaignBlogger', 'filterBlogger', 'editBlogger'];
            bloggerSelectIds.forEach(function(id) {
                const select = document.getElementById(id);
                if (!select) return;
                
                const isFilter = id === 'filterBlogger';
                select.innerHTML = isFilter ? '<option value="">Все блогеры</option>' : '<option value="">Выберите блогера</option>';
                
                sortedBloggers.forEach(function(b) {
                    const option = document.createElement('option');
                    option.value = b.name;
                    option.textContent = b.name;
                    select.appendChild(option);
                });
                
                // Если есть активные кампании, выбираем первый блогер по умолчанию для новых
                if (!isFilter && id === 'campaignBlogger' && campaigns.length > 0 && !select.value) {
                    const firstBlogger = campaigns[0].blogger;
                    if (sortedBloggers.find(function(b) { return b.name === firstBlogger; })) {
                        select.value = firstBlogger;
                    }
                }
            });
            
            // Книги
            const bookSelectIds = ['campaignBook', 'filterBook', 'editBook'];
            bookSelectIds.forEach(function(id) {
                const select = document.getElementById(id);
                if (!select) return;
                
                const isFilter = id === 'filterBook';
                select.innerHTML = isFilter ? '<option value="">Все книги</option>' : '<option value="">Выберите книгу</option>';
                
                sortedBooks.forEach(function(bk) {
                    const option = document.createElement('option');
                    option.value = bk.name;
                    option.textContent = bk.name + (bk.cp > 0 ? ` (ЧП: ${bk.cp.toFixed(2)} руб.)` : '');
                    select.appendChild(option);
                });
                
                if (!isFilter && id === 'campaignBook' && campaigns.length > 0 && !select.value) {
                    const firstBook = campaigns[0].book;
                    if (sortedBooks.find(function(b) { return b.name === firstBook; })) {
                        select.value = firstBook;
                    }
                }
            });
        }

        // ==================== РЕНДЕР СПРАВОЧНИКОВ ====================
        function renderBloggers() {
            const container = document.getElementById('bloggersList');
            if (!container) return;
            
            updateCounters();
            
            if (bloggers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users-slash" style="font-size: 48px; color: var(--warning); margin-bottom: 15px;"></i>
                        <p><strong>Справочник блогеров пуст</strong></p>
                        <p style="font-size: 14px; color: var(--dark);">Загрузите данные из Excel/CSV или добавьте блогеров вручную.</p>
                        <div style="margin-top: 15px;">
                            <button class="add-btn" onclick="showAddBlogger()" style="padding: 10px 20px; margin-right: 10px;">
                                <i class="fas fa-user-plus"></i> Добавить блогера
                            </button>
                            <button class="add-btn" onclick="switchTab('load')" style="background: var(--secondary);">
                                <i class="fas fa-upload"></i> Загрузить данные
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            bloggers.forEach(function(b, i) {
                // Статистика по блогеру
                const bloggerCampaigns = campaigns.filter(function(c) { return c.blogger === b.name; });
                const campaignCount = bloggerCampaigns.length;
                const totalCost = bloggerCampaigns.reduce(function(sum, c) { return sum + c.cost; }, 0);
                const totalProfit = bloggerCampaigns.reduce(function(sum, c) { return sum + (c.cp * c.qty); }, 0);
                const avgROAS = totalCost > 0 ? (totalProfit / totalCost).toFixed(2) : '0.00';
                
                // Последние 3 кампании
                const recentCampaigns = bloggerCampaigns
                    .sort(function(a, b) { return new Date(b.date) - new Date(a.date); })
                    .slice(0, 3)
                    .map(function(c) { 
                        const profit = c.cp * c.qty;
                        const roi = c.cost > 0 ? ((profit - c.cost) / c.cost * 100).toFixed(0) : 0;
                        return `<div style="font-size: 13px; padding: 4px; background: white; border: 1px solid var(--border); border-radius: 4px; margin: 2px 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>${c.date}: ${escapeHtml(c.book)}</span>
                                <span style="font-weight: bold; color: ${roi > 100 ? 'var(--primary)' : roi > 0 ? 'var(--warning)' : 'var(--danger)'}">
                                    ${roi > 0 ? '+' : ''}${roi}%
                                </span>
                            </div>
                            <div style="font-size: 11px; color: var(--dark);">
                                ${c.cost.toFixed(0)} руб. → ${profit.toFixed(0)} руб. прибыли
                            </div>
                        </div>`;
                    }).join('') || '<div style="font-style: italic; color: var(--warning);">Кампании отсутствуют</div>';
                
                const efficiencyClass = avgROAS > 3 ? 'positive' : avgROAS > 1 ? 'neutral' : 'negative';
                
                html += `
                    <div class="blogger-card" style="border-left: 4px solid ${efficiencyClass === 'positive' ? 'var(--primary)' : efficiencyClass === 'neutral' ? 'var(--warning)' : 'var(--danger)'}">
                        <div class="card-header">
                            <div style="display: flex; align-items: center;">
                                <i class="fas fa-user" style="color: var(--secondary); margin-right: 8px; font-size: 20px;"></i>
                                <strong style="font-size: 18px;">${escapeHtml(b.name)}</strong>
                            </div>
                            <div style="text-align: right;">
                                <span class="metrics ${efficiencyClass}" style="font-size: 16px; display: block;">
                                    ROAS: <strong>${avgROAS}x</strong>
                                </span>
                                <span style="font-size: 14px; color: var(--dark);">
                                    ${campaignCount} кампани${campaignCount === 1 ? 'я' : campaignCount < 5 ? 'й' : 'й'}
                                    ${totalCost > 0 ? `| ${totalCost.toFixed(0)} руб.` : ''}
                                </span>
                            </div>
                        </div>
                        
                        <div class="card-details">
                            <div><strong>Ссылка:</strong></div>
                            <div style="word-break: break-all; font-size: 14px;">
                                ${b.link ? 
                                    `<a href="${escapeHtml(b.link)}" target="_blank" rel="noopener" style="color: var(--secondary); text-decoration: none;" title="Открыть в новой вкладке">
                                        <i class="fas fa-external-link-alt" style="font-size: 12px; margin-right: 5px;"></i>
                                        ${escapeHtml(b.link.length > 50 ? b.link.substring(0, 47) + '...' : b.link)}
                                    </a>` : 
                                    '<span style="color: var(--warning); font-style: italic;">Не указана</span>'
                                }
                            </div>
                            
                            <div><strong>Недавние кампании:</strong></div>
                            <div style="grid-column: 2; font-size: 14px; line-height: 1.4; max-height: 120px; overflow-y: auto;">
                                ${recentCampaigns}
                            </div>
                        </div>
                        
                        <div class="card-actions" style="margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border);">
                            <button class="add-btn" onclick="editBlogger(${i})" style="padding: 8px 16px; font-size: 14px;" title="Редактировать данные">
                                <i class="fas fa-edit"></i> Редактировать
                            </button>
                            <button class="btn-close" onclick="deleteBlogger(${i})" style="padding: 8px 16px; font-size: 14px;" title="Удалить блогера и кампании">
                                <i class="fas fa-trash"></i> Удалить
                            </button>
                            ${b.link ? 
                                `<button class="add-btn" onclick="window.open('${escapeHtml(b.link)}', '_blank')" style="background: var(--secondary); padding: 8px 16px; font-size: 14px;" title="Открыть профиль">
                                    <i class="fas fa-external-link-alt"></i> Профиль
                                </button>` : ''
                            }
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || `
                <div class="empty-state">
                    <i class="fas fa-search" style="font-size: 48px; color: var(--warning); margin-bottom: 15px;"></i>
                    <p>Блогеры не найдены</p>
                    <p style="font-size: 14px;">Данные не загружены или отфильтрованы</p>
                    <button class="add-btn" onclick="switchTab('load')" style="margin-top: 10px;">
                        <i class="fas fa-upload"></i> Загрузить данные
                    </button>
                </div>
            `;
        }

        function renderBooks() {
            const container = document.getElementById('booksList');
            if (!container) return;
            
            updateCounters();
            
            if (books.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-book" style="font-size: 48px; color: var(--warning); margin-bottom: 15px;"></i>
                        <p><strong>Справочник книг пуст</strong></p>
                        <p style="font-size: 14px;">Загрузите данные или добавьте книги вручную.</p>
                        <div style="margin-top: 15px;">
                            <button class="add-btn" onclick="showAddBook()" style="padding: 10px 20px; margin-right: 10px;">
                                <i class="fas fa-book-open"></i> Добавить книгу
                            </button>
                            <button class="add-btn" onclick="switchTab('load')" style="background: var(--secondary);">
                                <i class="fas fa-upload"></i> Загрузить данные
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            books.forEach(function(bk, i) {
                // Статистика по книге
                const bookCampaigns = campaigns.filter(function(c) { return c.book === bk.name; });
                const campaignCount = bookCampaigns.length;
                const totalSold = bookCampaigns.reduce(function(sum, c) { return sum + c.qty; }, 0);
                const totalRevenue = bookCampaigns.reduce(function(sum, c) { return sum + (c.cp * c.qty); }, 0);
                const avgCPS = totalSold > 0 ? (bookCampaigns.reduce(function(sum, c) { return sum + c.cost; }, 0) / totalSold).toFixed(2) : '0.00';
                
                // ROI книги
                const totalCost = bookCampaigns.reduce(function(sum, c) { return sum + c.cost; }, 0);
                const bookROI = totalCost > 0 ? ((totalRevenue - totalCost) / totalCost * 100).toFixed(1) : 0;
                const roiClass = bookROI > 100 ? 'positive' : bookROI > 0 ? 'neutral' : 'negative';
                
                // Последние кампании
                const recentCampaigns = bookCampaigns
                    .sort(function(a, b) { return new Date(b.date) - new Date(a.date); })
                    .slice(0, 3)
                    .map(function(c) { 
                        const profit = c.cp * c.qty;
                        return `<div style="font-size: 13px; padding: 4px; background: white; border: 1px solid var(--border); border-radius: 4px; margin: 2px 0;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>${c.date}: ${escapeHtml(c.blogger)}</span>
                                <span style="font-weight: bold;">${c.qty} шт.</span>
                            </div>
                            <div style="font-size: 11px; color: var(--dark);">
                                ${c.cost.toFixed(0)} руб. → ${profit.toFixed(0)} руб.
                            </div>
                        </div>`;
                    }).join('') || '<div style="font-style: italic; color: var(--warning);">Кампании отсутствуют</div>';
                
                html += `
                    <div class="book-card" style="border-left: 4px solid ${roiClass === 'positive' ? 'var(--primary)' : roiClass === 'neutral' ? 'var(--warning)' : 'var(--danger)'}">
                        <div class="card-header">
                            <div style="display: flex; align-items: center;">
                                <i class="fas fa-book-open" style="color: var(--secondary); margin-right: 8px; font-size: 20px;"></i>
                                <strong style="font-size: 18px;">${escapeHtml(bk.name)}</strong>
                            </div>
                            <div style="text-align: right;">
                                <span class="metrics ${roiClass}" style="font-size: 16px; display: block;">
                                    ROI: <strong>${bookROI > 0 ? '+' : ''}${bookROI}%</strong>
                                </span>
                                <span style="font-size: 14px; color: var(--dark);">
                                    ЧП: ${bk.cp.toFixed(2)} руб. | Продано: ${totalSold} шт.
                                </span>
                            </div>
                        </div>
                        
                        <div class="card-details">
                            <div><strong>Общая выручка:</strong></div>
                            <div style="font-weight: bold; color: var(--primary); font-size: 16px;">
                                ${totalRevenue.toFixed(0)} руб.
                            </div>
                            
                            <div><strong>Эффективность:</strong></div>
                            <div style="font-size: 14px;">
                                <div>CPS: ${avgCPS} руб./шт. | Кампаний: ${campaignCount}</div>
                                <div style="margin-top: 5px;">${totalCost > 0 ? `Общие затраты: ${totalCost.toFixed(0)} руб.` : 'Затраты отсутствуют'}</div>
                            </div>
                            
                            <div><strong>Недавние продажи:</strong></div>
                            <div style="grid-column: 2; font-size: 14px; line-height: 1.4; max-height: 120px; overflow-y: auto;">
                                ${recentCampaigns}
                            </div>
                        </div>
                        
                        <div class="card-actions" style="margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border);">
                            <button class="add-btn" onclick="editBook(${i})" style="padding: 8px 16px; font-size: 14px;" title="Изменить ЧП или название">
                                <i class="fas fa-edit"></i> Редактировать
                            </button>
                            <button class="btn-close" onclick="deleteBook(${i})" style="padding: 8px 16px; font-size: 14px;" title="Удалить книгу и продажи">
                                <i class="fas fa-trash"></i> Удалить
                            </button>
                            ${totalRevenue > 0 ?
                                `<button class="add-btn" onclick="showBookStats(${i})" style="background: var(--warning); padding: 8px 16px; font-size: 14px;" title="Подробная статистика">
                                    <i class="fas fa-chart-line"></i> Статистика
                                </button>` : ''
                            }
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || `
                <div class="empty-state">
                    <i class="fas fa-search" style="font-size: 48px; color: var(--warning); margin-bottom: 15px;"></i>
                    <p>Книги не найдены</p>
                    <p style="font-size: 14px;">Данные не загружены или отфильтрованы</p>
                    <button class="add-btn" onclick="switchTab('load')" style="margin-top: 10px;">
                        <i class="fas fa-upload"></i> Загрузить данные
                    </button>
                </div>
            `;
        }

        // ==================== МОДАЛЬНЫЕ ОКНА ====================
        function showAddBlogger() {
            isEditingBlogger = false;
            currentEditIndex = -1;
            document.getElementById('bloggerModalTitle').textContent = 'Добавить';
            document.getElementById('bloggerName').value = '';
            document.getElementById('bloggerLink').value = '';
            document.getElementById('saveBloggerBtn').innerHTML = '<i class="fas fa-check"></i> Добавить блогера';
            document.getElementById('saveBloggerBtn').onclick = saveBlogger;
            showModal('addBloggerModal');
            document.getElementById('bloggerName').focus();
        }

        function editBlogger(index) {
            if (index < 0 || index >= bloggers.length) {
                showError('Ошибка: неверный блогер');
                return;
            }
            
            isEditingBlogger = true;
            currentEditIndex = index;
            const blogger = bloggers[index];
            
            document.getElementById('bloggerModalTitle').textContent = 'Редактировать';
            document.getElementById('bloggerName').value = blogger.name;
            document.getElementById('bloggerLink').value = blogger.link || '';
            document.getElementById('saveBloggerBtn').innerHTML = '<i class="fas fa-save"></i> Обновить блогера';
            document.getElementById('saveBloggerBtn').onclick = function() { saveBlogger(index); };
            
            showModal('addBloggerModal');
            document.getElementById('bloggerName').focus();
            document.getElementById('bloggerName').select();
        }

        function saveBlogger(editIndex = null) {
            const nameInput = document.getElementById('bloggerName');
            const linkInput = document.getElementById('bloggerLink');
            const saveBtn = document.getElementById('saveBloggerBtn');
            
            if (!nameInput || !linkInput || !saveBtn) {
                showError('Ошибка формы блогера');
                return;
            }
            
            const name = nameInput.value.trim();
            const link = linkInput.value.trim();
            
            // Валидация
            if (!name || name.length < 2) {
                showError('Название блогера должно содержать минимум 2 символа');
                nameInput.focus();
                return;
            }
            
            if (name.length > 100) {
                showError('Название слишком длинное (макс. 100 символов)');
                return;
            }
            
            // Проверка дубликата
            const existingIndex = bloggers.findIndex(function(b, i) {
                return i !== (editIndex || currentEditIndex) && b.name.toLowerCase() === name.toLowerCase();
            });
            
            if (existingIndex !== -1) {
                showError('Блогер с таким названием уже существует: ' + bloggers[existingIndex].name);
                nameInput.focus();
                return;
            }
            
            // Ссылка (опционально)
            if (link && !isValidURL(link)) {
                if (!confirm('Ссылка может быть некорректной: "' + link + '"\n\nПродолжить?')) {
                    linkInput.focus();
                    return;
                }
            }
            
            const operation = editIndex !== null ? 'обновлен' : 'добавлен';
            
            if (editIndex !== null || isEditingBlogger) {
                // Редактирование
                bloggers[currentEditIndex].name = name;
                if (link) bloggers[currentEditIndex].link = link;
                
                // Обновляем связанные кампании если имя изменилось
                const oldName = bloggers[currentEditIndex].name;
                if (name.toLowerCase() !== oldName.toLowerCase()) {
                    campaigns.forEach(function(c) {
                        if (c.blogger === oldName) {
                            c.blogger = name;
                        }
                    });
                }
                bloggers[currentEditIndex].name = name;
                
                saveStorage();
                renderBloggers();
                populateSelects();
                updateList();
                
                showMessage('Блогер "' + name + '" обновлен', 'success');
                
            } else {
                // Добавление
                bloggers.push({ name: name, link: link || '' });
                saveStorage();
                renderBloggers();
                populateSelects();
                
                showMessage('Блогер "' + name + '" добавлен', 'success');
            }
            
            hideAddBlogger();
        }

        function deleteBlogger(index) {
            if (index < 0 || index >= bloggers.length) {
                showError('Ошибка: неверный индекс блогера');
                return;
            }
            
            const blogger = bloggers[index];
            const campaignCount = campaigns.filter(function(c) { return c.blogger === blogger.name; }).length;
            const totalCampaigns = campaigns.length;
            
            const confirmMessage = `
                <div style="text-align: left; font-size: 14px;">
                    <p><strong>Удалить блогера:</strong> ${escapeHtml(blogger.name)}</p>
                    ${blogger.link ? `<p><strong>Ссылка:</strong> ${escapeHtml(blogger.link)}</p>` : ''}
                    <p><strong>Влияние:</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>🗑️ Блогер будет удален из справочника</li>
                        ${campaignCount > 0 ? `<li>📊 ${campaignCount} кампаний (${(campaignCount/totalCampaigns*100).toFixed(1)}% от всех) будут удалены</li>` : '<li>📊 Кампании отсутствуют</li>'}
                        <li>💾 localStorage обновится</li>
                    </ul>
                    <p style="color: var(--danger); font-weight: bold;">Это действие нельзя отменить!</p>
                </div>
            `;
            
            if (confirm(confirmMessage)) {
                const deletedName = blogger.name;
                
                // Удаляем блогера
                bloggers.splice(index, 1);
                
                // Удаляем связанные кампании
                const beforeCount = campaigns.length;
                campaigns = campaigns.filter(function(c) { return c.blogger !== deletedName; });
                const deletedCount = beforeCount - campaigns.length;
                
                saveStorage();
                renderBloggers();
                populateSelects();
                updateList();
                updateCounters();
                
                showMessage(`Блогер "${deletedName}" удален вместе с ${deletedCount} кампаниями`, 'success');
                
                if (campaigns.length === 0) {
                    switchTab('load');
                    showMessage('Все кампании удалены. Загрузите новые данные.', 'warning');
                }
            }
        }

        function hideAddBlogger() {
            hideModal('addBloggerModal');
            isEditingBlogger = false;
            currentEditIndex = -1;
        }

        // ==================== КНИГИ (аналогично блогерам) ====================
        function showAddBook() {
            isEditingBook = false;
            currentEditIndex = -1;
            document.getElementById('bookModalTitle').textContent = 'Добавить';
            document.getElementById('bookName').value = '';
            document.getElementById('bookCP').value = '';
            document.getElementById('saveBookBtn').innerHTML = '<i class="fas fa-check"></i> Добавить книгу';
            document.getElementById('saveBookBtn').onclick = saveBook;
            showModal('addBookModal');
            document.getElementById('bookName').focus();
        }

        function editBook(index) {
            if (index < 0 || index >= books.length) {
                showError('Ошибка: неверная книга');
                return;
            }
            
            isEditingBook = true;
            currentEditIndex = index;
            const book = books[index];
            
            document.getElementById('bookModalTitle').textContent = 'Редактировать';
            document.getElementById('bookName').value = book.name;
            document.getElementById('bookCP').value = book.cp || '';
            document.getElementById('saveBookBtn').innerHTML = '<i class="fas fa-save"></i> Обновить книгу';
            document.getElementById('saveBookBtn').onclick = function() { saveBook(index); };
            
            showModal('addBookModal');
            document.getElementById('bookName').focus();
            document.getElementById('bookName').select();
        }

        function saveBook(editIndex = null) {
            const nameInput = document.getElementById('bookName');
            const cpInput = document.getElementById('bookCP');
            const saveBtn = document.getElementById('saveBookBtn');
            
            if (!nameInput || !cpInput || !saveBtn) {
                showError('Ошибка формы книги');
                return;
            }
            
            const name = nameInput.value.trim();
            const cp = parseFloat(cpInput.value) || 0;
            
            if (!name || name.length < 2) {
                showError('Название книги должно содержать минимум 2 символа');
                nameInput.focus();
                return;
            }
            
            if (name.length > 150) {
                showError('Название слишком длинное (макс. 150 символов)');
                return;
            }
            
            if (cp < 0) {
                showError('ЧП не может быть отрицательным');
                cpInput.focus();
                return;
            }
            
            // Проверка дубликата
            const existingIndex = books.findIndex(function(bk, i) {
                return i !== (editIndex || currentEditIndex) && bk.name.toLowerCase() === name.toLowerCase();
            });
            
            if (existingIndex !== -1) {
                showError('Книга с таким названием уже существует: ' + books[existingIndex].name);
                nameInput.focus();
                return;
            }
            
            const operation = editIndex !== null ? 'обновлена' : 'добавлена';
            
            if (editIndex !== null || isEditingBook) {
                // Редактирование
                books[currentEditIndex].name = name;
                books[currentEditIndex].cp = cp;
                
                // Обновляем связанные кампании
                const oldName = books[currentEditIndex].name;
                if (name.toLowerCase() !== oldName.toLowerCase()) {
                    campaigns.forEach(function(c) {
                        if (c.book === oldName) {
                            c.book = name;
                            c.cp = cp; // Обновляем ЧП во всех кампаниях
                        }
                    });
                } else if (cp !== books[currentEditIndex].cp) {
                    // ЧП изменилось, обновляем во всех кампаниях
                    campaigns.forEach(function(c) {
                        if (c.book === name) {
                            c.cp = cp;
                        }
                    });
                }
                
                saveStorage();
                renderBooks();
                populateSelects();
                updateList();
                
                showMessage('Книга "' + name + '" обновлена (ЧП: ' + cp.toFixed(2) + ' руб.)', 'success');
                
            } else {
                // Добавление
                books.push({ name: name, cp: cp });
                saveStorage();
                renderBooks();
                populateSelects();
                
                showMessage('Книга "' + name + '" добавлена (ЧП: ' + cp.toFixed(2) + ' руб.)', 'success');
            }
            
            hideAddBook();
        }

        function deleteBook(index) {
            if (index < 0 || index >= books.length) {
                showError('Ошибка: неверный индекс книги');
                return;
            }
            
            const book = books[index];
            const campaignCount = campaigns.filter(function(c) { return c.book === book.name; }).length;
            
            if (confirm('Удалить книгу "' + escapeHtml(book.name) + '"?\n\n' +
                       'ЧП: ' + book.cp.toFixed(2) + ' руб.\n' +
                       'Это также удалит ' + campaignCount + ' продаж этой книги.\n\n' +
                       'Действие нельзя отменить!')) {
                
                const deletedName = book.name;
                books.splice(index, 1);
                
                // Удаляем связанные кампании
                campaigns = campaigns.filter(function(c) { return c.book !== deletedName; });
                
                saveStorage();
                renderBooks();
                populateSelects();
                updateList();
                updateCounters();
                
                showMessage('Книга "' + deletedName + '" и ' + campaignCount + ' продаж удалены', 'success');
            }
        }

        function hideAddBook() {
            hideModal('addBookModal');
            isEditingBook = false;
            currentEditIndex = -1;
        }

        // ==================== КАМПАНИИ ====================
        function addCampaign() {
            const inputs = {
                date: document.getElementById('campaignDate'),
                blogger: document.getElementById('campaignBlogger'),
                book: document.getElementById('campaignBook'),
                cost: document.getElementById('campaignCost'),
                cp: document.getElementById('campaignCP'),
                qty: document.getElementById('campaignQty'),
                btn: document.getElementById('addCampaignBtn')
            };
            
            if (!inputs.btn) {
                showError('Ошибка формы кампании');
                return;
            }
            
            // Валидация
            if (!inputs.date.value) {
                showError('Выберите дату кампании');
                inputs.date.focus();
                return;
            }
            
            if (!inputs.blogger.value) {
                showError('Выберите блогера');
                inputs.blogger.focus();
                return;
            }
            
            if (!inputs.book.value) {
                showError('Выберите книгу');
                inputs.book.focus();
                return;
            }
            
            const cost = parseFloat(inputs.cost.value);
            const cp = parseFloat(inputs.cp.value);
            const qty = parseInt(inputs.qty.value);
            
            if (isNaN(cost) || cost <= 0) {
                showError('Стоимость должна быть больше 0');
                inputs.cost.focus();
                return;
            }
            
            if (isNaN(cp) || cp <= 0) {
                showError('ЧП с книги должно быть больше 0');
                inputs.cp.focus();
                return;
            }
            
            if (isNaN(qty) || qty <= 0) {
                showError('Количество должно быть больше 0');
                inputs.qty.focus();
                return;
            }
            
            // Проверяем, что книга существует в справочнике
            const bookExists = books.find(function(bk) { return bk.name === inputs.book.value; });
            if (!bookExists) {
                if (!confirm('Книга "' + inputs.book.value + '" отсутствует в справочнике.\n\n' +
                           'Добавить её автоматически с ЧП = ' + cp.toFixed(2) + ' руб.?')) {
                    inputs.book.focus();
                    return;
                }
                // Добавляем книгу
                books.push({ name: inputs.book.value, cp: cp });
                saveStorage();
                populateSelects();
                renderBooks();
            } else if (Math.abs(bookExists.cp - cp) > 0.01) {
                // ЧП не совпадает
                if (confirm('В справочнике для книги "' + inputs.book.value + '" указано ЧП = ' + bookExists.cp.toFixed(2) + ' руб.,\n' +
                           'а здесь ' + cp.toFixed(2) + ' руб. Обновить ЧП в справочнике?')) {
                    bookExists.cp = cp;
                    saveStorage();
                    renderBooks();
                    updateList(); // Пересчитываем все кампании
                }
            }
            
            const newCampaign = {
                date: inputs.date.value,
                blogger: inputs.blogger.value,
                book: inputs.book.value,
                cost: cost,
                cp: cp,
                qty: qty,
                addedAt: new Date().toISOString()
            };
            
            campaigns.push(newCampaign);
            saveStorage();
            
            // Обновляем интерфейс
            updateList();
            updateCounters();
            clearCampaignForm();
            switchTab('data');
            
            showMessage(
                '✅ Новая кампания добавлена:<br>' +
                '<strong>' + newCampaign.blogger + '</strong> → <strong>' + newCampaign.book + '</strong><br>' +
                '<small>' + newCampaign.date + ' | ' + newCampaign.cost.toFixed(2) + ' руб. | ' + newCampaign.qty + ' шт.</small>',
                'success'
            );
            
            // Прокручиваем к новой кампании
            setTimeout(function() {
                const table = document.querySelector('#dataList table');
                if (table) {
                    const newRow = table.querySelector('tbody tr:last-child');
                    if (newRow) {
                        newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        newRow.style.backgroundColor = 'var(--primary)';
                        newRow.style.color = 'white';
                        setTimeout(function() {
                            newRow.style.backgroundColor = '';
                            newRow.style.color = '';
                        }, 3000);
                    }
                }
            }, 500);
        }

        function clearCampaignForm() {
            document.getElementById('campaignDate').value = new Date().toISOString().split('T')[0]; // Сегодня
            document.getElementById('campaignBlogger').value = '';
            document.getElementById('campaignBook').value = '';
            document.getElementById('campaignCost').value = '';
            document.getElementById('campaignCP').value = '';
            document.getElementById('campaignQty').value = '';
        }

        function editCampaign(index) {
            if (index < 0 || index >= campaigns.length) {
                showError('Ошибка: неверная кампания');
                return;
            }
            
            const campaign = campaigns[index];
            currentEditIndex = index;
            
            // Заполняем форму
            document.getElementById('editDate').value = campaign.date;
            document.getElementById('editBlogger').value = campaign.blogger;
            document.getElementById('editBook').value = campaign.book;
            document.getElementById('editCost').value = campaign.cost;
            document.getElementById('editCP').value = campaign.cp;
            document.getElementById('editQty').value = campaign.qty;
            
            // Предпросмотр метрик
            const profit = campaign.cp * campaign.qty;
            const roi = campaign.cost > 0 ? ((profit - campaign.cost) / campaign.cost * 100).toFixed(1) : 0;
            const roas = campaign.cost > 0 ? (profit / campaign.cost).toFixed(2) : 0;
            
            const preview = document.createElement('div');
            preview.style.cssText = 'background: var(--light); padding: 15px; border-radius: 6px; margin-bottom: 15px; font-size: 14px;';
            preview.innerHTML = `
                <h4 style="margin: 0 0 10px 0; color: var(--secondary);">Предпросмотр</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div><strong>Прибыль:</strong> <span class="positive">${profit.toFixed(2)} руб.</span></div>
                    <div><strong>ROI:</strong> <span class="${roi > 100 ? 'positive' : roi > 0 ? 'neutral' : 'negative'}">${roi > 0 ? '+' : ''}${roi}%</span></div>
                    <div><strong>ROAS:</strong> <span class="positive">${roas}x</span></div>
                </div>
            `;
            
            // Добавляем предпросмотр в модалку
            const modalContent = document.querySelector('#editCampaignModal .form-container');
            let previewDiv = modalContent.querySelector('.campaign-preview');
            if (previewDiv) {
                previewDiv.remove();
            }
            preview.className = 'campaign-preview';
            modalContent.insertBefore(preview, modalContent.firstChild.nextSibling);
            
            document.getElementById('saveCampaignBtn').onclick = saveCampaignEdit;
            
            showModal('editCampaignModal');
            document.getElementById('editDate').focus();
        }

        function saveCampaignEdit() {
            const index = currentEditIndex;
            if (index < 0) return;
            
            const inputs = {
                date: document.getElementById('editDate'),
                blogger: document.getElementById('editBlogger'),
                book: document.getElementById('editBook'),
                cost: document.getElementById('editCost'),
                cp: document.getElementById('editCP'),
                qty: document.getElementById('editQty')
            };
            
            // Валидация (аналогично addCampaign)
            if (!inputs.date.value || !inputs.blogger.value || !inputs.book.value) {
                showError('Заполните все обязательные поля');
                return;
            }
            
            const cost = parseFloat(inputs.cost.value);
            const cp = parseFloat(inputs.cp.value);
            const qty = parseInt(inputs.qty.value);
            
            if (isNaN(cost) || cost <= 0 || isNaN(cp) || cp <= 0 || isNaN(qty) || qty <= 0) {
                showError('Все числовые поля должны быть больше 0');
                return;
            }
            
            // Обновляем кампанию
            const oldCampaign = campaigns[index];
            campaigns[index] = {
                date: inputs.date.value,
                blogger: inputs.blogger.value,
                book: inputs.book.value,
                cost: cost,
                cp: cp,
                qty: qty,
                editedAt: new Date().toISOString()
            };
            
            // Обновляем ЧП книги если изменилось
            const book = books.find(function(b) { return b.name === inputs.book.value; });
            if (book && Math.abs(book.cp - cp) > 0.01) {
                if (confirm('ЧП книги "' + inputs.book.value + '" в справочнике (' + book.cp.toFixed(2) + ' руб.) не совпадает с введенным (' + cp.toFixed(2) + ' руб.).\n\nОбновить ЧП в справочнике?')) {
                    book.cp = cp;
                    // Обновляем ЧП во всех кампаниях этой книги
                    campaigns.forEach(function(c) {
                        if (c.book === inputs.book.value && c !== campaigns[index]) {
                            c.cp = cp;
                        }
                    });
                    saveStorage();
                    renderBooks();
                }
            }
            
            saveStorage();
            updateList();
            updateCounters();
            hideEditCampaign();
            
            const profit = cp * qty;
            const roi = cost > 0 ? ((profit - cost) / cost * 100).toFixed(1) : 0;
            showMessage(
                '✅ Кампания обновлена:<br>' +
                '<strong>' + inputs.blogger.value + '</strong> → <strong>' + inputs.book.value + '</strong><br>' +
                '<small>' + inputs.date.value + ' | ' + cost.toFixed(2) + ' руб. | ROI: ' + (roi > 0 ? '+' : '') + roi + '%</small>',
                'success'
            );
        }

        function hideEditCampaign() {
            hideModal('editCampaignModal');
            currentEditIndex = -1;
            // Удаляем предпросмотр
            const previewDiv = document.querySelector('#editCampaignModal .campaign-preview');
            if (previewDiv) {
                previewDiv.remove();
            }
        }

        function deleteCampaign(index) {
            if (index < 0 || index >= campaigns.length) return;
            
            const campaign = campaigns[index];
            const totalCampaigns = campaigns.length;
            const percentage = ((1 / totalCampaigns) * 100).toFixed(1);
            
            if (confirm('Удалить кампанию?\n\n' +
                       '📅 Дата: ' + campaign.date + '\n' +
                       '👤 Блогер: ' + campaign.blogger + '\n' +
                       '📚 Книга: ' + campaign.book + '\n' +
                       '💰 Затраты: ' + campaign.cost.toFixed(2) + ' руб.\n' +
                       '📦 Количество: ' + campaign.qty + ' шт.\n\n' +
                       `<small>Это ${percentage}% от всех кампаний (${totalCampaigns} всего)</small>`)) {
                
                const deletedCampaign = campaigns.splice(index, 1)[0];
                saveStorage();
                updateList();
                updateCounters();
                
                showMessage(
                    '🗑️ Кампания удалена:<br>' +
                    '<strong>' + deletedCampaign.blogger + '</strong> → <strong>' + deletedCampaign.book + '</strong><br>' +
                    '<small>' + deletedCampaign.date + ' | ' + deletedCampaign.cost.toFixed(2) + ' руб.</small>',
                    'success'
                );
                
                if (campaigns.length === 0) {
                    switchTab('load');
                    showMessage('Все кампании удалены. Загрузите новые данные.', 'warning');
                }
            }
        }

        // ==================== ФИЛЬТРЫ ====================
        function applyFilters() {
            if (campaigns.length === 0) {
                showError('Нет данных для фильтрации. Загрузите кампании.');
                return;
            }
            
            console.log('🔍 Применение фильтров...');
            
            let filtered = campaigns.slice();
            let filterCount = 0;
            
            // Дата
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            
            if (dateFrom) {
                filtered = filtered.filter(function(c) {
                    return new Date(c.date) >= new Date(dateFrom);
                });
                filterCount++;
            }
            
            if (dateTo) {
                filtered = filtered.filter(function(c) {
                    return new Date(c.date) <= new Date(dateTo);
                });
                filterCount++;
            }
            
            // Блогер и книга
            const selectedBlogger = document.getElementById('filterBlogger').value;
            const selectedBook = document.getElementById('filterBook').value;
            
            if (selectedBlogger) {
                filtered = filtered.filter(function(c) { return c.blogger === selectedBlogger; });
                filterCount++;
            }
            
            if (selectedBook) {
                filtered = filtered.filter(function(c) { return c.book === selectedBook; });
                filterCount++;
            }
            
            // Метрики
            const roiMin = parseFloat(document.getElementById('filterROIMin').value) || -Infinity;
            const roiMax = parseFloat(document.getElementById('filterROIMax').value) || Infinity;
            const roasMin = parseFloat(document.getElementById('filterROASMin').value) || 0;
            const roasMax = parseFloat(document.getElementById('filterROASMax').value) || Infinity;
            const cpsMin = parseFloat(document.getElementById('filterCPSMin').value) || 0;
            const cpsMax = parseFloat(document.getElementById('filterCPSMax').value) || Infinity;
            
            let metricCount = 0;
            filtered = filtered.filter(function(c) {
                const profit = c.cp * c.qty;
                const roi = c.cost > 0 ? ((profit - c.cost) / c.cost * 100) : 0;
                const roas = c.cost > 0 ? (profit / c.cost) : 0;
                const cps = c.qty > 0 ? (c.cost / c.qty) : Infinity;
                
                let matches = true;
                
                if (!isNaN(roiMin) && roiMin > -Infinity && roi < roiMin) matches = false;
                if (!isNaN(roiMax) && roiMax < Infinity && roi > roiMax) matches = false;
                if (!isNaN(roasMin) && roasMin > 0 && roas < roasMin) matches = false;
                if (!isNaN(roasMax) && roasMax < Infinity && roas > roasMax) matches = false;
                if (!isNaN(cpsMin) && cpsMin > 0 && cps < cpsMin) matches = false;
                if (!isNaN(cpsMax) && cpsMax < Infinity && cps > cpsMax) matches = false;
                
                if (!matches) metricCount++;
                
                return matches;
            });
            
            filterCount += metricCount > 0 ? 1 : 0;
            
            updateList(filtered);
            updateCounters();
            
            const originalCount = campaigns.length;
            const resultCount = filtered.length;
            const percentage = originalCount > 0 ? ((resultCount / originalCount) * 100).toFixed(1) : 0;
            
            if (resultCount === 0) {
                showError(
                    '❌ По выбранным фильтрам данные не найдены<br>' +
                    '<small>' + filterCount + ' фильтр(ов) активно</small>'
                );
            } else if (filterCount > 0) {
                showMessage(
                    '✅ Фильтры применены<br>' +
                    `<strong>${resultCount}</strong> из ${originalCount} записей (${percentage}%)<br>` +
                    `<small>${filterCount} фильтр(ов) активно</small>`,
                    'success'
                );
            } else {
                showMessage(`Показаны все ${resultCount} кампаний`, 'info');
            }
            
            console.log('✅ Фильтрация: найдено', resultCount, 'из', originalCount);
        }

        function clearFilters() {
            // Очищаем поля
            const filterFields = ['filterDateFrom', 'filterDateTo', 'filterBlogger', 'filterBook', 
                                'filterROIMin', 'filterROIMax', 'filterROASMin', 'filterROASMax', 
                                'filterCPSMin', 'filterCPSMax'];
            
            filterFields.forEach(function(id) {
                const element = document.getElementById(id);
                if (element) {
                    if (element.tagName === 'INPUT' && element.type === 'number') {
                        element.value = '';
                    } else if (element.tagName === 'SELECT') {
                        element.value = '';
                    } else {
                        element.value = '';
                    }
                }
            });
            
            updateList();
            showMessage('Фильтры сброшены. Показаны все данные.', 'info');
            console.log('🔄 Фильтры очищены');
        }

        // ==================== АНАЛИЗ ====================
        function analyzeTop() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            const topContainer = document.getElementById('topBloggers');
            
            if (!analyzeBtn || !topContainer) return;
            
            if (campaigns.length === 0) {
                showError('Нет данных для анализа. Загрузите кампании.');
                return;
            }
            
            // Показываем загрузку
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<div class="loading"></div> Анализ...';
            
            console.log('📊 Начало анализа топ-10 блогеров...');
            
            // Группируем по блогерам
            const bloggerStats = {};
            
            campaigns.forEach(function(campaign) {
                const profit = campaign.cp * campaign.qty;
                if (!bloggerStats[campaign.blogger]) {
                    bloggerStats[campaign.blogger] = {
                        totalCost: 0,
                        totalProfit: 0,
                        totalQty: 0,
                        campaignCount: 0,
                        campaigns: []
                    };
                }
                
                bloggerStats[campaign.blogger].totalCost += campaign.cost;
                bloggerStats[campaign.blogger].totalProfit += profit;
                bloggerStats[campaign.blogger].totalQty += campaign.qty;
                bloggerStats[campaign.blogger].campaignCount += 1;
                bloggerStats[campaign.blogger].campaigns.push({
                    date: campaign.date,
                    book: campaign.book,
                    cost: campaign.cost,
                    profit: profit,
                    qty: campaign.qty
                });
            });
            
            // Считаем метрики и сортируем
            const topBloggers = Object.keys(bloggerStats).map(function(bloggerName) {
                const stats = bloggerStats[bloggerName];
                const roas = stats.totalCost > 0 ? stats.totalProfit / stats.totalCost : 0;
                const roi = roas > 0 ? (roas - 1) * 100 : 0;
                const cps = stats.totalQty > 0 ? stats.totalCost / stats.totalQty : 0;
                const avgOrderValue = stats.totalQty > 0 ? stats.totalProfit / stats.totalQty : 0;
                
                return {
                    name: bloggerName,
                    roas: roas,
                    roi: roi,
                    cps: cps,
                    totalProfit: stats.totalProfit,
                    totalCost: stats.totalCost,
                    totalQty: stats.totalQty,
                    campaignCount: stats.campaignCount,
                    avgOrderValue: avgOrderValue,
                    campaigns: stats.campaigns.sort(function(a, b) {
                        return new Date(b.date) - new Date(a.date);
                    })
                };
            }).filter(function(b) { 
                return b.totalCost > 0; // Исключаем нулевые
            }).sort(function(a, b) { 
                return b.roas - a.roas; 
            }).slice(0, 10);
            
            // Строим HTML
            let html = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--primary); margin: 0 0 15px 0; display: flex; align-items: center;">
                        <i class="fas fa-trophy" style="margin-right: 10px; color: gold;"></i>
                        Топ-${topBloggers.length} блогеров по эффективности (ROAS)
                    </h3>
                    <p style="color: var(--dark); font-size: 14px; margin: 0;">
                        Анализ основан на ${campaigns.length} кампаниях. Общий бюджет: ${campaigns.reduce(function(sum, c) { return sum + c.cost; }, 0).toFixed(0)} руб.
                    </p>
                </div>
            `;
            
            if (topBloggers.length === 0) {
                html += `
                    <div class="empty-state">
                        <i class="fas fa-chart-line" style="font-size: 48px; color: var(--warning); margin-bottom: 15px;"></i>
                        <p>Нет данных для анализа</p>
                        <p style="font-size: 14px;">Все кампании имеют нулевые затраты</p>
                    </div>
                `;
            } else {
                topBloggers.forEach(function(blogger, index) {
                    const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `<span style="font-size: 14px;">${index + 1}.</span>`;
                    const roiClass = blogger.roi > 100 ? 'positive' : blogger.roi > 0 ? 'neutral' : 'negative';
                    const roasClass = blogger.roas > 3 ? 'positive' : blogger.roas > 1 ? 'neutral' : 'negative';
                    const rankColor = index < 3 ? 'gold' : index < 6 ? 'silver' : 'bronze';
                    
                    // Лучшие книги этого блогера
                    const topBooks = blogger.campaigns
                        .reduce(function(stats, c) {
                            if (!stats[c.book]) stats[c.book] = { profit: 0, qty: 0, campaigns: 0 };
                            stats[c.book].profit += c.cp * c.qty;
                            stats[c.book].qty += c.qty;
                            stats[c.book].campaigns += 1;
                            return stats;
                        }, {})
                        .map(function(bookStats, bookName) {
                            return {
                                name: bookName,
                                profit: bookStats.profit,
                                qty: bookStats.qty,
                                campaigns: bookStats.campaigns
                            };
                        })
                        .sort(function(a, b) { return b.profit - a.profit; })
                        .slice(0, 2);
                    
                    const topBooksHtml = topBooks.map(function(book) {
                        return `<div style="display: flex; justify-content: space-between; padding: 3px 0; font-size: 13px;">
                            <span>${escapeHtml(book.name)}</span>
                            <span style="color: var(--primary);">${book.profit.toFixed(0)} руб. (${book.qty} шт.)</span>
                        </div>`;
                    }).join('');
                    
                    html += `
                        <div class="blogger-card" style="margin-bottom: 20px; padding: 20px; border: 2px solid ${index < 3 ? '#ffd700' : 'var(--border)'}; border-radius: 10px;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border);">
                                <div style="font-size: 24px; margin-right: 15px; min-width: 30px; text-align: center;">
                                    ${medal}
                                </div>
                                <div style="flex: 1;">
                                    <h4 style="margin: 0; font-size: 18px; color: ${index < 3 ? 'var(--primary)' : 'var(--dark)'}">
                                        ${escapeHtml(blogger.name)}
                                    </h4>
                                    <p style="margin: 5px 0 0 0; font-size: 14px; color: var(--dark);">
                                        ${blogger.campaignCount} кампаний | ${blogger.totalQty} проданных книг
                                    </p>
                                </div>
                                <div style="text-align: right;">
                                    <div class="metrics ${roasClass}" style="font-size: 20px; margin-bottom: 5px;">
                                        <strong>${blogger.roas.toFixed(2)}x</strong> ROAS
                                    </div>
                                    <div class="${roiClass}" style="font-size: 16px;">
                                        <strong>${blogger.roi.toFixed(0)}%</strong> ROI
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                                <div>
                                    <h5 style="margin: 0 0 8px 0; color: var(--secondary); border-bottom: 1px solid var(--border); padding-bottom: 5px;">
                                        <i class="fas fa-coins"></i> Финансы
                                    </h5>
                                    <div style="font-size: 14px;">
                                        <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                                            <span>Затраты:</span>
                                            <span style="font-weight: bold;">${blogger.totalCost.toFixed(0)} руб.</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin: 4px 0; color: var(--primary);">
                                            <span>Прибыль:</span>
                                            <span style="font-weight: bold;">${blogger.totalProfit.toFixed(0)} руб.</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin: 8px 0 4px 0; padding: 8px; background: var(--light); border-radius: 4px; font-size: 13px;">
                                            <span>CPS:</span>
                                            <span>${blogger.cps.toFixed(2)} руб./шт.</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <h5 style="margin: 0 0 8px 0; color: var(--secondary); border-bottom: 1px solid var(--border); padding-bottom: 5px;">
                                        <i class="fas fa-chart-line"></i> Лучшие книги
                                    </h5>
                                    <div style="font-size: 14px;">
                                        ${topBooksHtml || '<div style="font-style: italic; color: var(--warning);">Анализ недоступен</div>'}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="font-size: 13px; color: var(--dark); padding: 10px; background: var(--light); border-radius: 6px;">
                                <strong>Примечание:</strong> ROAS = Прибыль / Затраты. Значение >3 считается отличным.
                            </div>
                        </div>
                    `;
                });
                
                // Добавляем общую статистику
                const overallStats = calculateOverallStats();
                html += `
                    <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, var(--primary), #45a049); color: white; border-radius: 10px;">
                        <h3 style="margin: 0 0 15px 0; display: flex; align-items: center;">
                            <i class="fas fa-chart-pie" style="margin-right: 10px;"></i>
                            Общая сводка по ${campaigns.length} кампаниям
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 16px;">
                            <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px;">
                                <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${overallStats.totalCampaigns}</div>
                                <div>кампаний</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--warning); margin-bottom: 5px;">${overallStats.totalCost.toFixed(0)}</div>
                                <div>общие затраты, руб.</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--primary); margin-bottom: 5px;">${overallStats.totalProfit.toFixed(0)}</div>
                                <div>общая прибыль, руб.</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px;">
                                <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${overallStats.overallROAS.toFixed(2)}x</div>
                                <div>средний ROAS</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px;">
                                <div style="font-size: 24px; font-weight: bold; color: ${overallStats.overallROI > 100 ? 'var(--primary)' : overallStats.overallROI > 0 ? 'var(--warning)' : 'var(--danger)'}; margin-bottom: 5px;">
                                    ${overallStats.overallROI > 0 ? '+' : ''}${overallStats.overallROI.toFixed(0)}%
                                </div>
                                <div>средний ROI</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            topContainer.innerHTML = html;
            
            // Возвращаем кнопку
            setTimeout(function() {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="fas fa-magic"></i> Обновить анализ';
            }, 1000);
            
            console.log('✅ Анализ завершен. Топ блогеров:', topBloggers.length);
            showMessage(`Анализ завершен! Построен топ-${topBloggers.length} блогеров по ROAS`, 'success');
        }

        function calculateOverallStats() {
            if (campaigns.length === 0) return {
                totalCampaigns: 0,
                totalCost: 0,
                totalProfit: 0,
                overallROAS: 0,
                overallROI: 0
            };
            
            const totalCost = campaigns.reduce(function(sum, c) { return sum + c.cost; }, 0);
            const totalProfit = campaigns.reduce(function(sum, c) { return sum + (c.cp * c.qty); }, 0);
            const totalQty = campaigns.reduce(function(sum, c) { return sum + c.qty; }, 0);
            
            const overallROAS = totalCost > 0 ? totalProfit / totalCost : 0;
            const overallROI = totalCost > 0 ? ((totalProfit - totalCost) / totalCost) * 100 : 0;
            
            return {
                totalCampaigns: campaigns.length,
                totalCost: totalCost,
                totalProfit: totalProfit,
                totalQty: totalQty,
                overallROAS: overallROAS,
                overallROI: overallROI
            };
        }

        // ==================== Утилиты интерфейса ====================
        function showMessage(text, type = 'info') {
            const loadMessage = document.getElementById('loadMessage');
            if (!loadMessage) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.style.margin = '15px 0';
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-triangle',
                warning: 'fas fa-exclamation-circle',
                info: 'fas fa-info-circle'
            };
            
            const colors = {
                success: 'var(--primary)',
                error: 'var(--danger)',
                warning: 'var(--warning)',
                info: 'var(--secondary)'
            };
            
            messageDiv.innerHTML = `
                <div class="${type}-message" style="background: ${colors[type]}; color: white; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <i class="${icons[type] || icons.info}" style="font-size: 20px;"></i>
                    <span style="line-height: 1.4;">${text}</span>
                </div>
            `;
            
            loadMessage.innerHTML = '';
            loadMessage.appendChild(messageDiv);
            
            // Автоудаление через 5 секунд
            setTimeout(function() {
                if (messageDiv.parentNode) {
                    messageDiv.style.opacity = '0';
                    setTimeout(function() {
                        if (messageDiv.parentNode) {
                            messageDiv.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }

        function showError(text) {
            showMessage(text, 'error');
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
            // Сбрасываем флаги редактирования
            if (modalId.includes('Blogger')) {
                isEditingBlogger = false;
                currentEditIndex = -1;
            } else if (modalId.includes('Book')) {
                isEditingBook = false;
                currentEditIndex = -1;
            }
        }

        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) {
                console.error('Модальное окно не найдено:', modalId);
                return;
            }
            
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Фокус на первый input
            setTimeout(function() {
                const firstInput = modal.querySelector('input[required], input[type="text"], input[type="number"], select');
                if (firstInput) {
                    firstInput.focus();
                }
            }, 100);
        }

        // ==================== МАССОВЫЕ ОПЕРАЦИИ ====================
        function deleteAllBloggers() {
            if (bloggers.length === 0) {
                showError('Нет блогеров для удаления');
                return;
            }
            
            if (confirm('Удалить ВСЕ блогеров (' + bloggers.length + ')?\n\nЭто также удалит все кампании (' + campaigns.length + ').')) {
                bloggers = [];
                campaigns = []; // Удаляем все кампании
                saveStorage();
                renderBloggers();
                populateSelects();
                updateList();
                updateCounters();
                showMessage(`Удалено ${originalCount} блогеров и всех кампаний`, 'success');
                switchTab('load');
            }
        }

        function deleteAllBooks() {
            if (books.length === 0) {
                showError('Нет книг для удаления');
                return;
            }
            
            if (confirm('Удалить ВСЕ книги (' + books.length + ')?\n\nЭто также удалит все кампании (' + campaigns.length + ').')) {
                books = [];
                campaigns = []; // Удаляем все кампании
                saveStorage();
                renderBooks();
                populateSelects();
                updateList();
                updateCounters();
                showMessage(`Удалено ${originalCount} книг и всех кампаний`, 'success');
                switchTab('load');
            }
        }

                function deleteAllCampaigns() {
            if (campaigns.length === 0) {
                showError('Нет кампаний для удаления');
                return;
            }
            
            const total = campaigns.length;
            const totalCost = campaigns.reduce(function(sum, c) { return sum + c.cost; }, 0).toFixed(0);
            const totalProfit = campaigns.reduce(function(sum, c) { return sum + (c.cp * c.qty); }, 0).toFixed(0);
            
            if (confirm('Удалить ВСЕ кампании (' + total + ')?\n\n' +
                       '💰 Общие затраты: ' + totalCost + ' руб.\n' +
                       '📈 Общая прибыль: ' + totalProfit + ' руб.\n\n' +
                       'Справочники (блогеры, книги) останутся нетронутыми.\n\n' +
                       'Это действие нельзя отменить!')) {
                
                const deletedCount = campaigns.length;
                campaigns = [];
                
                saveStorage();
                updateList();
                updateCounters();
                
                showMessage(
                    `🗑️ Удалено ${deletedCount} кампаний<br>` +
                    `<strong>Затраты: ${totalCost} руб. | Прибыль: ${totalProfit} руб.</strong><br>` +
                    `<small>Справочники сохранены</small>`,
                    'success'
                );
                
                switchTab('load');
                showMessage('Все кампании удалены. Загрузите новые данные.', 'warning');
            }
        }

        // ==================== Toggle секций ====================
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId === 'bloggersList' ? 'bloggersList' : 'booksList');
            if (!section) return;
            
            const isHidden = section.classList.contains('hidden');
            section.classList.toggle('hidden');
            
            const toggleBtn = section.parentElement.querySelector('.toggle-btn');
            if (toggleBtn) {
                const icon = toggleBtn.querySelector('i');
                if (icon) {
                    icon.className = isHidden ? 'fas fa-eye-slash' : 'fas fa-eye';
                }
                const text = isHidden ? 'Скрыть список' : 'Показать список';
                toggleBtn.innerHTML = (isHidden ? '<i class="fas fa-eye-slash"></i> ' : '<i class="fas fa-eye"></i> ') + text;
            }
            
            console.log(sectionId, isHidden ? 'скрыт' : 'показан');
        }

        // ==================== СБРОС ====================
        function showReset() {
            document.getElementById('resetPassword').value = '';
            document.getElementById('confirmResetBtn').disabled = true;
            document.getElementById('confirmResetBtn').style.opacity = '0.5';
            showModal('resetModal');
            document.getElementById('resetPassword').focus();
        }

        function resetAll() {
            const passwordInput = document.getElementById('resetPassword');
            const confirmBtn = document.getElementById('confirmResetBtn');
            
            if (!passwordInput || !confirmBtn) return;
            
            const password = passwordInput.value.trim();
            const confirmEnabled = !confirmBtn.disabled;
            
            if (!confirmEnabled) {
                showError('Введите правильный пароль');
                return;
            }
            
            if (password !== 'admin') {
                showError('Неверный пароль! Подсказка: простое слово из 5 букв для администратора.');
                passwordInput.value = '';
                passwordInput.focus();
                return;
            }
            
            const totalBloggers = bloggers.length;
            const totalBooks = books.length;
            const totalCampaigns = campaigns.length;
            const totalStorage = (localStorage.bloggers?.length || 0) + (localStorage.books?.length || 0) + (localStorage.campaigns?.length || 0);
            
            const confirmText = totalBloggers + totalBooks + totalCampaigns > 0 ? 
                `⚠️  ПОЛНЫЙ СБРОС ДАННЫХ ⚠️

Будет удалено ИРРЕВЕРСИБИЛЬНО:

👥 ${totalBloggers} блогеров
📚 ${totalBooks} книг  
📊 ${totalCampaigns} кампаний
💾 localStorage (${(totalStorage / 1024).toFixed(1)} КБ)

Восстановить данные будет невозможно!

ПРОДОЛЖИТЬ?` : 
                'Данные пусты. Сброс ничего не изменит. Продолжить?';
            
            if (confirm(confirmText)) {
                
                // Записываем в историю для отладки
                console.log('💥 ПОЛНЫЙ СБРОС ИНИЦИИРОВАН');
                console.log('Удалено: блогеров=', totalBloggers, 'книг=', totalBooks, 'кампаний=', totalCampaigns);
                
                // Очищаем все
                localStorage.clear();
                bloggers = [];
                books = [];
                campaigns = [];
                
                // Очищаем интерфейс
                renderBloggers();
                renderBooks();
                updateList();
                populateSelects();
                updateCounters();
                
                // Скрываем модалку
                hideReset();
                
                // Показываем подтверждение
                showMessage(
                    `<div style="text-align: center;">
                        <i class="fas fa-bomb" style="font-size: 48px; color: var(--danger); margin-bottom: 15px; display: block;"></i>
                        <strong style="font-size: 20px; display: block; margin-bottom: 10px;">💥 ДАННЫЕ ПОЛНОСТЬЮ СТЕРТЫ</strong>
                        <div style="font-size: 14px; opacity: 0.9;">
                            🗑️ Удалено ${totalBloggers} блогеров<br>
                            📚 Удалено ${totalBooks} книг<br>
                            📊 Удалено ${totalCampaigns} кампаний<br>
                            💾 localStorage очищен (${(totalStorage / 1024).toFixed(1)} КБ)
                        </div>
                    </div>`,
                    'error'
                );
                
                // Переключаемся на загрузку
                switchTab('load');
                
                // Журнал в консоль
                console.log('✅ Сброс завершен. localStorage очищен.');
            }
        }

        function hideReset() {
            const passwordInput = document.getElementById('resetPassword');
            if (passwordInput) passwordInput.value = '';
            const confirmBtn = document.getElementById('confirmResetBtn');
            if (confirmBtn) {
                confirmBtn.disabled = true;
                confirmBtn.style.opacity = '0.5';
            }
            hideModal('resetModal');
        }

        // ==================== ЭКСПОРТ ====================
        function exportData() {
            if (campaigns.length === 0 && bloggers.length === 0 && books.length === 0) {
                showError('Нет данных для экспорта');
                return;
            }
            
            // Создаем workbook
            const wb = XLSX.utils.book_new();
            
            // Экспорт кампаний
            if (campaigns.length > 0) {
                const campaignsData = campaigns.map(function(c) {
                    const profit = c.cp * c.qty;
                    const roi = c.cost > 0 ? ((profit - c.cost) / c.cost * 100) : 0;
                    const roas = c.cost > 0 ? (profit / c.cost) : 0;
                    const cps = c.qty > 0 ? (c.cost / c.qty) : 0;
                    
                    return {
                        'Дата': c.date,
                        'Блогер': c.blogger,
                        'Книга': c.book,
                        'Стоимость (руб.)': c.cost,
                        'ЧП с книги (руб.)': c.cp,
                        'Количество (шт.)': c.qty,
                        'Прибыль (руб.)': profit,
                        'ROI (%)': roi,
                        'ROAS (x)': roas,
                        'CPS (руб./шт.)': cps,
                        'Добавлено': c.addedAt ? new Date(c.addedAt).toLocaleDateString('ru-RU') : ''
                    };
                });
                
                const ws = XLSX.utils.json_to_sheet(campaignsData);
                XLSX.utils.book_append_sheet(wb, ws, 'Кампании');
                
                // Автоширина колонок
                const colWidths = [
                    {wch: 12}, // Дата
                    {wch: 20}, // Блогер
                    {wch: 25}, // Книга
                    {wch: 15}, // Стоимость
                    {wch: 15}, // ЧП
                    {wch: 15}, // Количество
                    {wch: 15}, // Прибыль
                    {wch: 10}, // ROI
                    {wch: 10}, // ROAS
                    {wch: 15}, // CPS
                    {wch: 12}  // Добавлено
                ];
                ws['!cols'] = colWidths;
            }
            
            // Экспорт блогеров
            if (bloggers.length > 0) {
                const bloggersData = bloggers.map(function(b) {
                    return {
                        'Название': b.name,
                        'Ссылка': b.link || '',
                        'Кампаний': campaigns.filter(function(c) { return c.blogger === b.name; }).length
                    };
                });
                
                const ws = XLSX.utils.json_to_sheet(bloggersData);
                XLSX.utils.book_append_sheet(wb, ws, 'Блогеры');
                ws['!cols'] = [{wch: 30}, {wch: 40}, {wch: 10}];
            }
            
            // Экспорт книг
            if (books.length > 0) {
                const booksData = books.map(function(bk) {
                    const bookCampaigns = campaigns.filter(function(c) { return c.book === bk.name; });
                    const totalSold = bookCampaigns.reduce(function(sum, c) { return sum + c.qty; }, 0);
                    const totalRevenue = bookCampaigns.reduce(function(sum, c) { return sum + (c.cp * c.qty); }, 0);
                    
                    return {
                        'Название': bk.name,
                        'ЧП (руб.)': bk.cp,
                        'Продано (шт.)': totalSold,
                        'Выручка (руб.)': totalRevenue,
                        'Кампаний': bookCampaigns.length
                    };
                });
                
                const ws = XLSX.utils.json_to_sheet(booksData);
                XLSX.utils.book_append_sheet(wb, ws, 'Книги');
                ws['!cols'] = [{wch: 30}, {wch: 12}, {wch: 12}, {wch: 15}, {wch: 10}];
            }
            
            // Имя файла
            const now = new Date();
            const timestamp = now.toISOString().slice(0, 19).replace(/[:.]/g, '-');
            const filename = `Анализатор_блогеров_${timestamp}.xlsx`;
            
            // Сохраняем
            XLSX.writeFile(wb, filename);
            
            showMessage(
                `📥 Данные экспортированы в Excel:<br>` +
                `<strong style="font-size: 16px;">${filename}</strong><br>` +
                `<small>${campaigns.length} кампаний | ${bloggers.length} блогеров | ${books.length} книг</small>`,
                'success'
            );
            
            console.log('📤 Экспорт завершен:', filename);
        }

        // ==================== УТИЛИТЫ ====================
        function isValidURL(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function showBookStats(index) {
            if (index < 0 || index >= books.length) return;
            
            const book = books[index];
            const bookCampaigns = campaigns.filter(function(c) { return c.book === book.name; });
            
            if (bookCampaigns.length === 0) {
                showError('Нет данных для анализа книги "' + book.name + '"');
                return;
            }
            
            let statsHtml = `
                <div style="max-height: 400px; overflow-y: auto;">
                    <h3 style="margin-top: 0; color: var(--secondary);">📊 Анализ книги: ${escapeHtml(book.name)}</h3>
                    <p><strong>ЧП:</strong> ${book.cp.toFixed(2)} руб. | <strong>Кампаний:</strong> ${bookCampaigns.length}</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0;">
            `;
            
            // Топ блогеры для этой книги
            const bloggerStats = {};
            bookCampaigns.forEach(function(c) {
                const profit = c.cp * c.qty;
                if (!bloggerStats[c.blogger]) {
                    bloggerStats[c.blogger] = { profit: 0, qty: 0, campaigns: 0 };
                }
                bloggerStats[c.blogger].profit += profit;
                bloggerStats[c.blogger].qty += c.qty;
                bloggerStats[c.blogger].campaigns += 1;
            });
            
            const topBloggersForBook = Object.keys(bloggerStats)
                .map(function(name) {
                    const stats = bloggerStats[name];
                    return { name: name, profit: stats.profit, qty: stats.qty, campaigns: stats.campaigns };
                })
                .sort(function(a, b) { return b.profit - a.profit; })
                .slice(0, 5);
            
            statsHtml += `
                <div>
                    <h4 style="margin: 0 0 10px 0; color: var(--primary);">👤 Топ блогеры</h4>
            `;
            
            topBloggersForBook.forEach(function(bs) {
                const roi = (bs.profit / bookCampaigns.reduce(function(sum, c) { return sum + c.cost; }, 0) * 100).toFixed(0);
                statsHtml += `
                    <div style="padding: 5px; background: var(--light); border-radius: 4px; margin: 3px 0; font-size: 13px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>${escapeHtml(bs.name)}</span>
                            <span style="color: var(--primary);">${bs.profit.toFixed(0)} руб.</span>
                        </div>
                        <div style="font-size: 11px; color: var(--dark);">
                            ${bs.qty} шт. | ${bs.campaigns} кампаний
                        </div>
                    </div>
                `;
            });
            
            statsHtml += `
                </div>
                <div>
                    <h4 style="margin: 0 0 10px 0; color: var(--secondary);">📈 Общая эффективность</h4>
            `;
            
            const totalCost = bookCampaigns.reduce(function(sum, c) { return sum + c.cost; }, 0);
            const totalProfit = bookCampaigns.reduce(function(sum, c) { return sum + (c.cp * c.qty); }, 0);
            const totalQty = bookCampaigns.reduce(function(sum, c) { return sum + c.qty; }, 0);
            const totalROAS = totalCost > 0 ? totalProfit / totalCost : 0;
            const totalROI = totalCost > 0 ? ((totalProfit - totalCost) / totalCost * 100) : 0;
            const avgCPS = totalQty > 0 ? totalCost / totalQty : 0;
            
            statsHtml += `
                    <div style="padding: 10px; background: var(--light); border-radius: 6px; font-size: 14px;">
                        <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                            <span><strong>Общие затраты:</strong></span>
                            <span>${totalCost.toFixed(0)} руб.</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 5px 0; color: var(--primary);">
                            <span><strong>Общая прибыль:</strong></span>
                            <span>${totalProfit.toFixed(0)} руб.</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                            <span><strong>Продано:</strong></span>
                            <span>${totalQty} шт.</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 8px 0; padding: 8px; background: white; border-radius: 4px; font-weight: bold;">
                            <span>ROI: ${totalROI > 0 ? '+' : ''}${totalROI.toFixed(1)}%</span>
                            <span style="color: var(--primary);">ROAS: ${totalROAS.toFixed(2)}x</span>
                        </div>
                        <div style="font-size: 12px; color: var(--dark);">
                            CPS: ${avgCPS.toFixed(2)} руб./шт. | Эффективно, если < ЧП (${book.cp.toFixed(2)} руб.)
                        </div>
                    </div>
                </div>
            `;
            
            statsHtml += `
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: var(--light); border-radius: 6px; font-size: 13px;">
                    <h4 style="margin: 0 0 10px 0; color: var(--warning);">📝 Рекомендации</h4>
                    <ul style="margin: 0; padding-left: 20px;">
                        ${totalROI > 100 ? 
                            '<li style="color: var(--primary);">✅ <strong>Отличная эффективность!</strong> ROI ' + totalROI.toFixed(1) + '%</li>' : 
                            totalROI > 0 ? 
                                '<li style="color: var(--warning);">⚠️  Хороший результат. ROI ' + totalROI.toFixed(1) + '% — можно улучшить</li>' : 
                                '<li style="color: var(--danger);">❌ <strong>Убыточно!</strong> ROI ' + totalROI.toFixed(1) + '% — пересмотрите стратегию</li>'
                        }
                        <li>💡 CPS (' + avgCPS.toFixed(2) + ' руб.) ${avgCPS < book.cp ? 'ниже' : 'выше'} ЧП (' + book.cp.toFixed(2) + ' руб.)</li>
                        <li>🎯 Топ-продажи через: ${topBloggersForBook[0] ? topBloggersForBook[0].name : 'нет данных'}</li>
                    </ul>
                </div>
                </div>
            `;
            
            // Показываем в модальном окне (или можно создать отдельную модалку)
            const modal = document.createElement('div');
            modal.className = 'form-popup';
            modal.style.cssText = 'display: block; z-index: 1001;';
            modal.innerHTML = `
                <div class="form-container" style="max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border);">
                        <h3 style="margin: 0;">📊 Статистика книги</h3>
                        <button onclick="this.parentElement.parentElement.parentElement.remove(); document.body.style.overflow = 'auto';" 
                                style="background: var(--danger); color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer; font-size: 18px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    ${statsHtml}
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
        }

        // ==================== ИНИЦИАЛИЗАЦИЯ ====================
        // Точка входа
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('📄 DOM загружен, инициализация через 200мс...');
                setTimeout(function() {
                    if (!initApp()) {
                        showError('Не удалось инициализировать приложение. Обновите страницу.');
                    }
                }, 200);
            });
        } else {
            // DOM уже готов
            setTimeout(initApp, 100);
        }

        // Обработчик ошибок
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('💥 Глобальная ошибка:', message);
            console.error('📍 Файл:', source, 'Строка:', lineno, 'Столбец:', colno);
            if (error && error.stack) {
                console.error('📚 Стек вызовов:', error.stack);
            }
            showError('Произошла ошибка: ' + message + '\n\nСтрока: ' + lineno + '\nОбновите страницу для продолжения.');
            return false;
        };

        console.log('🚀 Скрипт Анализатора блогеров v7.3 загружен');
        console.log('📦 Функционал:');
        console.log('   ✅ Google Sheets CSV');
        console.log('   ✅ Excel (.xlsx/.xls) с SheetJS');
        console.log('   ✅ Справочники (блогеры/книги)');
        console.log('   ✅ Фильтры и метрики (ROI/ROAS/CPS)');
        console.log('   ✅ Анализ топ-10');
        console.log('   ✅ Экспорт в Excel');
        console.log('   ✅ localStorage с автосохранением');
        console.log('🔐 Пароль сброса: admin');

    </script>
</body>
</html>
